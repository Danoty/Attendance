<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JOOUST Smart Attendance Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ================= JOOUST OFFICIAL BRANDING ================= -->
  <style>
    :root{
      --jooust-blue:#003b8c;
      --jooust-blue-light:#0052cc;
      --jooust-green:#24a148;
      --jooust-gold:#f2c94c;
      --bg-soft:#f4f7fb;
      --card:#ffffff;
      --text:#1f2933;
      --muted:#6b7280;
      --danger:#e11d48;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,sans-serif}
    body{margin:0;background:var(--bg-soft);color:var(--text)}

    header{
      background:linear-gradient(135deg,var(--jooust-blue),var(--jooust-blue-light));
      color:#fff;padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;
      box-shadow:0 6px 20px rgba(0,0,0,.25);position:sticky;top:0;z-index:50
    }
    header .brand{display:flex;gap:1rem;align-items:center}
    header img{height:56px;background:#fff;border-radius:6px;padding:4px}
    header h1{margin:0;font-size:1.35rem}
    header small{opacity:.9}

    main{max-width:1250px;margin:1.5rem auto;padding:0 1rem}
    .card{background:var(--card);border-radius:16px;padding:1.6rem;margin-bottom:1.2rem;box-shadow:0 12px 30px rgba(15,23,42,.08)}
    h2,h3{margin-top:0;color:var(--jooust-blue)}

    label{font-size:.85rem;color:var(--muted)}
    input,select{width:100%;padding:.6rem;border-radius:8px;border:1px solid #d1d5db}
    input:focus,select:focus{outline:none;border-color:var(--jooust-blue)}

    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:1rem}

    .btn{border:none;border-radius:999px;padding:.65rem 1.4rem;font-weight:600;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,var(--jooust-blue),var(--jooust-blue-light));color:#fff}
    .btn-success{background:linear-gradient(135deg,var(--jooust-green),#15803d);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-secondary{background:#e5e7eb}

    table{width:100%;border-collapse:collapse;font-size:.85rem}
    th,td{border:1px solid #e5e7eb;padding:.55rem}
    th{background:#eff6ff;color:#1d4ed8}

    .hidden{display:none}

    .signature-pad{border:2px dashed var(--jooust-blue-light);border-radius:12px;height:130px;width:100%;background:#fff}

    footer{
      text-align:center;padding:1.6rem;color:#fff;margin-top:2rem;
      background:linear-gradient(135deg,var(--jooust-blue),var(--jooust-blue-light));
    }
    footer strong{color:var(--jooust-gold)}
  </style>

  <!-- ================= LIBRARIES ================= -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
</head>
<body>

<header>
  <div class="brand">
    <img src="logo.jpg" alt="JOOUST Logo">
    <div>
      <h1>JOOUST Smart Attendance System</h1>
      <small>Secure • Geo‑Fenced • Digital Signatures • Smart Reports</small>
    </div>
  </div>
  <div id="userBar"></div>
</header>

<main>

<!-- ================= LOGIN ================= -->
<section id="loginSection" class="card">
  <h2>System Login</h2>
  <div class="row">
    <div>
      <label>Login Role</label>
      <select id="loginRole">
        <option value="admin">Admin</option>
        <option value="lecturer">Lecturer</option>
      </select>
    </div>
    <div>
      <label>Username</label>
      <input id="loginUser" placeholder="Enter username">
    </div>
    <div>
      <label>Password</label>
      <input id="loginPass" type="password" placeholder="Enter password">
    </div>
  </div>
  <button class="btn btn-primary" onclick="login()">Login</button>
  <button class="btn btn-secondary" onclick="showRegister()">Register Lecturer</button>
  <p id="loginMsg"></p>
</section>

<!-- ================= REGISTRATION ================= -->
<section id="registerSection" class="card hidden">
  <h2>Lecturer Registration</h2>
  <div class="row">
    <div><label>Full Name</label><input id="regName"></div>
    <div><label>PF / ID</label><input id="regPF"></div>
    <div><label>Username</label><input id="regUser"></div>
    <div><label>Password</label><input id="regPass" type="password"></div>
  </div>
  <button class="btn btn-success" onclick="registerLecturer()">Submit Registration</button>
  <button class="btn btn-secondary" onclick="backLogin()">Back to Login</button>
  <p id="regMsg"></p>
</section>

<!-- ================= LECTURER DASHBOARD ================= -->
<section id="lecturerDash" class="hidden">

  <div class="card">
    <h2>Lecturer Dashboard</h2>
    <button class="btn btn-danger" onclick="logout()">Logout</button>
  </div>

  <div class="card">
    <h3>Create Class Session</h3>
    <div class="row">
      <div><label>Faculty</label><input id="lcFaculty"></div>
      <div><label>Course</label><input id="lcCourse"></div>
      <div><label>Unit</label><input id="lcUnit"></div>
      <div><label>Year</label><input id="lcYear"></div>
      <div><label>Semester</label><input id="lcSem"></div>
      <div><label>Venue</label><input id="lcVenue"></div>
      <div><label>Date & Time</label><input id="lcDT" type="datetime-local"></div>
    </div>
    <button class="btn btn-success" onclick="createClass()">Create Class</button>
    <p id="classMsg"></p>
  </div>

  <div class="card">
    <h3>My Classes & Attendance</h3>
    <label>Select Class</label>
    <select id="classSelect" onchange="renderAttendance()"></select>
    <div id="attendanceTable" style="margin-top:1rem"></div>

    <div style="margin-top:1rem;display:flex;gap:.5rem;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="exportExcel()">Download Excel</button>
      <button class="btn btn-secondary" onclick="exportPdf()">Download PDF</button>
      <button class="btn btn-secondary" onclick="exportWord()">Download Word</button>
    </div>
  </div>
</section>

<!-- ================= STUDENT VIEW ================= -->
<section id="studentSection" class="card hidden">
  <h2>Student Attendance Submission</h2>
  <p id="classInfo"></p>
  <div class="row">
    <div><label>Surname</label><input id="stSurname"></div>
    <div><label>First Name</label><input id="stFirst"></div>
    <div><label>Admission No</label><input id="stAdm"></div>
  </div>
  <label>Digital Signature (finger or mouse)</label>
  <canvas id="stSig" class="signature-pad"></canvas>
  <button class="btn btn-success" onclick="submitAttendance()">Submit Attendance</button>
  <p id="stMsg"></p>
</section>

</main>

<footer>
  <p>© JOOUST Smart Attendance System<br>
  Created by <strong>Gerotech</strong> under <strong>Dan Otieno</strong></p>
</footer>

<script>
/* ================= DATA STORE ================= */
const KEY='jooust_smart_final_v2';
let DB=JSON.parse(localStorage.getItem(KEY))||{
  admins:[{u:'admin',p:'admin123'}],
  lecturers:[],classes:[],attendance:[]
};
function save(){localStorage.setItem(KEY,JSON.stringify(DB))}
let current=null;

/* ================= AUTH ================= */
function login(){
  const r=loginRole.value,u=loginUser.value,p=loginPass.value;
  loginMsg.textContent='';
  if(r==='admin'){
    const a=DB.admins.find(x=>x.u===u&&x.p===p);
    if(!a){loginMsg.textContent='Invalid admin credentials';return}
    alert('Admin logged in (Admin dashboard can be expanded)');
  }else{
    const l=DB.lecturers.find(x=>x.u===u&&x.p===p);
    if(!l){loginMsg.textContent='Invalid lecturer credentials';return}
    current={id:l.id,name:l.name};
    loginSection.classList.add('hidden');
    lecturerDash.classList.remove('hidden');
    loadClasses();
  }
}
function logout(){current=null;location.reload()}
function showRegister(){loginSection.classList.add('hidden');registerSection.classList.remove('hidden')}
function backLogin(){registerSection.classList.add('hidden');loginSection.classList.remove('hidden')}
function registerLecturer(){
  DB.lecturers.push({id:Date.now(),name:regName.value,pf:regPF.value,u:regUser.value,p:regPass.value});
  save();regMsg.textContent='Registration submitted. Await approval.'
}

/* ================= CLASSES ================= */
function createClass(){
  DB.classes.push({
    id:Date.now(),lecturer:current.id,
    faculty:lcFaculty.value,course:lcCourse.value,unit:lcUnit.value,
    year:lcYear.value,sem:lcSem.value,venue:lcVenue.value,dt:lcDT.value
  });
  save();classMsg.textContent='Class created successfully';loadClasses();
}
function loadClasses(){
  classSelect.innerHTML='';
  DB.classes.filter(c=>c.lecturer===current.id).forEach(c=>{
    const o=document.createElement('option');
    o.value=c.id;o.textContent=`${c.unit} | ${c.dt}`;classSelect.appendChild(o)
  });
  if(classSelect.value)renderAttendance();
}

/* ================= ATTENDANCE ================= */
const canvas=document.getElementById('stSig');const ctx=canvas.getContext('2d');ctx.lineWidth=2;ctx.lineCap='round';
let draw=false;
canvas.onmousedown=e=>{draw=true;ctx.beginPath();ctx.moveTo(e.offsetX,e.offsetY)};
canvas.onmousemove=e=>{if(draw){ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke()}};
window.onmouseup=()=>draw=false;
canvas.ontouchstart=e=>{e.preventDefault();draw=true;const t=e.touches[0];const r=canvas.getBoundingClientRect();ctx.beginPath();ctx.moveTo(t.clientX-r.left,t.clientY-r.top)};
canvas.ontouchmove=e=>{e.preventDefault();if(draw){const t=e.touches[0];const r=canvas.getBoundingClientRect();ctx.lineTo(t.clientX-r.left,t.clientY-r.top);ctx.stroke()}};
canvas.ontouchend=()=>draw=false;

function submitAttendance(){
  navigator.geolocation.getCurrentPosition(pos=>{
    const d=distance(pos.coords.latitude,pos.coords.longitude,-0.0917,34.7680);
    if(d>1){stMsg.textContent='You must be within JOOUST (1km radius)';return}
    DB.attendance.push({
      classId:getClassId(),surname:stSurname.value,first:stFirst.value,
      adm:stAdm.value,sig:canvas.toDataURL(),time:new Date().toLocaleString()
    });
    save();stMsg.textContent='Attendance submitted successfully';
  },()=>stMsg.textContent='Location permission required');
}
function distance(lat1,lon1,lat2,lon2){
  const R=6371;const dLat=(lat2-lat1)*Math.PI/180;const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* ================= REPORTING ================= */
function renderAttendance(){
  const id=classSelect.value;
  const rows=DB.attendance.filter(a=>a.classId==id);
  let html='<table><tr><th>#</th><th>Admission</th><th>Name</th><th>Time</th></tr>';
  rows.forEach((r,i)=>html+=`<tr><td>${i+1}</td><td>${r.adm}</td><td>${r.surname} ${r.first}</td><td>${r.time}</td></tr>`);
  html+='</table>';attendanceTable.innerHTML=html;
}

function exportExcel(){
  const rows=DB.attendance.filter(a=>a.classId==classSelect.value);
  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Attendance');
  XLSX.writeFile(wb,'JOOUST_Attendance.xlsx');
}
function exportPdf(){
  const {jsPDF}=window.jspdf;const doc=new jsPDF('l');
  doc.text('JOOUST Attendance Report',14,20);
  const rows=DB.attendance.filter(a=>a.classId==classSelect.value)
    .map((r,i)=>[i+1,r.adm,`${r.surname} ${r.first}`,r.time]);
  doc.autoTable({startY:30,head:[[ '#','Admission','Name','Time' ]],body:rows});
  doc.save('JOOUST_Attendance.pdf');
}
function exportWord(){
  const rows=DB.attendance.filter(a=>a.classId==classSelect.value);
  let html='<h2>JOOUST Attendance Report</h2><table border="1" cellspacing="0" cellpadding="4">';
  html+='<tr><th>#</th><th>Admission</th><th>Name</th><th>Time</th></tr>';
  rows.forEach((r,i)=>html+=`<tr><td>${i+1}</td><td>${r.adm}</td><td>${r.surname} ${r.first}</td><td>${r.time}</td></tr>`);
  html+='</table>';
  const blob=new Blob(['\ufeff',html],{type:'application/msword'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='JOOUST_Attendance.doc';a.click();
}
</script>
</body>
</html>
