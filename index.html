<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JOOUST Attendance Management System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- JOOUST COLORS -->
<style>
:root{
  --blue:#003b8c;
  --blue2:#0052cc;
  --green:#24a148;
  --gold:#f2c94c;
  --bg:#f4f7fb;
}
*{box-sizing:border-box;font-family:Segoe UI,system-ui}
body{margin:0;background:var(--bg)}
header{
  background:linear-gradient(135deg,var(--blue),var(--blue2));
  color:#fff;padding:12px 20px;
  display:flex;justify-content:space-between;align-items:center
}
header img{height:45px;background:#fff;padding:4px;border-radius:6px}
main{max-width:1200px;margin:auto;padding:15px}
.card{background:#fff;border-radius:12px;padding:15px;margin-bottom:15px;
box-shadow:0 6px 18px rgba(0,0,0,.08)}
input,select,button{
width:100%;padding:8px;border-radius:8px;
border:1px solid #ccc;margin-bottom:10px}
button{
background:var(--blue2);color:#fff;border:none;
font-weight:600;cursor:pointer
}
button.secondary{background:#e5e7eb;color:#111}
button.success{background:var(--green)}
button.danger{background:#e11d48}
.hidden{display:none}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ddd;padding:6px}
th{background:#eff6ff;color:#003b8c}
.signature-pad{border:2px dashed var(--blue2);height:130px}
footer{text-align:center;font-size:12px;color:#555;margin:20px}
</style>

<!-- LIBRARIES -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
</head>

<body>

<header>
  <div style="display:flex;gap:10px;align-items:center">
    <img src="logo.jpg">
    <strong>JOOUST Attendance System</strong>
  </div>
  <div id="topUser"></div>
</header>

<main>

<!-- LOGIN -->
<div class="card" id="loginBox">
<h3>Login</h3>
<select id="loginRole">
<option value="admin">Admin</option>
<option value="lecturer">Lecturer</option>
</select>
<input id="loginUser" placeholder="Username">
<input id="loginPass" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<p id="loginMsg"></p>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">

<div class="card">
<button class="secondary" onclick="logout()">Logout</button>
<button class="secondary" onclick="showChange()">Change Password</button>
</div>

<!-- CREATE CLASS -->
<div class="card">
<h3>Create Class</h3>
<input id="clsFaculty" placeholder="Faculty">
<input id="clsCourse" placeholder="Course">
<input id="clsUnit" placeholder="Unit">
<input id="clsVenue" placeholder="Venue">
<input type="datetime-local" id="clsDate">
<button class="success" onclick="createClass()">Create Class</button>
<p id="clsMsg"></p>
</div>

<!-- CLASSES -->
<div class="card">
<h3>My Classes</h3>
<div id="classList"></div>
</div>

</div>

<!-- STUDENT -->
<div class="card hidden" id="studentBox">
<h3>Student Attendance</h3>
<input id="stAdm" placeholder="Admission No">
<input id="stName" placeholder="Full Name">
<canvas id="stSig" class="signature-pad"></canvas>
<button onclick="clearSig()">Clear</button>
<button class="success" onclick="submitAttendance()">Submit</button>
<p id="stMsg"></p>
</div>

</main>

<footer>
System developed by <strong>Gerotech</strong> | By <strong>Dan Otieno</strong>
</footer>

<script>
const KEY="jooust_sys";
let DB=JSON.parse(localStorage.getItem(KEY))||{
admins:[{u:"admin",p:"admin123"}],
lecturers:[],classes:[],attendance:[]
};
let user=null;
function save(){localStorage.setItem(KEY,JSON.stringify(DB));}

function login(){
const u=loginUser.value,p=loginPass.value,r=loginRole.value;
if(r==="admin"){
if(DB.admins.find(a=>a.u===u&&a.p===p)){user={r,u};openDash();}
else loginMsg.textContent="Invalid login";
}else{
const l=DB.lecturers.find(x=>x.u===u&&x.p===p&&x.ok);
if(l){user={r,id:l.id,u:l.u};openDash();}
else loginMsg.textContent="Not approved / wrong details";
}
}

function openDash(){
loginBox.classList.add("hidden");
dashboard.classList.remove("hidden");
topUser.textContent="Logged in as "+user.u;
renderClasses();
}

function logout(){
user=null;location.reload();
}

function createClass(){
const c={id:Date.now(),fac:clsFaculty.value,course:clsCourse.value,
unit:clsUnit.value,venue:clsVenue.value,dt:clsDate.value,lec:user.u};
DB.classes.push(c);save();renderClasses();
clsMsg.textContent="Class created & link generated";
}

function renderClasses(){
let html="<table><tr><th>Unit</th><th>Date</th><th>Link</th><th>Export</th></tr>";
DB.classes.filter(c=>c.lec===user.u).forEach(c=>{
const link=location.origin+location.pathname+"?student="+c.id;
html+=`<tr>
<td>${c.unit}</td>
<td>${c.dt}</td>
<td><button onclick="copy('${link}')">Copy Link</button></td>
<td><button onclick="exportExcel(${c.id})">Excel</button></td>
</tr>`;
});
html+="</table>";
classList.innerHTML=html;
}

function copy(t){navigator.clipboard.writeText(t);alert("Link copied");}

function exportExcel(cid){
const rows=DB.attendance.filter(a=>a.cid===cid);
const ws=[["Adm","Name","Date"]];
rows.forEach(r=>ws.push([r.adm,r.name,r.dt]));
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(ws),"Attendance");
XLSX.writeFile(wb,"attendance.xlsx");
}

/* STUDENT */
const params=new URLSearchParams(location.search);
if(params.get("student")){
loginBox.classList.add("hidden");
studentBox.classList.remove("hidden");
const cid=Number(params.get("student"));
let ctx=stSig.getContext("2d"),draw=false;
stSig.onmousedown=e=>{draw=true;ctx.moveTo(e.offsetX,e.offsetY)}
stSig.onmousemove=e=>{if(draw){ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke()}}
window.onmouseup=()=>draw=false;

window.ontouchstart=e=>{
draw=true;const t=e.touches[0];
ctx.moveTo(t.clientX-stSig.offsetLeft,t.clientY-stSig.offsetTop)
}
window.ontouchmove=e=>{
if(draw){
const t=e.touches[0];
ctx.lineTo(t.clientX-stSig.offsetLeft,t.clientY-stSig.offsetTop);
ctx.stroke();
}
}
window.ontouchend=()=>draw=false;

window.submitAttendance=()=>{
DB.attendance.push({cid,adm:stAdm.value,name:stName.value,dt:new Date().toLocaleString()});
save();stMsg.textContent="Attendance submitted";
};
}

</script>

</body>
</html>
