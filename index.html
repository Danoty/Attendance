<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JOOUST Attendance Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!--
    Default Admin login (NOT visible on UI):
      username: admin
      password: admin123
  -->

  <style>
    :root {
      --jooust-blue: #0052cc;
      --jooust-blue-dark: #003b8c;
      --jooust-green: #24a148;
      --jooust-gold: #f2c94c;
      --bg-soft: #f4f7fb;
      --card-bg: #ffffff;
      --text-main: #1f2933;
      --text-muted: #6b7280;
      --danger: #e11d48;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg-soft);
      color: var(--text-main);
    }

    header {
      background: linear-gradient(
        135deg,
        var(--jooust-blue-dark),
        var(--jooust-blue)
      );
      color: white;
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    header .left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    header img {
      height: 52px;
      width: auto;
      border-radius: 6px;
      background: white;
      padding: 4px;
    }

    header h1 {
      margin: 0;
      font-size: 1.25rem;
      line-height: 1.3;
    }

    header h1 span {
      display: block;
      font-size: 0.8rem;
      font-weight: 400;
      opacity: 0.9;
    }

    header .right {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    main {
      max-width: 1200px;
      margin: 1.25rem auto 2.5rem;
      padding: 0 1rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    }

    h2 {
      margin-top: 0;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    h2::before {
      content: "";
      display: inline-block;
      width: 6px;
      height: 20px;
      border-radius: 999px;
      background: linear-gradient(
        180deg,
        var(--jooust-green),
        var(--jooust-gold)
      );
    }

    .hidden {
      display: none !important;
    }

    label {
      font-size: 0.85rem;
      color: var(--text-muted);
      display: block;
      margin-bottom: 0.25rem;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 0.55rem 0.65rem;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease;
      background: #f9fafb;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--jooust-blue);
      box-shadow: 0 0 0 2px rgba(0, 82, 204, 0.15);
      background: white;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem 1rem;
      margin-bottom: 0.75rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      padding: 0.55rem 1rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: transform 0.1s ease, box-shadow 0.1s ease,
        background 0.15s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(
        135deg,
        var(--jooust-blue),
        var(--jooust-blue-dark)
      );
      color: white;
      box-shadow: 0 6px 12px rgba(0, 82, 204, 0.35);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-success {
      background: linear-gradient(
        135deg,
        var(--jooust-green),
        #16a34a
      );
      color: white;
      box-shadow: 0 6px 12px rgba(22, 163, 74, 0.35);
    }

    .btn-danger {
      background: var(--danger);
      color: #f9fafb;
    }

    .btn-small {
      padding: 0.25rem 0.6rem;
      font-size: 0.78rem;
      box-shadow: none;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      font-size: 0.78rem;
      background: #e5f5ff;
      color: #075985;
    }

    .chip.green {
      background: #dcfce7;
      color: #166534;
    }

    .chip.red {
      background: #fee2e2;
      color: #b91c1c;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 0.75rem;
    }

    .tab {
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      font-size: 0.88rem;
      border: 1px solid #d1d5db;
      background: #f3f4f6;
      cursor: pointer;
    }

    .tab.active {
      background: var(--jooust-blue);
      border-color: var(--jooust-blue-dark);
      color: white;
      font-weight: 600;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
      margin-top: 0.5rem;
    }

    th,
    td {
      border: 1px solid #e5e7eb;
      padding: 0.45rem 0.4rem;
      text-align: left;
    }

    th {
      background: #eff6ff;
      color: #1d4ed8;
      font-weight: 600;
    }

    tr:nth-child(even) td {
      background: #f9fafb;
    }

    .badge {
      padding: 0.05rem 0.4rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #e5e7eb;
    }

    .badge.open {
      background: #dcfce7;
      color: #166534;
    }

    .badge.closed {
      background: #fee2e2;
      color: #b91c1c;
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.82rem;
    }

    .signature-pad {
      border: 1px dashed #9ca3af;
      border-radius: 8px;
      background: white;
      width: 100%;
      height: 120px;
      cursor: crosshair;
    }

    .signature-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 0.3rem;
      gap: 0.3rem;
    }

    .pill-header {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .pill-header h3 {
      margin: 0;
      font-size: 1rem;
    }

    .pill-header small {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .sort-select {
      min-width: 160px;
      max-width: 220px;
    }

    .alert {
      padding: 0.55rem 0.75rem;
      border-radius: 8px;
      font-size: 0.83rem;
      margin-bottom: 0.65rem;
    }

    .alert-info {
      background: #e0f2fe;
      color: #0b5394;
    }

    .alert-danger {
      background: #fee2e2;
      color: #991b1b;
    }

    .alert-success {
      background: #dcfce7;
      color: #166534;
    }

    .text-center {
      text-align: center;
    }

    .mb-0 {
      margin-bottom: 0;
    }

    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      header img {
        height: 44px;
      }

      header .right {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>

  <!-- External libs for export -->
  <!-- jsPDF + AutoTable for PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-YkGgS2TtFjQEJvH/SzW1t8ZB7G63V8YV3vm2/9W3UNsCXO6hECzn+fZcKQX5ouduPzjO6uTb4lrT7xYuFezYKg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js" integrity="sha512-T/0sKmxLa0mmKwOp+QsJz3qxdltf6M7cbpTiaCtnHAHMS2JIHId2D7W6XkMTU/kxua9jqTcpKi8FtQhoUxfb3Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- SheetJS for Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js" integrity="sha512-fVsu9i0kTrqzYoGPP6gxrKGUIFYgTc6LJvRa+X/UiDtGdvzCJ9AJNUHru6aFtsgN0VSkFmorkxLhntnHZ0uVqw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <header id="mainHeader">
    <div class="left">
      <img src="logo.jpg" alt="JOOUST Logo" />
      <h1>
        JOOUST Attendance System
        <span>Faculty · Course · Unit · Digital Signatures · Smart Reports</span>
      </h1>
    </div>
    <div class="right" id="headerRight">
      <div id="userSummary" class="muted"></div>
    </div>
  </header>

  <main>
    <!-- LOGIN & LECTURER REGISTRATION -->
    <section id="loginSection" class="card">
      <h2>Login</h2>
      <div class="row">
        <div>
          <label>Login as</label>
          <div>
            <label><input type="radio" name="loginRole" value="admin" checked /> Admin</label>
            <label><input type="radio" name="loginRole" value="lecturer" /> Lecturer</label>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="loginUsername">Username</label>
          <input id="loginUsername" type="text" placeholder="Enter username" />
        </div>
        <div>
          <label for="loginPassword">Password</label>
          <input id="loginPassword" type="password" placeholder="Enter password" />
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" id="loginBtn">Login</button>
        <button class="btn btn-secondary" id="showLecturerRegistration">Register as Lecturer</button>
      </div>
      <div id="loginMessage" class="alert hidden"></div>
    </section>

    <!-- LECTURER REGISTRATION -->
    <section id="lecturerRegistrationSection" class="card hidden">
      <h2>Lecturer Registration</h2>
      <div class="alert alert-info">
        Your account will be pending until approved by the Admin.
      </div>
      <div class="row">
        <div>
          <label for="regSalutation">Salutation</label>
          <select id="regSalutation">
            <option value="Dr.">Dr.</option>
            <option value="Mr.">Mr.</option>
            <option value="Mrs.">Mrs.</option>
            <option value="Ms.">Ms.</option>
            <option value="Prof.">Prof.</option>
          </select>
        </div>
        <div>
          <label for="regFullName">Full Name</label>
          <input id="regFullName" type="text" placeholder="Dr. Jane Doe" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="regPF">PF No / ID</label>
          <input id="regPF" type="text" />
        </div>
        <div>
          <label for="regUsername">Preferred Username</label>
          <input id="regUsername" type="text" placeholder="jdoe" />
        </div>
        <div>
          <label for="regPassword">Password</label>
          <input id="regPassword" type="password" />
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" id="submitLecturerRegistration">
          Submit Registration
        </button>
        <button class="btn btn-secondary" id="backToLogin">Back to Login</button>
      </div>
      <div id="lecturerRegMessage" class="alert hidden"></div>
    </section>

    <!-- STUDENT VIEW (SHARED LINK) -->
    <section id="studentSection" class="card hidden">
      <h2>Class Attendance – Student Sign-In</h2>
      <div id="studentClassInfo" class="alert alert-info"></div>
      <div id="studentAlreadySubmitted" class="alert alert-success hidden">
        You have already submitted attendance for this class on this device.
      </div>

      <div id="studentFormWrapper">
        <div class="row">
          <div>
            <label for="stSurname">Sir Name</label>
            <input id="stSurname" type="text" />
          </div>
          <div>
            <label for="stMiddleName">Middle Name</label>
            <input id="stMiddleName" type="text" />
          </div>
          <div>
            <label for="stFirstName">First Name</label>
            <input id="stFirstName" type="text" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="stAdmission">Admission Number</label>
            <input id="stAdmission" type="text" />
          </div>
        </div>

        <label>Digital Signature (use finger or mouse)</label>
        <canvas id="stSignaturePad" class="signature-pad"></canvas>
        <div class="signature-actions">
          <button class="btn btn-secondary" id="stClearSignature">Clear</button>
        </div>

        <div class="btn-group">
          <button class="btn btn-success" id="stSubmit">Submit Attendance</button>
        </div>
        <div id="studentSubmitMsg" class="alert hidden" style="margin-top:0.75rem;"></div>
      </div>
    </section>

    <!-- ADMIN DASHBOARD -->
    <section id="adminDashboard" class="hidden">
      <div class="card">
        <h2>Admin Dashboard</h2>
        <div class="tabs">
          <button class="tab active" data-admin-tab="lecturersTab">Lecturers</button>
          <button class="tab" data-admin-tab="classesTab">Classes</button>
          <button class="tab" data-admin-tab="facultyTab">Faculty / Course / Unit Upload</button>
          <button class="tab" data-admin-tab="reportsTab">Reports</button>
        </div>
      </div>

      <!-- Lecturers Management -->
      <section id="lecturersTab" class="card admin-tab">
        <div class="pill-header">
          <h3>Lecturer Accounts</h3>
          <small>Approve new registrations & manage existing accounts.</small>
        </div>
        <div id="lecturersTableWrapper" class="muted">No lecturers yet.</div>
      </section>

      <!-- Classes -->
      <section id="classesTab" class="card admin-tab hidden">
        <div class="pill-header">
          <div>
            <h3>All Classes</h3>
            <small>Monitor all sessions and signatures.</small>
          </div>
          <div>
            <label for="adminClassSort" class="muted">Sort classes</label>
            <select id="adminClassSort" class="sort-select">
              <option value="date_desc">Newest first</option>
              <option value="date_asc">Oldest first</option>
              <option value="unit_asc">Unit A–Z</option>
            </select>
          </div>
        </div>
        <div id="adminClassesTableWrapper" class="muted">No classes created yet.</div>
      </section>

      <!-- Faculty / Course / Unit Upload -->
      <section id="facultyTab" class="card admin-tab hidden">
        <div class="pill-header">
          <h3>Faculty / Course / Unit Mapping</h3>
          <small>Upload CSV to populate dropdown lists for reports.</small>
        </div>
        <div class="alert alert-info">
          CSV Structure: <code>Faculty,Course,Unit,Year,Semester</code><br />
          Each row represents one unit / class (for dropdown filtering only).
        </div>
        <input type="file" id="facultyCsvInput" accept=".csv" />
        <div class="btn-group">
          <button class="btn btn-primary" id="uploadFacultyCsvBtn">Upload & Save</button>
          <button class="btn btn-secondary" id="clearFacultyDataBtn">Clear All Mappings</button>
        </div>
        <div id="facultyUploadMsg" class="alert hidden" style="margin-top:0.75rem;"></div>
        <h4 style="margin-top:1rem;">Current Records</h4>
        <div id="facultySummary" class="muted"></div>
      </section>

      <!-- Reports -->
      <section id="reportsTab" class="card admin-tab hidden">
        <h3>Reports</h3>
        <p class="muted">
          Filter by Faculty, Course, Unit, Year & Semester then export as PDF, Word, Excel,
          or CSV (raw student attendance with signatures).
        </p>
        <div class="row">
          <div>
            <label for="repFaculty">Faculty</label>
            <select id="repFaculty">
              <option value="">All Faculties</option>
            </select>
          </div>
          <div>
            <label for="repCourse">Course</label>
            <select id="repCourse">
              <option value="">All Courses</option>
            </select>
          </div>
          <div>
            <label for="repUnit">Unit</label>
            <select id="repUnit">
              <option value="">All Units</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="repYear">Year</label>
            <select id="repYear">
              <option value="">All Years</option>
            </select>
          </div>
          <div>
            <label for="repSemester">Semester</label>
            <select id="repSemester">
              <option value="">All Semesters</option>
            </select>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" id="generateReportBtn">Generate Report</button>
        </div>
        <div id="reportArea" class="hidden" style="margin-top:1rem;">
          <div class="btn-group">
            <button class="btn btn-primary" id="exportPdfBtn">Download PDF</button>
            <button class="btn btn-secondary" id="exportWordBtn">Download Word</button>
            <button class="btn btn-secondary" id="exportExcelBtn">Download Excel</button>
            <button class="btn btn-secondary" id="exportCsvRawBtn">Download CSV (Raw Attendance)</button>
          </div>
          <div id="reportMeta" class="muted" style="margin-top:0.5rem;"></div>
          <table id="reportTable"></table>
        </div>
      </section>
    </section>

    <!-- LECTURER DASHBOARD -->
    <section id="lecturerDashboard" class="hidden">
      <section class="card">
        <h2>Lecturer Dashboard</h2>
        <p class="muted">
          Create classes, share attendance links with students, and manage your reports.
        </p>
      </section>

      <section class="card">
        <div class="pill-header">
          <h3>Create / Start Class</h3>
          <small>Fill details; system will generate a unique attendance link.</small>
        </div>
        <div class="row">
          <div><label for="lcFaculty">Faculty</label><input id="lcFaculty" type="text" /></div>
          <div><label for="lcCourse">Course</label><input id="lcCourse" type="text" /></div>
        </div>
        <div class="row">
          <div><label for="lcUnit">Unit</label><input id="lcUnit" type="text" /></div>
          <div><label for="lcYear">Year</label><input id="lcYear" type="text" /></div>
          <div><label for="lcSemester">Semester</label><input id="lcSemester" type="text" /></div>
        </div>
        <div class="row">
          <div><label for="lcVenue">Venue</label><input id="lcVenue" type="text" placeholder="e.g. LT1, Online, Lab 3" /></div>
          <div><label for="lcDateTime">Date & Time</label><input id="lcDateTime" type="datetime-local" /></div>
        </div>
        <div class="btn-group">
          <button class="btn btn-success" id="createClassBtn">Create / Start Class</button>
        </div>
        <div id="createClassMsg" class="alert hidden" style="margin-top:0.75rem;"></div>
      </section>

      <section class="card">
        <div class="pill-header">
          <div>
            <h3>My Classes</h3>
            <small>Share links, view attendance & sign.</small>
          </div>
          <div>
            <label for="lecturerClassSort" class="muted">Sort classes</label>
            <select id="lecturerClassSort" class="sort-select">
              <option value="date_desc">Newest first</option>
              <option value="date_asc">Oldest first</option>
              <option value="unit_asc">Unit A–Z</option>
            </select>
          </div>
        </div>
        <div id="lecturerClassesTableWrapper" class="muted">No classes yet.</div>
      </section>

      <section class="card">
        <h3>Quick Reports (My Classes)</h3>
        <p class="muted">
          These filters apply only to your own classes.
        </p>
        <div class="row">
          <div>
            <label for="repFacultyL">Faculty</label>
            <select id="repFacultyL">
              <option value="">All Faculties</option>
            </select>
          </div>
          <div>
            <label for="repCourseL">Course</label>
            <select id="repCourseL">
              <option value="">All Courses</option>
            </select>
          </div>
          <div>
            <label for="repUnitL">Unit</label>
            <select id="repUnitL">
              <option value="">All Units</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="repYearL">Year</label>
            <select id="repYearL">
              <option value="">All Years</option>
            </select>
          </div>
          <div>
            <label for="repSemesterL">Semester</label>
            <select id="repSemesterL">
              <option value="">All Semesters</option>
            </select>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" id="generateReportLecturerBtn">Generate My Report</button>
        </div>
        <div id="reportAreaLecturer" class="hidden" style="margin-top:1rem;">
          <div class="btn-group">
            <button class="btn btn-primary" id="exportPdfBtnL">Download PDF</button>
            <button class="btn btn-secondary" id="exportWordBtnL">Download Word</button>
            <button class="btn btn-secondary" id="exportExcelBtnL">Download Excel</button>
            <button class="btn btn-secondary" id="exportCsvRawBtnL">Download CSV (Raw Attendance)</button>
          </div>
          <div id="reportMetaL" class="muted" style="margin-top:0.5rem;"></div>
          <table id="reportTableL"></table>
        </div>
      </section>
    </section>
  </main>

  <script>
    // ========================== DATA STORAGE ==========================
    const STORAGE_KEY = "jooust_attendance_data_v1";

    function getBaseData() {
      return {
        admins: [{ username: "admin", password: "admin123" }],
        lecturers: [],
        facultyConfig: [],
        classes: [],
        attendance: [],
      };
    }

    function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        const base = getBaseData();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(base));
        return base;
      }
      try {
        return JSON.parse(raw);
      } catch (e) {
        console.error("Failed to parse storage. Resetting.", e);
        const base = getBaseData();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(base));
        return base;
      }
    }

    function saveData(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    let DATA = loadData();

    // Current session
    let currentUser = null; // {role: 'admin'|'lecturer', id/username}
    let jooustLogoDataUrl = null;

    // ========================== UTILS ==========================
    function $(id) {
      return document.getElementById(id);
    }

    function showSection(id) {
      [
        "loginSection",
        "lecturerRegistrationSection",
        "adminDashboard",
        "lecturerDashboard",
        "studentSection",
      ].forEach((sid) => {
        const el = $(sid);
        if (!el) return;
        el.classList.toggle("hidden", sid !== id);
      });
    }

    function uuid() {
      return (
        Date.now().toString(36) +
        "-" +
        Math.random().toString(36).substring(2, 10)
      );
    }

    function formatDateTime(dt) {
      if (!dt) return "";
      const d = new Date(dt);
      if (isNaN(d)) return dt;
      return (
        d.toLocaleDateString() +
        " " +
        d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
      );
    }

    function setAlert(el, message, type = "info") {
      el.textContent = message;
      el.classList.remove("hidden", "alert-info", "alert-danger", "alert-success");
      if (type === "danger") el.classList.add("alert-danger");
      else if (type === "success") el.classList.add("alert-success");
      else el.classList.add("alert-info");
    }

    function clearAlert(el) {
      el.classList.add("hidden");
    }

    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // ========================== LOGO TO DATA URL ==========================
    function loadLogoAsDataUrl() {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.src = "logo.jpg";
      img.onload = function () {
        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        jooustLogoDataUrl = canvas.toDataURL("image/jpeg");
      };
      img.onerror = function () {
        console.warn("Could not load logo.jpg for embedding in PDFs/Word.");
      };
    }

    // ========================== HEADER (USER SUMMARY / LOGOUT) ==========================
    function updateUserSummary() {
      const summaryEl = $("userSummary");
      const headerRight = $("headerRight");
      summaryEl.innerHTML = "";

      // Remove old buttons if any
      const oldLogout = $("logoutBtn");
      const oldChange = $("changePasswordBtn");
      if (oldLogout) oldLogout.remove();
      if (oldChange) oldChange.remove();

      if (!currentUser) return;

      let label = "";
      DATA = loadData();

      if (currentUser.role === "admin") {
        label = "Logged in as Admin";
      } else if (currentUser.role === "lecturer") {
        const lec = DATA.lecturers.find((l) => l.id === currentUser.id);
        const name = lec ? lec.salutation + " " + lec.fullName : currentUser.username;
        label = "Logged in as Lecturer: " + name;
      }

      summaryEl.textContent = label;

      const btnChange = document.createElement("button");
      btnChange.id = "changePasswordBtn";
      btnChange.className = "btn btn-secondary btn-small";
      btnChange.textContent = "Change Password";
      btnChange.addEventListener("click", openChangePasswordDialog);

      const btnLogout = document.createElement("button");
      btnLogout.id = "logoutBtn";
      btnLogout.className = "btn btn-secondary btn-small";
      btnLogout.textContent = "Logout";
      btnLogout.addEventListener("click", handleLogout);

      headerRight.appendChild(btnChange);
      headerRight.appendChild(btnLogout);
    }

    function handleLogout() {
      currentUser = null;
      updateUserSummary();
      showSection("loginSection");
      $("loginUsername").value = "";
      $("loginPassword").value = "";
    }

    // ========================== CHANGE PASSWORD ==========================
    function openChangePasswordDialog() {
      if (!currentUser) return;

      const overlay = document.createElement("div");
      overlay.style.position = "fixed";
      overlay.style.inset = "0";
      overlay.style.background = "rgba(15,23,42,0.6)";
      overlay.style.display = "flex";
      overlay.style.alignItems = "center";
      overlay.style.justifyContent = "center";
      overlay.style.zIndex = "9999";

      const card = document.createElement("div");
      card.className = "card";
      card.style.maxWidth = "420px";
      card.style.width = "95%";

      card.innerHTML = `
        <h2>Change Password</h2>
        <div class="row">
          <div>
            <label for="cpCurrent">Current Password</label>
            <input type="password" id="cpCurrent" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="cpNew">New Password</label>
            <input type="password" id="cpNew" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="cpConfirm">Confirm New Password</label>
            <input type="password" id="cpConfirm" />
          </div>
        </div>
        <div id="cpMsg" class="alert hidden"></div>
        <div class="btn-group">
          <button class="btn btn-primary" id="cpSave">Save</button>
          <button class="btn btn-secondary" id="cpCancel">Cancel</button>
        </div>
      `;

      overlay.appendChild(card);
      document.body.appendChild(overlay);

      const cpMsg = card.querySelector("#cpMsg");

      card.querySelector("#cpCancel").onclick = () => overlay.remove();
      card.querySelector("#cpSave").onclick = () => {
        const current = card.querySelector("#cpCurrent").value;
        const np = card.querySelector("#cpNew").value;
        const cp = card.querySelector("#cpConfirm").value;

        if (!current || !np || !cp) {
          setAlert(cpMsg, "Fill all fields.", "danger");
          return;
        }
        if (np !== cp) {
          setAlert(cpMsg, "New passwords do not match.", "danger");
          return;
        }

        DATA = loadData();
        if (currentUser.role === "admin") {
          const admin = DATA.admins.find((a) => a.username === currentUser.username);
          if (!admin || admin.password !== current) {
            setAlert(cpMsg, "Current password is incorrect.", "danger");
            return;
          }
          admin.password = np;
        } else if (currentUser.role === "lecturer") {
          const lec = DATA.lecturers.find((l) => l.id === currentUser.id);
          if (!lec || lec.password !== current) {
            setAlert(cpMsg, "Current password is incorrect.", "danger");
            return;
          }
          lec.password = np;
        } else {
          setAlert(cpMsg, "Unknown user role.", "danger");
          return;
        }

        saveData(DATA);
        alert("Password changed successfully.");
        overlay.remove();
      };
    }

    // ========================== LOGIN & REGISTRATION ==========================
    $("loginBtn").addEventListener("click", () => {
      const username = $("loginUsername").value.trim();
      const password = $("loginPassword").value;
      const role = document.querySelector('input[name="loginRole"]:checked').value;
      const msgEl = $("loginMessage");

      if (!username || !password) {
        setAlert(msgEl, "Please enter username and password.", "danger");
        return;
      }
      DATA = loadData();

      if (role === "admin") {
        const found = DATA.admins.find(
          (a) => a.username === username && a.password === password
        );
        if (!found) {
          setAlert(msgEl, "Invalid admin credentials.", "danger");
          return;
        }
        currentUser = { role: "admin", username };
        clearAlert(msgEl);
        showSection("adminDashboard");
        updateUserSummary();
        renderAdminLecturers();
        renderFacultySummary();
        renderAdminClasses();
        refreshAdminFilterDropdowns();
      } else {
        const lec = DATA.lecturers.find(
          (l) => l.username === username && l.password === password
        );
        if (!lec) {
          setAlert(msgEl, "Lecturer not found or wrong password.", "danger");
          return;
        }
        if (!lec.approved) {
          setAlert(
            msgEl,
            "Your account is pending approval by Admin.",
            "danger"
          );
          return;
        }
        currentUser = { role: "lecturer", id: lec.id, username: lec.username };
        clearAlert(msgEl);
        showSection("lecturerDashboard");
        updateUserSummary();
        renderLecturerClasses();
        refreshLecturerFilterDropdowns();
      }
    });

    $("showLecturerRegistration").addEventListener("click", () => {
      showSection("lecturerRegistrationSection");
      clearAlert($("loginMessage"));
    });

    $("backToLogin").addEventListener("click", () => {
      showSection("loginSection");
      clearAlert($("lecturerRegMessage"));
    });

    $("submitLecturerRegistration").addEventListener("click", () => {
      const salutation = $("regSalutation").value;
      const fullName = $("regFullName").value.trim();
      const pf = $("regPF").value.trim();
      const username = $("regUsername").value.trim();
      const password = $("regPassword").value;

      const msgEl = $("lecturerRegMessage");

      if (!fullName || !pf || !username || !password) {
        setAlert(msgEl, "Please fill all required fields.", "danger");
        return;
      }

      DATA = loadData();
      if (
        DATA.lecturers.some((l) => l.username === username) ||
        DATA.admins.some((a) => a.username === username)
      ) {
        setAlert(msgEl, "Username already exists.", "danger");
        return;
      }

      const lecturer = {
        id: uuid(),
        salutation,
        fullName,
        pf,
        username,
        password,
        approved: false,
        assignments: [],
      };

      DATA.lecturers.push(lecturer);
      saveData(DATA);
      setAlert(
        msgEl,
        "Registration submitted. Wait for admin approval.",
        "success"
      );
      $("regFullName").value =
        $("regPF").value =
        $("regUsername").value =
        $("regPassword").value =
          "";
    });

    // ========================== ADMIN: LECTURERS ==========================
    function renderAdminLecturers() {
      const wrapper = $("lecturersTableWrapper");
      DATA = loadData();

      if (!DATA.lecturers.length) {
        wrapper.textContent = "No lecturers registered yet.";
        return;
      }

      let html = `<table><thead><tr>
          <th>Lecturer</th>
          <th>PF/ID</th>
          <th>Username</th>
          <th>Status</th>
          <th>Actions</th>
        </tr></thead><tbody>`;

      DATA.lecturers.forEach((lec) => {
        const statusChip = lec.approved
          ? '<span class="chip green">Approved</span>'
          : '<span class="chip red">Pending</span>';

        html += `<tr>
          <td>${lec.salutation} ${lec.fullName}</td>
          <td>${lec.pf}</td>
          <td>${lec.username}</td>
          <td>${statusChip}</td>
          <td>
            ${
              lec.approved
                ? `<button class="btn btn-secondary" data-action="toggle-approve" data-id="${lec.id}">Revoke</button>`
                : `<button class="btn btn-success" data-action="toggle-approve" data-id="${lec.id}">Approve</button>`
            }
          </td>
        </tr>`;
      });

      html += "</tbody></table>";
      wrapper.innerHTML = html;

      wrapper
        .querySelectorAll("button[data-action='toggle-approve']")
        .forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-id");
            const lec = DATA.lecturers.find((l) => l.id === id);
            if (!lec) return;
            lec.approved = !lec.approved;
            saveData(DATA);
            renderAdminLecturers();
          });
        });
    }

    // ========================== ADMIN: FACULTY CSV ==========================
    $("uploadFacultyCsvBtn").addEventListener("click", () => {
      const fileInput = $("facultyCsvInput");
      const msgEl = $("facultyUploadMsg");
      const file = fileInput.files[0];
      if (!file) {
        setAlert(msgEl, "Select a CSV file first.", "danger");
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        const lines = text.split(/\r?\n/).filter((l) => l.trim());
        const records = [];
        for (let line of lines) {
          const parts = line.split(",").map((p) => p.trim());
          if (parts.length < 5) continue;
          const [faculty, course, unit, year, semester] = parts;
          records.push({ faculty, course, unit, year, semester });
        }
        DATA = loadData();
        DATA.facultyConfig = records;
        saveData(DATA);
        setAlert(
          msgEl,
          `Uploaded ${records.length} entries successfully.`,
          "success"
        );
        renderFacultySummary();
        refreshAdminFilterDropdowns();
      };
      reader.readAsText(file);
    });

    $("clearFacultyDataBtn").addEventListener("click", () => {
      const msgEl = $("facultyUploadMsg");
      if (!confirm("Clear all existing faculty/course/unit mappings?")) return;
      DATA = loadData();
      DATA.facultyConfig = [];
      saveData(DATA);
      setAlert(msgEl, "All mappings cleared.", "success");
      renderFacultySummary();
      refreshAdminFilterDropdowns();
    });

    function renderFacultySummary() {
      const wrap = $("facultySummary");
      DATA = loadData();
      if (!DATA.facultyConfig.length) {
        wrap.textContent = "No mappings uploaded yet.";
        return;
      }
      const total = DATA.facultyConfig.length;
      const faculties = [
        ...new Set(DATA.facultyConfig.map((r) => r.faculty)),
      ];
      wrap.innerHTML = `
        <p class="muted mb-0">
          Total entries: <strong>${total}</strong><br>
          Faculties: ${faculties.join(", ")}
        </p>
      `;
    }

    // ========================== CLASS CREATION (LECTURER) ==========================
    $("createClassBtn").addEventListener("click", () => {
      const f = $("lcFaculty").value.trim();
      const c = $("lcCourse").value.trim();
      const u = $("lcUnit").value.trim();
      const y = $("lcYear").value.trim();
      const s = $("lcSemester").value.trim();
      const v = $("lcVenue").value.trim();
      const dt = $("lcDateTime").value;
      const msgEl = $("createClassMsg");

      if (!currentUser || currentUser.role !== "lecturer") {
        setAlert(
          msgEl,
          "You must be logged in as lecturer to create classes.",
          "danger"
        );
        return;
      }

      if (!f || !c || !u || !y || !s || !v || !dt) {
        setAlert(msgEl, "Please fill all class details.", "danger");
        return;
      }

      DATA = loadData();
      const lec = DATA.lecturers.find((l) => l.id === currentUser.id);
      if (!lec) {
        setAlert(msgEl, "Lecturer not found.", "danger");
        return;
      }

      const classId = uuid();
      const cls = {
        id: classId,
        lecturerId: lec.id,
        faculty: f,
        course: c,
        unit: u,
        year: y,
        semester: s,
        venue: v,
        dateTime: dt,
        status: "open",
        lecturerName: lec.salutation + " " + lec.fullName,
        lecturerSignature: null,
        hodName: "",
        hodSignature: null,
      };

      DATA.classes.push(cls);
      saveData(DATA);
      renderLecturerClasses();
      renderAdminClasses();
      refreshAdminFilterDropdowns();
      refreshLecturerFilterDropdowns();

      const link =
        window.location.origin +
        window.location.pathname +
        "?mode=student&classId=" +
        encodeURIComponent(classId);

      setAlert(
        msgEl,
        "Class created. Share this link with students: " + link,
        "success"
      );
    });

    function sortClasses(list, sortMode) {
      const arr = list.slice();
      if (sortMode === "date_asc" || sortMode === "date_desc") {
        arr.sort((a, b) => {
          const da = new Date(a.dateTime).getTime();
          const db = new Date(b.dateTime).getTime();
          return sortMode === "date_asc" ? da - db : db - da;
        });
      } else if (sortMode === "unit_asc") {
        arr.sort((a, b) => (a.unit || "").localeCompare(b.unit || ""));
      }
      return arr;
    }

    function renderLecturerClasses() {
      const wrap = $("lecturerClassesTableWrapper");
      DATA = loadData();
      if (!currentUser || currentUser.role !== "lecturer") {
        wrap.textContent = "Not logged in.";
        return;
      }

      const sortMode = $("lecturerClassSort") ? $("lecturerClassSort").value : "date_desc";
      const myRaw = DATA.classes.filter((c) => c.lecturerId === currentUser.id);
      const my = sortClasses(myRaw, sortMode);

      if (!my.length) {
        wrap.textContent = "No classes created yet.";
        return;
      }

      let html = `<table><thead><tr>
        <th>Class</th>
        <th>Venue / Date</th>
        <th>Status</th>
        <th>Attendance</th>
        <th>Actions</th>
      </tr></thead><tbody>`;

      my.forEach((cls) => {
        const att = DATA.attendance.filter((a) => a.classId === cls.id);
        const statusBadge =
          cls.status === "open"
            ? '<span class="badge open">Open</span>'
            : '<span class="badge closed">Closed</span>';
        const link =
          window.location.origin +
          wind
