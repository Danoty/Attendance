<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JOOUST | Smart Class Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Icons -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
  />

  <!-- JS Libraries for Excel & PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --jooust-blue: #003c71;   /* primary */
      --jooust-blue-soft: #e1ecf8;
      --jooust-green: #108b3a;  /* accent */
      --jooust-gold: #f2a900;   /* accent */
      --bg-soft: #f5f7fb;
    }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: var(--bg-soft);
      min-height: 100vh;
    }

    .navbar {
      background: linear-gradient(90deg, var(--jooust-blue), #001a33);
    }

    .navbar-brand,
    .navbar-nav .nav-link,
    .navbar-text {
      color: #fff !important;
    }

    .brand-title {
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      font-size: 1.0rem;
    }

    .page-header {
      padding: 1.4rem 1rem 0.2rem;
    }

    .page-header h1 {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--jooust-blue);
      display: flex;
      align-items: center;
      gap: .4rem;
    }

    .page-header h1 span.badge {
      background: var(--jooust-green);
    }

    .card {
      border: none;
      border-radius: 0.8rem;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.05);
    }

    .card-header {
      border-radius: 0.8rem 0.8rem 0 0 !important;
      background: linear-gradient(90deg, var(--jooust-blue), var(--jooust-green));
      color: #fff;
    }

    .card-header i {
      margin-right: .4rem;
    }

    .section-title {
      font-weight: 600;
      color: var(--jooust-blue);
    }

    .badge-pill {
      border-radius: 999px;
    }

    .pill-info {
      background: var(--jooust-blue-soft);
      color: var(--jooust-blue);
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .btn-jooust {
      background: var(--jooust-blue);
      border-color: var(--jooust-blue);
      color: #fff;
    }

    .btn-jooust:hover {
      background: #002a4a;
      border-color: #002a4a;
      color: #fff;
    }

    .btn-outline-jooust {
      border-color: var(--jooust-blue);
      color: var(--jooust-blue);
    }

    .btn-outline-jooust:hover {
      background: var(--jooust-blue);
      color: #fff;
    }

    .share-link-box {
      background: #fdfdfd;
      border-radius: 0.6rem;
      border: 1px dashed var(--jooust-blue);
      padding: 0.75rem;
      font-size: 0.9rem;
    }

    .share-link-box code {
      word-break: break-all;
    }

    .table thead {
      background: var(--jooust-blue-soft);
      color: var(--jooust-blue);
      font-size: 0.85rem;
    }

    .signature-box {
      border: 1px dashed #c3c8d3;
      border-radius: 0.5rem;
      padding: 0.75rem;
      background: #fff;
    }

    canvas.signature-canvas {
      border-radius: 0.4rem;
      width: 100%;
      background: #f9fafc;
      border: 1px solid #d4d9e2;
      cursor: crosshair;
    }

    .signature-label {
      font-weight: 600;
      color: var(--jooust-blue);
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    footer {
      font-size: 0.8rem;
      color: #6c757d;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: var(--jooust-blue-soft);
      font-size: 0.75rem;
      color: var(--jooust-blue);
      margin-right: 0.25rem;
    }

    .chip i {
      margin-right: 0.25rem;
    }

    .stat-card {
      border-radius: 0.8rem;
      padding: 0.75rem 0.9rem;
      background: linear-gradient(135deg, #fff, #f0f4ff);
      border: 1px solid #dde4f1;
    }

    .stat-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6c7a96;
      margin-bottom: 0.15rem;
    }

    .stat-value {
      font-weight: 700;
      color: var(--jooust-blue);
      font-size: 1.1rem;
    }

    .stat-extra {
      font-size: 0.75rem;
      color: #6c757d;
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
    <div class="container-fluid px-3 px-sm-4">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <img
          src="logo.jpg"
          id="jooustLogo"
          alt="JOOUST Logo"
          style="height:40px; width:auto; border-radius:6px; background:#fff; padding:2px;"
        />
        <div>
          <div class="brand-title">JOOUST Attendance Portal</div>
          <small class="d-none d-sm-block">Smart Class Attendance • Lecturer & HOD Sign-off</small>
        </div>
      </a>
      <span class="navbar-text small ms-auto">
        <i class="bi bi-shield-lock"></i>
        Secure • Simple • Paperless
      </span>
    </div>
  </nav>

  <div class="container-fluid px-3 px-sm-4 pb-4">
    <div class="page-header">
      <h1>
        Smart Attendance
        <span class="badge rounded-pill">Beta</span>
      </h1>
      <div class="mt-1 mb-3">
        <span class="chip"><i class="bi bi-qr-code-scan"></i>Create & share session links</span>
        <span class="chip"><i class="bi bi-pen"></i>Lecturer & HOD e-signatures</span>
        <span class="chip"><i class="bi bi-file-earmark-bar-graph"></i>Weekly / monthly reports</span>
      </div>
    </div>

    <!-- MAIN LAYOUT -->
    <div class="row g-3">
      <!-- ADMIN / LECTURER VIEW -->
      <div class="col-lg-7" id="adminSection">
        <!-- CREATE SESSION -->
        <div class="card mb-3">
          <div class="card-header">
            <i class="bi bi-plus-circle"></i>Create Attendance Session
          </div>
          <div class="card-body">
            <form id="sessionForm" class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" id="sessionDate" required />
              </div>
              <div class="col-md-4">
                <label class="form-label">Class / Year</label>
                <input type="text" class="form-control" id="className" placeholder="e.g. BIT Y2S1" required />
              </div>
              <div class="col-md-4">
                <label class="form-label">Unit Code / Name</label>
                <input type="text" class="form-control" id="unitName" placeholder="e.g. ICS 2212" required />
              </div>

              <div class="col-md-4">
                <label class="form-label">Lecturer Name</label>
                <input type="text" class="form-control" id="lecturerName" placeholder="e.g. Dr. A. Otieno" required />
              </div>
              <div class="col-md-4">
                <label class="form-label">HOD Name</label>
                <input type="text" class="form-control" id="hodName" placeholder="e.g. Prof. B. Okello" />
              </div>
              <div class="col-md-2">
                <label class="form-label">Start Time</label>
                <input type="time" class="form-control" id="startTime" />
              </div>
              <div class="col-md-2">
                <label class="form-label">End Time</label>
                <input type="time" class="form-control" id="endTime" />
              </div>

              <div class="col-12 d-flex justify-content-between align-items-center mt-2">
                <button type="submit" class="btn btn-jooust">
                  <i class="bi bi-check2-circle"></i>
                  Save Session
                </button>
                <span class="pill-info">
                  <i class="bi bi-info-circle"></i>
                  After saving, a student link will be generated automatically.
                </span>
              </div>
            </form>

            <!-- SHARE LINK -->
            <hr />
            <div>
              <div class="section-title mb-1">
                <i class="bi bi-link-45deg"></i> Share link with students
              </div>
              <div class="share-link-box">
                <div class="small text-muted mb-1">
                  Latest session link (copy & send to class WhatsApp / email):
                </div>
                <code id="shareLinkText">No session yet. Create one above.</code>
                <div class="mt-2 d-flex gap-2">
                  <button id="copyLinkBtn" disabled class="btn btn-sm btn-outline-jooust">
                    <i class="bi bi-clipboard-check"></i> Copy Link
                  </button>
                  <span class="text-success small d-none" id="copyStatus">
                    <i class="bi bi-check-circle"></i> Copied!
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SESSION & ATTENDANCE VIEW -->
        <div class="card mb-3">
          <div class="card-header">
            <i class="bi bi-people"></i> Session Attendance & Sign-off
          </div>
          <div class="card-body">
            <div class="row g-2 mb-3">
              <div class="col-md-6">
                <label class="form-label">Select Session</label>
                <select class="form-select" id="sessionSelect"></select>
              </div>
              <div class="col-md-6 d-flex align-items-end justify-content-end gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="refreshSessionsBtn">
                  <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button class="btn btn-outline-danger btn-sm" id="clearAllBtn">
                  <i class="bi bi-trash"></i> Clear ALL (local)
                </button>
              </div>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-title">Registered Students</div>
                  <div class="stat-value" id="statTotal">0</div>
                  <div class="stat-extra" id="statMeta">No session selected</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-title">This Week (All Classes)</div>
                  <div class="stat-value" id="statWeek">0</div>
                  <div class="stat-extra">Unique sessions captured</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="stat-card">
                  <div class="stat-title">This Month (All Classes)</div>
                  <div class="stat-value" id="statMonth">0</div>
                  <div class="stat-extra">Unique sessions captured</div>
                </div>
              </div>
            </div>

            <div class="table-responsive mb-3">
              <table class="table table-sm table-hover align-middle mb-0" id="attendanceTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Student Name</th>
                    <th>Reg. No.</th>
                    <th>Time</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="4" class="text-center text-muted small">
                      No data. Ask students to open the session link and submit their details.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- SIGNATURES -->
            <div class="row g-3 mt-3">
              <div class="col-md-6">
                <div class="signature-box">
                  <div class="signature-label">Lecturer Signature (Confirm class took place)</div>
                  <canvas class="signature-canvas" id="lecturerCanvas" height="150"></canvas>
                  <div class="d-flex justify-content-between align-items-center mt-1">
                    <small class="text-muted">Sign using a mouse or touch.</small>
                    <button class="btn btn-sm btn-outline-secondary" id="clearLecturerSig">
                      Clear
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="signature-box">
                  <div class="signature-label">HOD Signature (Approve attendance)</div>
                  <canvas class="signature-canvas" id="hodCanvas" height="150"></canvas>
                  <div class="d-flex justify-content-between align-items-center mt-1">
                    <small class="text-muted">HOD signs here to approve.</small>
                    <button class="btn btn-sm btn-outline-secondary" id="clearHodSig">
                      Clear
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- EXPORT -->
            <div class="mt-3 d-flex flex-wrap gap-2 justify-content-between">
              <div class="section-title mb-0">
                <i class="bi bi-file-earmark-arrow-down"></i> Export attendance
              </div>
              <div>
                <button class="btn btn-sm btn-outline-success" id="exportExcelBtn">
                  <i class="bi bi-file-earmark-spreadsheet"></i> Excel
                </button>
                <button class="btn btn-sm btn-outline-danger" id="exportPdfBtn">
                  <i class="bi bi-file-earmark-pdf"></i> PDF
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- STUDENT / ATTENDEE VIEW -->
      <div class="col-lg-5" id="studentSection">
        <div class="card mb-3">
          <div class="card-header">
            <i class="bi bi-person-check"></i> Student Attendance Form
          </div>
          <div class="card-body">
            <p class="small text-muted mb-2" id="studentSessionInfo">
              Opened without a specific session link. When a lecturer shares a link, it will automatically load the
              right class and date here.
            </p>

            <form id="studentForm" class="row g-3">
              <div class="col-12">
                <label class="form-label">Your Full Name</label>
                <input type="text" class="form-control" id="studentName" required />
              </div>
              <div class="col-12">
                <label class="form-label">Registration Number</label>
                <input type="text" class="form-control" id="studentRegNo" required />
              </div>
              <div class="col-md-6">
                <label class="form-label">Class / Year</label>
                <input type="text" class="form-control" id="studentClass" readonly />
              </div>
              <div class="col-md-6">
                <label class="form-label">Unit</label>
                <input type="text" class="form-control" id="studentUnit" readonly />
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-jooust w-100">
                  <i class="bi bi-hand-index-thumb"></i> Mark My Attendance
                </button>
              </div>
            </form>

            <div class="alert alert-success mt-3 d-none" id="studentSuccess">
              <i class="bi bi-check-circle-fill"></i>
              Thank you! Your attendance has been recorded for this session.
            </div>
          </div>
        </div>

        <!-- REPORT FILTERS (CLASS SUMMARY, WEEKLY, MONTHLY) -->
        <div class="card">
          <div class="card-header">
            <i class="bi bi-bar-chart"></i> Quick Reports (Summary)
          </div>
          <div class="card-body">
            <div class="row g-2 mb-3">
              <div class="col-md-6">
                <label class="form-label">Report Type</label>
                <select class="form-select" id="reportType">
                  <option value="class">Class Summary</option>
                  <option value="weekly">Weekly Summary</option>
                  <option value="monthly">Monthly Summary</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Filter Class (optional)</label>
                <input type="text" class="form-control" id="reportClassFilter" placeholder="e.g. BIT Y2S1" />
              </div>
            </div>
            <button class="btn btn-outline-jooust btn-sm mb-2" id="generateReportBtn">
              <i class="bi bi-lightning-charge"></i> Generate Summary
            </button>
            <pre
              id="reportOutput"
              class="bg-light border rounded p-2 small mb-0"
              style="max-height: 220px; overflow:auto;"
            >No report yet. Click "Generate Summary".</pre>
          </div>
        </div>
      </div>
    </div>

    <footer class="mt-4 mb-2 text-center">
      JOOUST Smart Attendance • Local-storage prototype (no server). Clear data button only affects this browser.
    </footer>
  </div>

  <script>
    // ===== Utilities =====
    function getQueryParams() {
      const params = {};
      window.location.search
        .substring(1)
        .split("&")
        .forEach((pair) => {
          if (!pair) return;
          const [k, v] = pair.split("=");
          params[decodeURIComponent(k)] = decodeURIComponent(v || "");
        });
      return params;
    }

    function loadSessions() {
      return JSON.parse(localStorage.getItem("attendanceSessions") || "[]");
    }

    function saveSessions(sessions) {
      localStorage.setItem("attendanceSessions", JSON.stringify(sessions));
    }

    function loadRecords(sessionId) {
      const all = JSON.parse(localStorage.getItem("attendanceRecords") || "{}");
      return all[sessionId] || [];
    }

    function saveRecords(sessionId, records) {
      const all = JSON.parse(localStorage.getItem("attendanceRecords") || "{}");
      all[sessionId] = records;
      localStorage.setItem("attendanceRecords", JSON.stringify(all));
    }

    function generateSessionId() {
      return "S-" + Math.random().toString(36).substring(2, 10).toUpperCase();
    }

    function formatTime(date) {
      return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    function formatDate(date) {
      return date.toISOString().substring(0, 10);
    }

    // ===== Session Form & Sharing =====
    const sessionForm = document.getElementById("sessionForm");
    const shareLinkText = document.getElementById("shareLinkText");
    const copyLinkBtn = document.getElementById("copyLinkBtn");
    const copyStatus = document.getElementById("copyStatus");
    const sessionSelect = document.getElementById("sessionSelect");
    const refreshSessionsBtn = document.getElementById("refreshSessionsBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const attendanceTableBody = document.querySelector("#attendanceTable tbody");
    const statTotal = document.getElementById("statTotal");
    const statMeta = document.getElementById("statMeta");
    const statWeek = document.getElementById("statWeek");
    const statMonth = document.getElementById("statMonth");

    let currentSessionId = null;

    sessionForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const date = document.getElementById("sessionDate").value || formatDate(new Date());
      const cls = document.getElementById("className").value.trim();
      const unit = document.getElementById("unitName").value.trim();
      const lecturer = document.getElementById("lecturerName").value.trim();
      const hod = document.getElementById("hodName").value.trim();
      const startTime = document.getElementById("startTime").value;
      const endTime = document.getElementById("endTime").value;

      if (!cls || !unit || !lecturer) {
        alert("Please fill in Class, Unit and Lecturer.");
        return;
      }

      const sessions = loadSessions();
      const id = generateSessionId();
      const sessionObj = {
        id,
        date,
        className: cls,
        unitName: unit,
        lecturer,
        hod,
        startTime,
        endTime,
        createdAt: new Date().toISOString(),
      };
      sessions.push(sessionObj);
      saveSessions(sessions);

      currentSessionId = id;
      updateSessionDropdown();
      updateShareLink();
      alert("Session saved successfully!");
    });

    function updateShareLink() {
      const sessions = loadSessions();
      const last = sessions[sessions.length - 1];
      if (!last) {
        shareLinkText.textContent = "No session yet. Create one above.";
        copyLinkBtn.disabled = true;
        return;
      }
      currentSessionId = last.id;
      const baseUrl = window.location.origin + window.location.pathname;
      const link = `${baseUrl}?session=${encodeURIComponent(last.id)}&role=student`;
      shareLinkText.textContent = link;
      copyLinkBtn.disabled = false;
      copyStatus.classList.add("d-none");
      populateSessionDetails(last.id);
    }

    copyLinkBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(shareLinkText.textContent);
        copyStatus.classList.remove("d-none");
        setTimeout(() => copyStatus.classList.add("d-none"), 1800);
      } catch (e) {
        alert("Copy failed. Manually select and copy the link.");
      }
    });

    function updateSessionDropdown() {
      const sessions = loadSessions();
      sessionSelect.innerHTML = "";
      if (!sessions.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No session saved yet";
        sessionSelect.appendChild(opt);
        return;
      }
      sessions.forEach((s) => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = `${s.date} | ${s.className} | ${s.unitName}`;
        sessionSelect.appendChild(opt);
      });
      // Default to latest
      sessionSelect.value = sessions[sessions.length - 1].id;
      currentSessionId = sessionSelect.value;
      populateSessionDetails(currentSessionId);
    }

    refreshSessionsBtn.addEventListener("click", () => {
      updateSessionDropdown();
      updateShareLink();
    });

    clearAllBtn.addEventListener("click", () => {
      if (!confirm("This will clear ALL sessions and records from this browser. Continue?")) return;
      localStorage.removeItem("attendanceSessions");
      localStorage.removeItem("attendanceRecords");
      updateSessionDropdown();
      updateShareLink();
      updateAttendanceTable(null);
      updateStats();
    });

    sessionSelect.addEventListener("change", () => {
      currentSessionId = sessionSelect.value || null;
      populateSessionDetails(currentSessionId);
    });

    function populateSessionDetails(sessionId) {
      if (!sessionId) {
        updateAttendanceTable(null);
        statMeta.textContent = "No session selected";
        statTotal.textContent = "0";
        return;
      }
      const sessions = loadSessions();
      const session = sessions.find((s) => s.id === sessionId);
      const records = loadRecords(sessionId);
      updateAttendanceTable(records);
      if (session) {
        statMeta.textContent =
          session.className +
          " • " +
          session.unitName +
          " • " +
          (session.date || "").toString();
      }
      statTotal.textContent = records.length.toString();
      updateStats();
    }

    function updateAttendanceTable(records) {
      attendanceTableBody.innerHTML = "";
      if (!records || !records.length) {
        const tr = document.createElement("tr");
        tr.innerHTML =
          '<td colspan="4" class="text-center text-muted small">No attendance for this session yet.</td>';
        attendanceTableBody.appendChild(tr);
        return;
      }
      records.forEach((rec, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${rec.name}</td>
          <td>${rec.regNo}</td>
          <td>${new Date(rec.time).toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          })}</td>
        `;
        attendanceTableBody.appendChild(tr);
      });
    }

    // ===== STUDENT FORM =====
    const studentForm = document.getElementById("studentForm");
    const studentSuccess = document.getElementById("studentSuccess");
    const studentSessionInfo = document.getElementById("studentSessionInfo");
    const studentClass = document.getElementById("studentClass");
    const studentUnit = document.getElementById("studentUnit");

    let studentSessionId = null;

    studentForm.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!studentSessionId) {
        alert("This page is not linked to any session. Use the link sent by your lecturer.");
        return;
      }

      const name = document.getElementById("studentName").value.trim();
      const regNo = document.getElementById("studentRegNo").value.trim().toUpperCase();

      if (!name || !regNo) {
        alert("Please enter your full name and registration number.");
        return;
      }

      const records = loadRecords(studentSessionId);
      const now = new Date().toISOString();
      records.push({ name, regNo, time: now });
      saveRecords(studentSessionId, records);

      studentForm.reset();
      studentClass.value = studentClass.dataset.value || "";
      studentUnit.value = studentUnit.dataset.value || "";

      studentSuccess.classList.remove("d-none");
      setTimeout(() => studentSuccess.classList.add("d-none"), 2500);
    });

    // ===== SIGNATURES =====
    function setupSignature(canvasId, clearBtnId) {
      const canvas = document.getElementById(canvasId);
      const clearBtn = document.getElementById(clearBtnId);
      const ctx = canvas.getContext("2d");
      let drawing = false;
      let lastPos = { x: 0, y: 0 };

      function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
          x: clientX - rect.left,
          y: clientY - rect.top,
        };
      }

      function start(e) {
        drawing = true;
        lastPos = getPos(e);
      }

      function move(e) {
        if (!drawing) return;
        e.preventDefault();
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(lastPos.x, lastPos.y);
        ctx.lineTo(pos.x, pos.y);
        ctx.strokeStyle = "#000";
        ctx.lineWidth = 2;
        ctx.lineCap = "round";
        ctx.stroke();
        lastPos = pos;
      }

      function end() {
        drawing = false;
      }

      canvas.addEventListener("mousedown", start);
      canvas.addEventListener("mousemove", move);
      canvas.addEventListener("mouseup", end);
      canvas.addEventListener("mouseleave", end);
      canvas.addEventListener("touchstart", start);
      canvas.addEventListener("touchmove", move);
      canvas.addEventListener("touchend", end);

      clearBtn.addEventListener("click", () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      });

      return {
        canvas,
        getDataURL: () => canvas.toDataURL("image/png"),
      };
    }

    const lecturerSig = setupSignature("lecturerCanvas", "clearLecturerSig");
    const hodSig = setupSignature("hodCanvas", "clearHodSig");

    // ===== EXPORT: EXCEL & PDF =====
    const exportExcelBtn = document.getElementById("exportExcelBtn");
    const exportPdfBtn = document.getElementById("exportPdfBtn");

    exportExcelBtn.addEventListener("click", () => {
      if (!currentSessionId) {
        alert("Select a session first.");
        return;
      }
      const sessions = loadSessions();
      const session = sessions.find((s) => s.id === currentSessionId);
      const records = loadRecords(currentSessionId);
      if (!session) return;

      const data = [
        ["JOOUST ATTENDANCE REGISTER"],
        [
          `Class: ${session.className}`,
          `Unit: ${session.unitName}`,
          `Date: ${session.date}`,
        ],
        [
          `Lecturer: ${session.lecturer}`,
          `HOD: ${session.hod || ""}`,
          `Time: ${session.startTime || ""} - ${session.endTime || ""}`,
        ],
        [],
        ["#", "Student Name", "Registration Number", "Time"],
      ];

      records.forEach((r, i) => {
        data.push([
          i + 1,
          r.name,
          r.regNo,
          new Date(r.time).toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          }),
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Attendance");
      const fileName = `JOOUST_Attendance_${session.className}_${session.unitName}_${session.date}.xlsx`;
      XLSX.writeFile(wb, fileName);
    });

    exportPdfBtn.addEventListener("click", () => {
      if (!currentSessionId) {
        alert("Select a session first.");
        return;
      }
      const sessions = loadSessions();
      const session = sessions.find((s) => s.id === currentSessionId);
      const records = loadRecords(currentSessionId);
      if (!session) return;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });

      // Logo
      const logoImg = document.getElementById("jooustLogo");
      let y = 10;

      if (logoImg && logoImg.complete) {
        try {
          doc.addImage(logoImg, "JPEG", 10, 8, 25, 25);
        } catch (e) {
          // ignore if image fails
        }
      }

      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.text("JARAMOGI OGINGA ODINGA UNIVERSITY OF SCIENCE AND TECHNOLOGY", 40, y + 6, { maxWidth: 160 });
      doc.setFontSize(12);
      doc.text("Class Attendance Register", 40, y + 14);

      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      doc.text(`Class: ${session.className}`, 10, y + 30);
      doc.text(`Unit: ${session.unitName}`, 80, y + 30);
      doc.text(`Date: ${session.date}`, 150, y + 30);

      doc.text(`Lecturer: ${session.lecturer}`, 10, y + 36);
      doc.text(`HOD: ${session.hod || ""}`, 80, y + 36);
      doc.text(`Time: ${session.startTime || ""} - ${session.endTime || ""}`, 150, y + 36);

      // Table header
      let tableY = y + 44;
      doc.setFont("helvetica", "bold");
      doc.rect(10, tableY - 4, 190, 8);
      doc.text("#", 12, tableY);
      doc.text("Student Name", 22, tableY);
      doc.text("Reg. No.", 100, tableY);
      doc.text("Time", 160, tableY);

      doc.setFont("helvetica", "normal");
      let rowY = tableY + 6;
      records.forEach((r, i) => {
        if (rowY > 260) {
          doc.addPage();
          rowY = 20;
        }
        doc.text(String(i + 1), 12, rowY);
        doc.text(r.name, 22, rowY, { maxWidth: 70 });
        doc.text(r.regNo, 100, rowY, { maxWidth: 40 });
        doc.text(
          new Date(r.time).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }),
          160,
          rowY
        );
        rowY += 6;
      });

      // Signatures
      rowY += 8;
      doc.setFont("helvetica", "bold");
      doc.text("Lecturer Signature:", 10, rowY);
      doc.text("HOD Signature:", 110, rowY);

      // Insert signature images if drawn
      rowY += 2;
      try {
        const lectData = lecturerSig.getDataURL();
        const hodData = hodSig.getDataURL();
        doc.addImage(lectData, "PNG", 10, rowY, 80, 25);
        doc.addImage(hodData, "PNG", 110, rowY, 80, 25);
      } catch (e) {
        // ignore if cannot add
      }

      const fileName = `JOOUST_Attendance_${session.className}_${session.unitName}_${session.date}.pdf`;
      doc.save(fileName);
    });

    // ===== SIMPLE STATS FOR WEEK / MONTH =====
    function updateStats() {
      const sessions = loadSessions();
      const now = new Date();
      const weekAgo = new Date(now);
      weekAgo.setDate(now.getDate() - 7);

      const monthAgo = new Date(now);
      monthAgo.setMonth(now.getMonth() - 1);

      let weekCount = 0;
      let monthCount = 0;
      sessions.forEach((s) => {
        const d = new Date(s.date || s.createdAt || now);
        if (d >= weekAgo && d <= now) weekCount++;
        if (d >= monthAgo && d <= now) monthCount++;
      });
      statWeek.textContent = weekCount.toString();
      statMonth.textContent = monthCount.toString();
    }

    // ===== REPORTS (summary text) =====
    const reportType = document.getElementById("reportType");
    const reportClassFilter = document.getElementById("reportClassFilter");
    const reportOutput = document.getElementById("reportOutput");
    const generateReportBtn = document.getElementById("generateReportBtn");

    generateReportBtn.addEventListener("click", () => {
      const type = reportType.value;
      const clsFilter = reportClassFilter.value.trim().toLowerCase();
      const sessions = loadSessions();
      const allRecords = JSON.parse(localStorage.getItem("attendanceRecords") || "{}");
      const now = new Date();
      const weekAgo = new Date(now);
      weekAgo.setDate(now.getDate() - 7);
      const monthAgo = new Date(now);
      monthAgo.setMonth(now.getMonth() - 1);

      const lines = [];

      if (!sessions.length) {
        reportOutput.textContent = "No sessions saved yet.";
        return;
      }

      if (type === "class") {
        lines.push("CLASS SUMMARY REPORT");
        if (clsFilter) lines.push(`Filter: ${clsFilter}`);
        lines.push("====================================");

        const grouped = {};
        sessions.forEach((s) => {
          if (clsFilter && !s.className.toLowerCase().includes(clsFilter)) return;
          const key = `${s.className} :: ${s.unitName}`;
          const recs = allRecords[s.id] || [];
          if (!grouped[key]) grouped[key] = { sessions: 0, attendees: 0 };
          grouped[key].sessions += 1;
          grouped[key].attendees += recs.length;
        });

        Object.entries(grouped).forEach(([key, val]) => {
          lines.push(`${key}`);
          lines.push(
            `  Sessions held: ${val.sessions} | Total attendance: ${val.attendees}`
          );
          lines.push("");
        });

        if (!Object.keys(grouped).length) lines.push("No matching classes found.");
      } else if (type === "weekly") {
        lines.push("WEEKLY SUMMARY REPORT (Last 7 Days)");
        lines.push("====================================");
        sessions.forEach((s) => {
          const d = new Date(s.date || s.createdAt || now);
          if (d < weekAgo || d > now) return;
          if (clsFilter && !s.className.toLowerCase().includes(clsFilter)) return;
          const recs = allRecords[s.id] || [];
          lines.push(
            `${s.date} | ${s.className} | ${s.unitName} -> ${recs.length} students`
          );
        });
      } else if (type === "monthly") {
        lines.push("MONTHLY SUMMARY REPORT (Last 30 Days)");
        lines.push("====================================");
        sessions.forEach((s) => {
          const d = new Date(s.date || s.createdAt || now);
          if (d < monthAgo || d > now) return;
          if (clsFilter && !s.className.toLowerCase().includes(clsFilter)) return;
          const recs = allRecords[s.id] || [];
          lines.push(
            `${s.date} | ${s.className} | ${s.unitName} -> ${recs.length} students`
          );
        });
      }

      reportOutput.textContent = lines.join("\n") || "No data for this report.";
    });

    // ===== INITIAL LOAD / MODE SWITCH (LECTURER vs STUDENT) =====
    function initMode() {
      const params = getQueryParams();
      const role = (params.role || "").toLowerCase();
      const sessionParam = params.session || null;

      if (sessionParam) {
        studentSessionId = sessionParam;
        const sessions = loadSessions();
        const target = sessions.find((s) => s.id === sessionParam);
        if (target) {
          studentSessionInfo.textContent = `You are marking attendance for: ${target.date} • ${target.className} • ${target.unitName}`;
          studentClass.value = target.className;
          studentClass.dataset.value = target.className;
          studentUnit.value = target.unitName;
          studentUnit.dataset.value = target.unitName;
        } else {
          studentSessionInfo.textContent =
            "Session not yet created on this device. Lecturer should first create the session.";
        }
      }

      if (role === "student") {
        // Student-only view (hide admin sections)
        document.getElementById("adminSection").style.display = "none";
      }
    }

    // Prefill session date with today
    document.getElementById("sessionDate").value = formatDate(new Date());

    // Startup
    updateSessionDropdown();
    updateShareLink();
    updateStats();
    initMode();
  </script>
</body>
</html>
