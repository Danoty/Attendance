<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JOOUST Attendance Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --jooust-blue:#0052cc;
      --jooust-blue-dark:#003b8c;
      --jooust-green:#24a148;
      --jooust-gold:#f2c94c;
      --bg-soft:#f4f7fb;
      --card-bg:#ffffff;
      --text-main:#1f2933;
      --text-muted:#6b7280;
      --danger:#e11d48;

      --shadow:0 10px 28px rgba(15,23,42,.10);
      --shadow2:0 18px 45px rgba(15,23,42,.16);
    }

    *{ box-sizing:border-box; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }
    body{
      margin:0;
      color:var(--text-main);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(0,82,204,.18), transparent 55%),
        radial-gradient(900px 500px at 95% 10%, rgba(36,161,72,.14), transparent 55%),
        linear-gradient(180deg, #f7fbff, var(--bg-soft));
      min-height:100vh;
    }

    header{
      background: linear-gradient(135deg, var(--jooust-blue-dark), var(--jooust-blue));
      color:#fff;
      padding:.9rem 1.4rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
      position:sticky;
      top:0;
      z-index:50;
      box-shadow:0 6px 22px rgba(0,0,0,.22);
      border-bottom: 3px solid rgba(242,201,76,.55);
    }
    header .left{
      display:flex;
      align-items:center;
      gap:1rem;
      min-width:260px;
    }
    header img{
      height:54px;
      width:auto;
      border-radius:10px;
      background:#fff;
      padding:6px;
      box-shadow:0 8px 18px rgba(0,0,0,.18);
    }
    header h1{
      margin:0;
      font-size:1.15rem;
      line-height:1.25;
      letter-spacing:.2px;
    }
    header h1 span{
      display:block;
      font-size:.82rem;
      font-weight:400;
      opacity:.92;
    }

    .header-right{
      display:flex;
      align-items:center;
      gap:.6rem;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .muted{ color:rgba(255,255,255,.85); font-size:.85rem; }

    main{
      max-width:1200px;
      margin:1.2rem auto 2.8rem;
      padding:0 1rem;
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.92));
      border-radius:16px;
      padding:1.4rem;
      margin-bottom:1rem;
      box-shadow:var(--shadow);
      border:1px solid rgba(0,82,204,.08);
    }

    h2{
      margin:.1rem 0 1rem;
      font-size:1.18rem;
      display:flex;
      align-items:center;
      gap:.55rem;
    }
    h2::before{
      content:"";
      display:inline-block;
      width:7px;
      height:22px;
      border-radius:999px;
      background:linear-gradient(180deg, var(--jooust-green), var(--jooust-gold));
      box-shadow:0 0 0 4px rgba(242,201,76,.16);
    }

    h3{ margin:.15rem 0 .6rem; font-size:1.02rem; }
    p{ margin:.35rem 0; }

    .hidden{ display:none !important; }

    label{
      font-size:.85rem;
      color:#445164;
      display:block;
      margin-bottom:.25rem;
      font-weight:600;
    }

    input, select, textarea{
      width:100%;
      padding:.62rem .72rem;
      border-radius:12px;
      border:1px solid #d1d5db;
      font-size:.92rem;
      outline:none;
      transition:border .15s ease, box-shadow .15s ease, background .15s ease;
      background:#f9fafb;
    }
    input:focus, select:focus, textarea:focus{
      border-color:var(--jooust-blue);
      box-shadow:0 0 0 3px rgba(0,82,204,.14);
      background:#fff;
    }

    .row{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(210px, 1fr));
      gap:.8rem 1rem;
      margin-bottom:.85rem;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.4rem;
      padding:.6rem 1.05rem;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:.92rem;
      font-weight:700;
      transition:transform .08s ease, box-shadow .1s ease, filter .12s ease;
      white-space:nowrap;
      user-select:none;
    }
    .btn:active{ transform:translateY(1px); box-shadow:none; }

    .btn-primary{
      background:linear-gradient(135deg, var(--jooust-blue), var(--jooust-blue-dark));
      color:#fff;
      box-shadow:0 10px 18px rgba(0,82,204,.34);
    }
    .btn-secondary{ background:#e5e7eb; color:#111827; }
    .btn-success{
      background:linear-gradient(135deg, var(--jooust-green), #16a34a);
      color:#fff;
      box-shadow:0 10px 18px rgba(22,163,74,.30);
    }
    .btn-danger{ background:var(--danger); color:#fff; box-shadow:0 10px 18px rgba(225,29,72,.22); }
    .btn-outline{
      background:transparent;
      color:#fff;
      border:1px solid rgba(255,255,255,.55);
    }
    .btn-outline:hover{ filter:brightness(1.06); }

    .btn-group{
      display:flex;
      flex-wrap:wrap;
      gap:.55rem;
      margin-top:.75rem;
    }

    .tabs{ display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:.6rem; }
    .tab{
      padding:.45rem .95rem;
      border-radius:999px;
      font-size:.9rem;
      border:1px solid #d1d5db;
      background:#f3f4f6;
      cursor:pointer;
      font-weight:700;
    }
    .tab.active{
      background:var(--jooust-blue);
      border-color:var(--jooust-blue-dark);
      color:#fff;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:.84rem;
      margin-top:.55rem;
      overflow:hidden;
      border-radius:14px;
    }
    th, td{
      border:1px solid #e5e7eb;
      padding:.5rem .5rem;
      text-align:left;
      vertical-align:top;
    }
    th{
      background:linear-gradient(180deg, #eff6ff, #eaf2ff);
      color:#1d4ed8;
      font-weight:800;
    }
    tr:nth-child(even) td{ background:#fbfdff; }

    .badge{
      padding:.15rem .55rem;
      border-radius:999px;
      font-size:.74rem;
      font-weight:800;
      background:#e5e7eb;
      display:inline-block;
    }
    .badge.open{ background:#dcfce7; color:#166534; }
    .badge.closed{ background:#fee2e2; color:#b91c1c; }

    .alert{
      padding:.65rem .85rem;
      border-radius:12px;
      font-size:.86rem;
      margin:.65rem 0;
      border:1px solid rgba(0,0,0,.05);
    }
    .alert-info{ background:#e0f2fe; color:#0b5394; border-color:rgba(14,165,233,.25); }
    .alert-danger{ background:#fee2e2; color:#991b1b; border-color:rgba(225,29,72,.22); }
    .alert-success{ background:#dcfce7; color:#166534; border-color:rgba(22,163,74,.22); }

    .signature-pad{
      border:1px dashed #94a3b8;
      border-radius:14px;
      background:#fff;
      width:100%;
      height:140px;
      cursor:crosshair;
      box-shadow:inset 0 0 0 3px rgba(0,82,204,.04);
      touch-action:none; /* IMPORTANT for phones */
    }
    .signature-actions{
      display:flex;
      justify-content:flex-end;
      gap:.4rem;
      margin-top:.35rem;
    }

    .pill-header{
      display:flex;
      align-items:flex-end;
      flex-wrap:wrap;
      justify-content:space-between;
      gap:.75rem;
      margin-bottom:.75rem;
    }
    .pill-header small{ color:var(--text-muted); font-size:.84rem; }

    .footer{
      margin-top:1.1rem;
      text-align:center;
      color:#5b6473;
      font-size:.86rem;
      padding:1rem .5rem 0;
    }
    .footer strong{ color:#0f2b57; }

    @media (max-width: 720px){
      header{ flex-direction:column; align-items:flex-start; }
      .header-right{ justify-content:flex-start; }
      header img{ height:46px; }
      .signature-pad{ height:160px; }
    }
  </style>

  <!-- Export libs -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
<header id="mainHeader">
  <div class="left">
    <img src="logo.jpg" alt="JOOUST Logo" />
    <h1>
      JOOUST Attendance System
      <span>Smart Attendance · Digital Signatures · Exports (PDF/Word/Excel/CSV)</span>
    </h1>
  </div>

  <div class="header-right">
    <div id="userSummary" class="muted"></div>
    <button id="logoutBtn" class="btn btn-outline hidden">Logout</button>
  </div>
</header>

<main>
  <!-- LOGIN -->
  <section id="loginSection" class="card">
    <h2>Login</h2>

    <div class="row">
      <div>
        <label>Login as</label>
        <div style="display:flex; gap:1rem; flex-wrap:wrap;">
          <label style="font-weight:700; color:#1f2933;">
            <input type="radio" name="loginRole" value="admin" checked />
            Admin
          </label>
          <label style="font-weight:700; color:#1f2933;">
            <input type="radio" name="loginRole" value="lecturer" />
            Lecturer
          </label>
        </div>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="loginUsername">Username</label>
        <input id="loginUsername" type="text" placeholder="Enter username" />
      </div>
      <div>
        <label for="loginPassword">Password</label>
        <input id="loginPassword" type="password" placeholder="Enter password" />
      </div>
    </div>

    <div class="btn-group">
      <button class="btn btn-primary" id="loginBtn">Login</button>
      <button class="btn btn-secondary" id="showLecturerRegistration">Register as Lecturer</button>
    </div>

    <div id="loginMessage" class="alert hidden"></div>
  </section>

  <!-- LECTURER REGISTRATION (ASSIGNMENT REMOVED) -->
  <section id="lecturerRegistrationSection" class="card hidden">
    <h2>Lecturer Registration</h2>
    <div class="alert alert-info">
      Your account will be pending until approved by the Admin.
    </div>

    <div class="row">
      <div>
        <label for="regSalutation">Salutation</label>
        <select id="regSalutation">
          <option value="Dr.">Dr.</option>
          <option value="Mr.">Mr.</option>
          <option value="Mrs.">Mrs.</option>
          <option value="Ms.">Ms.</option>
          <option value="Prof.">Prof.</option>
        </select>
      </div>
      <div>
        <label for="regFullName">Full Name</label>
        <input id="regFullName" type="text" placeholder="e.g. Dr. Jane Doe" />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="regPF">PF No / ID</label>
        <input id="regPF" type="text" placeholder="e.g. PF12345" />
      </div>
      <div>
        <label for="regUsername">Preferred Username</label>
        <input id="regUsername" type="text" placeholder="e.g. jdoe" />
      </div>
      <div>
        <label for="regPassword">Password</label>
        <input id="regPassword" type="password" />
      </div>
    </div>

    <div class="btn-group">
      <button class="btn btn-success" id="submitLecturerRegistration">Submit Registration</button>
      <button class="btn btn-secondary" id="backToLogin">Back to Login</button>
    </div>
    <div id="lecturerRegMessage" class="alert hidden"></div>
  </section>

  <!-- STUDENT VIEW -->
  <section id="studentSection" class="card hidden">
    <h2>Class Attendance – Student Sign-In</h2>
    <div id="studentClassInfo" class="alert alert-info"></div>

    <div id="studentAlreadySubmitted" class="alert alert-success hidden">
      You have already submitted attendance for this class on this device.
    </div>

    <div id="studentFormWrapper">
      <div class="row">
        <div>
          <label for="stSurname">Surname</label>
          <input id="stSurname" type="text" />
        </div>
        <div>
          <label for="stMiddleName">Middle Name</label>
          <input id="stMiddleName" type="text" />
        </div>
        <div>
          <label for="stFirstName">First Name</label>
          <input id="stFirstName" type="text" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="stAdmission">Admission Number</label>
          <input id="stAdmission" type="text" />
        </div>
      </div>

      <label>Digital Signature (finger or mouse)</label>
      <canvas id="stSignaturePad" class="signature-pad"></canvas>
      <div class="signature-actions">
        <button class="btn btn-secondary" id="stClearSignature">Clear</button>
      </div>

      <div class="btn-group">
        <button class="btn btn-success" id="stSubmit">Submit Attendance</button>
      </div>

      <div id="studentSubmitMsg" class="alert hidden" style="margin-top:.8rem;"></div>
    </div>
  </section>

  <!-- ADMIN DASHBOARD -->
  <section id="adminDashboard" class="hidden">
    <div class="card">
      <h2>Admin Dashboard</h2>
      <div class="tabs">
        <button class="tab active" data-admin-tab="lecturersTab">Lecturers</button>
        <button class="tab" data-admin-tab="facultyTab">Faculty / Course / Unit Upload</button>
        <button class="tab" data-admin-tab="classesTab">Classes</button>
        <button class="tab" data-admin-tab="reportsTab">Reports</button>
        <button class="tab" data-admin-tab="adminSettingsTab">Settings</button>
      </div>
    </div>

    <!-- Lecturers -->
    <section id="lecturersTab" class="card admin-tab">
      <div class="pill-header">
        <div>
          <h3>Lecturer Accounts</h3>
          <small>Approve registrations & manage accounts.</small>
        </div>
      </div>
      <div id="lecturersTableWrapper" class="muted">No lecturers yet.</div>
    </section>

    <!-- Faculty CSV -->
    <section id="facultyTab" class="card admin-tab hidden">
      <div class="pill-header">
        <div>
          <h3>Faculty / Course / Unit Mapping</h3>
          <small>Upload CSV to populate dropdown lists.</small>
        </div>
      </div>
      <div class="alert alert-info">
        CSV columns: <code>Faculty,Course,Unit,Year,Semester</code><br />
        Each row = one unit offering (used by dropdowns).
      </div>
      <input type="file" id="facultyCsvInput" accept=".csv" />
      <div class="btn-group">
        <button class="btn btn-primary" id="uploadFacultyCsvBtn">Upload & Save</button>
        <button class="btn btn-secondary" id="clearFacultyDataBtn">Clear All Mappings</button>
      </div>
      <div id="facultyUploadMsg" class="alert hidden"></div>

      <h3 style="margin-top:1rem;">Current Records</h3>
      <div id="facultySummary" class="muted"></div>
    </section>

    <!-- Classes -->
    <section id="classesTab" class="card admin-tab hidden">
      <div class="pill-header">
        <div>
          <h3>All Classes</h3>
          <small>Monitor all sessions and student sign-ins.</small>
        </div>
        <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
          <select id="adminClassSort">
            <option value="newest">Sort: Newest first</option>
            <option value="oldest">Sort: Oldest first</option>
            <option value="unit">Sort: By Unit</option>
            <option value="status">Sort: By Status</option>
          </select>
        </div>
      </div>
      <div id="adminClassesTableWrapper" class="muted">No classes created yet.</div>
    </section>

    <!-- Reports -->
    <section id="reportsTab" class="card admin-tab hidden">
      <h3>Reports (Class Summary)</h3>
      <p class="muted" style="margin-top:.1rem;">
        Filter easily using dropdowns, then export as PDF / Word / Excel.
      </p>

      <div class="row">
        <div>
          <label for="repFaculty">Faculty</label>
          <select id="repFaculty"></select>
        </div>
        <div>
          <label for="repCourse">Course</label>
          <select id="repCourse"></select>
        </div>
        <div>
          <label for="repUnit">Unit</label>
          <select id="repUnit"></select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="repYear">Year</label>
          <select id="repYear"></select>
        </div>
        <div>
          <label for="repSemester">Semester</label>
          <select id="repSemester"></select>
        </div>
        <div>
          <label for="repClassPick">Specific Class (optional)</label>
          <select id="repClassPick"></select>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" id="generateReportBtn">Generate Report</button>
      </div>

      <div id="reportArea" class="hidden" style="margin-top:1rem;">
        <div class="btn-group">
          <button class="btn btn-primary" id="exportPdfBtn">Download PDF</button>
          <button class="btn btn-secondary" id="exportWordBtn">Download Word</button>
          <button class="btn btn-secondary" id="exportExcelBtn">Download Excel</button>
        </div>
        <div id="reportMeta" class="muted" style="margin-top:.5rem;"></div>
        <table id="reportTable"></table>
      </div>
    </section>

    <!-- Settings -->
    <section id="adminSettingsTab" class="card admin-tab hidden">
      <h3>Admin Settings</h3>
      <p class="muted">Change admin password securely (stored locally in this demo).</p>
      <div class="row">
        <div>
          <label for="adminOldPass">Old Password</label>
          <input id="adminOldPass" type="password" />
        </div>
        <div>
          <label for="adminNewPass">New Password</label>
          <input id="adminNewPass" type="password" />
        </div>
        <div>
          <label for="adminNewPass2">Confirm New Password</label>
          <input id="adminNewPass2" type="password" />
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-success" id="adminChangePassBtn">Change Password</button>
      </div>
      <div id="adminPassMsg" class="alert hidden"></div>
    </section>
  </section>

  <!-- LECTURER DASHBOARD -->
  <section id="lecturerDashboard" class="hidden">
    <section class="card">
      <h2>Lecturer Dashboard</h2>
      <p class="muted" style="color:#46556b;">
        Create classes, share student link, view attendance, and export official reports.
      </p>

      <div class="tabs" style="margin-top:.8rem;">
        <button class="tab active" data-lec-tab="lecClassesTab">Classes</button>
        <button class="tab" data-lec-tab="lecReportsTab">Reports</button>
        <button class="tab" data-lec-tab="lecSettingsTab">Settings</button>
      </div>
    </section>

    <!-- Lecturer Classes -->
    <section id="lecClassesTab" class="card lec-tab">
      <div class="pill-header">
        <div>
          <h3>Create / Start Class</h3>
          <small>Pick from dropdowns; system generates a unique student link.</small>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="lcFaculty">Faculty</label>
          <select id="lcFaculty"></select>
        </div>
        <div>
          <label for="lcCourse">Course</label>
          <select id="lcCourse"></select>
        </div>
        <div>
          <label for="lcUnit">Unit</label>
          <select id="lcUnit"></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="lcYear">Year</label>
          <select id="lcYear"></select>
        </div>
        <div>
          <label for="lcSemester">Semester</label>
          <select id="lcSemester"></select>
        </div>
        <div>
          <label for="lcVenue">Venue</label>
          <input id="lcVenue" type="text" placeholder="e.g. LT1, Online, Lab 3" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="lcDateTime">Date & Time</label>
          <input id="lcDateTime" type="datetime-local" />
        </div>
        <div>
          <label for="lcClassStatus">Status</label>
          <select id="lcClassStatus">
            <option value="open">Open (allow students)</option>
            <option value="closed">Closed (no submissions)</option>
          </select>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-success" id="createClassBtn">Create / Start Class</button>
      </div>
      <div id="createClassMsg" class="alert hidden"></div>

      <hr style="margin:1.2rem 0; border:none; border-top:1px solid rgba(0,82,204,.12);">

      <div class="pill-header">
        <div>
          <h3>My Classes</h3>
          <small>Filter and sort for easy management.</small>
        </div>
        <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
          <select id="lecClassFilterUnit"></select>
          <select id="lecClassFilterStatus">
            <option value="">All Status</option>
            <option value="open">Open</option>
            <option value="closed">Closed</option>
          </select>
          <select id="lecClassSort">
            <option value="newest">Sort: Newest first</option>
            <option value="oldest">Sort: Oldest first</option>
            <option value="unit">Sort: By Unit</option>
          </select>
        </div>
      </div>

      <div id="lecturerClassesTableWrapper" class="muted">No classes yet.</div>
    </section>

    <!-- Lecturer Reports -->
    <section id="lecReportsTab" class="card lec-tab hidden">
      <h3>Reports (My Classes Summary)</h3>
      <p class="muted">Filter via dropdowns, then export.</p>

      <div class="row">
        <div><label for="repFacultyL">Faculty</label><select id="repFacultyL"></select></div>
        <div><label for="repCourseL">Course</label><select id="repCourseL"></select></div>
        <div><label for="repUnitL">Unit</label><select id="repUnitL"></select></div>
      </div>
      <div class="row">
        <div><label for="repYearL">Year</label><select id="repYearL"></select></div>
        <div><label for="repSemesterL">Semester</label><select id="repSemesterL"></select></div>
        <div><label for="repClassPickL">Specific Class (optional)</label><select id="repClassPickL"></select></div>
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" id="generateReportLecturerBtn">Generate My Report</button>
      </div>

      <div id="reportAreaLecturer" class="hidden" style="margin-top:1rem;">
        <div class="btn-group">
          <button class="btn btn-primary" id="exportPdfBtnL">Download PDF</button>
          <button class="btn btn-secondary" id="exportWordBtnL">Download Word</button>
          <button class="btn btn-secondary" id="exportExcelBtnL">Download Excel</button>
        </div>
        <div id="reportMetaL" class="muted" style="margin-top:.5rem;"></div>
        <table id="reportTableL"></table>
      </div>
    </section>

    <!-- Lecturer Settings -->
    <section id="lecSettingsTab" class="card lec-tab hidden">
      <h3>Lecturer Settings</h3>
      <p class="muted">Change your password.</p>
      <div class="row">
        <div>
          <label for="lecOldPass">Old Password</label>
          <input id="lecOldPass" type="password" />
        </div>
        <div>
          <label for="lecNewPass">New Password</label>
          <input id="lecNewPass" type="password" />
        </div>
        <div>
          <label for="lecNewPass2">Confirm New Password</label>
          <input id="lecNewPass2" type="password" />
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-success" id="lecChangePassBtn">Change Password</button>
      </div>
      <div id="lecPassMsg" class="alert hidden"></div>
    </section>
  </section>

  <div class="footer">
    <strong>Created by Gerotech — Dan Otieno</strong> · JOOUST Attendance Management System
  </div>
</main>

<script>
/* ========================= STORAGE ========================= */
const STORAGE_KEY = "jooust_attendance_data_v2";

function baseData(){
  return {
    admins: [{ username: "admin", password: "admin123" }],
    lecturers: [],
    facultyConfig: [],
    classes: [],
    attendance: []
  };
}
function loadData(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){ const b = baseData(); localStorage.setItem(STORAGE_KEY, JSON.stringify(b)); return b; }
  try{ return JSON.parse(raw); }
  catch(e){ console.warn("Storage corrupted, resetting", e); const b=baseData(); localStorage.setItem(STORAGE_KEY, JSON.stringify(b)); return b; }
}
function saveData(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }
let DATA = loadData();

/* ========================= SESSION ========================= */
let currentUser = null; // {role:'admin'|'lecturer', username/id}
let jooustLogoDataUrl = null;

function $(id){ return document.getElementById(id); }
function uuid(){ return Date.now().toString(36)+"-"+Math.random().toString(36).slice(2,10); }
function formatDateTime(dt){
  if(!dt) return "";
  const d = new Date(dt);
  if(isNaN(d)) return dt;
  return d.toLocaleDateString()+" "+d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
}
function setAlert(el, msg, type="info"){
  el.textContent = msg;
  el.classList.remove("hidden","alert-info","alert-danger","alert-success");
  el.classList.add(type==="danger"?"alert-danger": type==="success"?"alert-success":"alert-info");
}
function clearAlert(el){ el.classList.add("hidden"); el.textContent=""; }

function showSection(id){
  ["loginSection","lecturerRegistrationSection","adminDashboard","lecturerDashboard","studentSection"].forEach(s=>{
    const el=$(s); if(!el) return;
    el.classList.toggle("hidden", s!==id);
  });
}

function getQueryParam(name){
  const u = new URLSearchParams(window.location.search);
  return u.get(name);
}

/* ========================= LIB CHECKS ========================= */
function libsReady(){
  const pdfOK = !!(window.jspdf && window.jspdf.jsPDF);
  const xlsxOK = !!(window.XLSX && window.XLSX.utils);
  return {pdfOK, xlsxOK};
}

/* ========================= LOGO -> DATAURL ========================= */
function loadLogoAsDataUrl(){
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.src = "logo.jpg";
  img.onload = ()=>{
    const c = document.createElement("canvas");
    c.width = img.naturalWidth || img.width;
    c.height = img.naturalHeight || img.height;
    const ctx = c.getContext("2d");
    ctx.drawImage(img,0,0);
    jooustLogoDataUrl = c.toDataURL("image/jpeg", 0.92);
  };
  img.onerror = ()=>{
    console.warn("logo.jpg not loaded (PDF/Word will still work but without embedded logo).");
  };
}

/* ========================= HEADER: SUMMARY + LOGOUT ========================= */
function updateUserSummary(){
  const el = $("userSummary");
  const logoutBtn = $("logoutBtn");
  if(!currentUser){
    el.textContent = "";
    logoutBtn.classList.add("hidden");
    return;
  }
  logoutBtn.classList.remove("hidden");
  if(currentUser.role==="admin"){
    el.textContent = "Logged in as Admin";
  } else {
    const lec = DATA.lecturers.find(l=>l.id===currentUser.id);
    el.textContent = "Logged in as Lecturer: " + (lec ? (lec.salutation+" "+lec.fullName) : currentUser.username);
  }
}
$("logoutBtn").addEventListener("click", ()=>{
  currentUser = null;
  updateUserSummary();
  showSection("loginSection");
});

/* ========================= FACULTY DROPDOWNS ========================= */
function normalizeFacultyConfig(){
  DATA = loadData();
  return (DATA.facultyConfig || []).filter(r => r && r.faculty && r.course && r.unit && r.year && r.semester);
}
function uniq(arr){ return [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b)); }

function fillSelect(selectEl, items, placeholder="All / Select"){
  if(!selectEl) return;
  const current = selectEl.value;
  selectEl.innerHTML = "";
  const ph = document.createElement("option");
  ph.value = "";
  ph.textContent = placeholder;
  selectEl.appendChild(ph);
  items.forEach(v=>{
    const o=document.createElement("option");
    o.value=v; o.textContent=v;
    selectEl.appendChild(o);
  });
  // restore if still available
  if([...selectEl.options].some(o=>o.value===current)) selectEl.value=current;
}

function cascadeDropdowns(prefix){
  // expects ids: prefixFaculty, prefixCourse, prefixUnit, prefixYear, prefixSemester
  const fEl=$(prefix+"Faculty");
  const cEl=$(prefix+"Course");
  const uEl=$(prefix+"Unit");
  const yEl=$(prefix+"Year");
  const sEl=$(prefix+"Semester");

  const cfg = normalizeFacultyConfig();

  function refreshAll(){
    const faculties = uniq(cfg.map(r=>r.faculty));
    fillSelect(fEl, faculties, "Select Faculty");

    const f = fEl.value;
    const courses = uniq(cfg.filter(r=>!f || r.faculty===f).map(r=>r.course));
    fillSelect(cEl, courses, "Select Course");

    const c = cEl.value;
    const units = uniq(cfg.filter(r=>(!f||r.faculty===f) && (!c||r.course===c)).map(r=>r.unit));
    fillSelect(uEl, units, "Select Unit");

    const u = uEl.value;
    const years = uniq(cfg.filter(r=>(!f||r.faculty===f) && (!c||r.course===c) && (!u||r.unit===u)).map(r=>r.year));
    fillSelect(yEl, years, "Select Year");

    const y = yEl.value;
    const sems = uniq(cfg.filter(r=>(!f||r.faculty===f) && (!c||r.course===c) && (!u||r.unit===u) && (!y||r.year===y)).map(r=>r.semester));
    fillSelect(sEl, sems, "Select Semester");
  }

  [fEl,cEl,uEl,yEl].forEach(el=>{
    if(!el) return;
    el.addEventListener("change", refreshAll);
  });

  refreshAll();
}

/* ========================= LOGIN & REGISTRATION ========================= */
$("loginBtn").addEventListener("click", ()=>{
  const username = $("loginUsername").value.trim();
  const password = $("loginPassword").value;
  const role = document.querySelector('input[name="loginRole"]:checked').value;
  const msgEl = $("loginMessage");

  if(!username || !password){
    setAlert(msgEl, "Please enter username and password.", "danger"); return;
  }

  DATA = loadData();

  if(role==="admin"){
    const found = DATA.admins.find(a=>a.username===username && a.password===password);
    if(!found){ setAlert(msgEl, "Invalid admin credentials.", "danger"); return; }
    currentUser = {role:"admin", username};
    clearAlert(msgEl);
    showSection("adminDashboard");
    updateUserSummary();
    renderAdminLecturers();
    renderFacultySummary();
    renderAdminClasses();
    initAdminReportDropdowns();
  } else {
    const lec = DATA.lecturers.find(l=>l.username===username && l.password===password);
    if(!lec){ setAlert(msgEl, "Lecturer not found or wrong password.", "danger"); return; }
    if(!lec.approved){ setAlert(msgEl, "Your account is pending approval by Admin.", "danger"); return; }
    currentUser = {role:"lecturer", id:lec.id, username:lec.username};
    clearAlert(msgEl);
    showSection("lecturerDashboard");
    updateUserSummary();
    initLecturerDropdowns();
    renderLecturerClasses();
    initLecturerReportDropdowns();
  }
});

$("showLecturerRegistration").addEventListener("click", ()=>{
  showSection("lecturerRegistrationSection");
  clearAlert($("loginMessage"));
});
$("backToLogin").addEventListener("click", ()=>{
  showSection("loginSection");
  clearAlert($("lecturerRegMessage"));
});

$("submitLecturerRegistration").addEventListener("click", ()=>{
  const salutation = $("regSalutation").value;
  const fullName = $("regFullName").value.trim();
  const pf = $("regPF").value.trim();
  const username = $("regUsername").value.trim();
  const password = $("regPassword").value;
  const msgEl = $("lecturerRegMessage");

  if(!fullName || !pf || !username || !password){
    setAlert(msgEl, "Please fill all required fields.", "danger"); return;
  }

  DATA = loadData();
  if(DATA.lecturers.some(l=>l.username===username) || DATA.admins.some(a=>a.username===username)){
    setAlert(msgEl, "Username already exists.", "danger"); return;
  }

  const lecturer = { id: uuid(), salutation, fullName, pf, username, password, approved:false };
  DATA.lecturers.push(lecturer);
  saveData(DATA);

  setAlert(msgEl, "Registration submitted. Wait for admin approval.", "success");
  $("regFullName").value = $("regPF").value = $("regUsername").value = $("regPassword").value = "";
});

/* ========================= ADMIN: LECTURERS ========================= */
function renderAdminLecturers(){
  const wrapper = $("lecturersTableWrapper");
  DATA = loadData();

  if(!DATA.lecturers.length){
    wrapper.textContent = "No lecturers registered yet.";
    return;
  }

  let html = `<table><thead><tr>
    <th>Lecturer</th><th>PF/ID</th><th>Username</th><th>Status</th><th>Actions</th>
  </tr></thead><tbody>`;

  DATA.lecturers.forEach(lec=>{
    const status = lec.approved ? `<span class="badge open">Approved</span>` : `<span class="badge closed">Pending</span>`;
    html += `<tr>
      <td>${lec.salutation} ${lec.fullName}</td>
      <td>${lec.pf}</td>
      <td>${lec.username}</td>
      <td>${status}</td>
      <td>
        ${
          lec.approved
          ? `<button class="btn btn-secondary" data-action="toggle-approve" data-id="${lec.id}">Revoke</button>`
          : `<button class="btn btn-success" data-action="toggle-approve" data-id="${lec.id}">Approve</button>`
        }
      </td>
    </tr>`;
  });

  html += `</tbody></table>`;
  wrapper.innerHTML = html;

  wrapper.querySelectorAll("button[data-action='toggle-approve']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      DATA = loadData();
      const id = btn.getAttribute("data-id");
      const lec = DATA.lecturers.find(l=>l.id===id);
      if(!lec) return;
      lec.approved = !lec.approved;
      saveData(DATA);
      renderAdminLecturers();
    });
  });
}

/* ========================= ADMIN: CHANGE PASSWORD ========================= */
$("adminChangePassBtn").addEventListener("click", ()=>{
  const oldP = $("adminOldPass").value;
  const newP = $("adminNewPass").value;
  const newP2 = $("adminNewPass2").value;
  const msgEl = $("adminPassMsg");

  if(!currentUser || currentUser.role!=="admin"){ setAlert(msgEl, "You must be logged in as admin.", "danger"); return; }
  if(!oldP || !newP || !newP2){ setAlert(msgEl, "Fill all password fields.", "danger"); return; }
  if(newP !== newP2){ setAlert(msgEl, "New passwords do not match.", "danger"); return; }

  DATA = loadData();
  const admin = DATA.admins.find(a=>a.username===currentUser.username);
  if(!admin || admin.password!==oldP){ setAlert(msgEl, "Old password is incorrect.", "danger"); return; }
  admin.password = newP;
  saveData(DATA);

  setAlert(msgEl, "Admin password changed successfully.", "success");
  $("adminOldPass").value = $("adminNewPass").value = $("adminNewPass2").value = "";
});

/* ========================= ADMIN: FACULTY CSV UPLOAD ========================= */
$("uploadFacultyCsvBtn").addEventListener("click", ()=>{
  const fileInput = $("facultyCsvInput");
  const msgEl = $("facultyUploadMsg");
  const file = fileInput.files[0];
  if(!file){ setAlert(msgEl, "Select a CSV file first.", "danger"); return; }

  const reader = new FileReader();
  reader.onload = (e)=>{
    const text = e.target.result || "";
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const records = [];

    for(const line of lines){
      const parts = line.split(",").map(p=>p.trim());
      if(parts.length < 5) continue;
      const [faculty, course, unit, year, semester] = parts;
      if(!faculty || !course || !unit || !year || !semester) continue;
      records.push({faculty, course, unit, year, semester});
    }

    DATA = loadData();
    DATA.facultyConfig = records;
    saveData(DATA);

    setAlert(msgEl, `Uploaded ${records.length} entries successfully.`, "success");
    renderFacultySummary();
    // refresh dropdowns
    initAdminReportDropdowns();
    if(currentUser && currentUser.role==="lecturer"){
      initLecturerDropdowns();
      initLecturerReportDropdowns();
    }
  };
  reader.readAsText(file);
});

$("clearFacultyDataBtn").addEventListener("click", ()=>{
  const msgEl = $("facultyUploadMsg");
  if(!confirm("Clear all existing faculty/course/unit mappings?")) return;
  DATA = loadData();
  DATA.facultyConfig = [];
  saveData(DATA);
  setAlert(msgEl, "All mappings cleared.", "success");
  renderFacultySummary();
  initAdminReportDropdowns();
});

function renderFacultySummary(){
  const wrap = $("facultySummary");
  DATA = loadData();
  const cfg = normalizeFacultyConfig();
  if(!cfg.length){ wrap.textContent = "No mappings uploaded yet."; return; }
  const faculties = uniq(cfg.map(r=>r.faculty));
  wrap.innerHTML = `
    <div class="alert alert-success" style="margin:0;">
      Total entries: <strong>${cfg.length}</strong><br>
      Faculties: <strong>${faculties.join(", ")}</strong>
    </div>
  `;
}

/* ========================= LECTURER: DROPDOWNS INIT ========================= */
function initLecturerDropdowns(){
  cascadeDropdowns("lc"); // lcFaculty lcCourse lcUnit lcYear lcSemester
  // Unit filter dropdown for classes table
  const cfg = normalizeFacultyConfig();
  const units = uniq(cfg.map(r=>r.unit));
  fillSelect($("lecClassFilterUnit"), units, "All Units");
}

/* ========================= REPORT DROPDOWNS (ADMIN / LECT) ========================= */
function initAdminReportDropdowns(){
  cascadeDropdowns("rep"); // repFaculty repCourse repUnit repYear repSemester
  refreshClassPick("repClassPick", null); // all classes
}
function initLecturerReportDropdowns(){
  cascadeDropdowns("repL"); // repFacultyL repCourseL repUnitL repYearL repSemesterL
  refreshClassPick("repClassPickL", currentUser?.id || null);
}

function refreshClassPick(selectId, lecturerId=null){
  const sel = $(selectId);
  if(!sel) return;
  DATA = loadData();
  let classes = DATA.classes || [];
  if(lecturerId) classes = classes.filter(c=>c.lecturerId===lecturerId);
  // newest first
  classes.sort((a,b)=> new Date(b.dateTime||0) - new Date(a.dateTime||0));
  sel.innerHTML = "";
  const ph = document.createElement("option");
  ph.value = "";
  ph.textContent = "All Classes";
  sel.appendChild(ph);
  classes.forEach(c=>{
    const o = document.createElement("option");
    o.value = c.id;
    o.textContent = `${c.unit} · ${c.venue} · ${formatDateTime(c.dateTime)} · (${c.status})`;
    sel.appendChild(o);
  });
}

/* ========================= CLASS CREATION (LECTURER) ========================= */
$("createClassBtn").addEventListener("click", ()=>{
  const msgEl = $("createClassMsg");

  if(!currentUser || currentUser.role!=="lecturer"){
    setAlert(msgEl, "You must be logged in as lecturer to create classes.", "danger"); return;
  }

  const f = $("lcFaculty").value;
  const c = $("lcCourse").value;
  const u = $("lcUnit").value;
  const y = $("lcYear").value;
  const s = $("lcSemester").value;

  const v = $("lcVenue").value.trim();
  const dt = $("lcDateTime").value;
  const status = $("lcClassStatus").value;

  if(!f || !c || !u || !y || !s || !v || !dt){
    setAlert(msgEl, "Please select Faculty/Course/Unit/Year/Semester and fill Venue + Date/Time.", "danger"); return;
  }

  DATA = loadData();
  const lec = DATA.lecturers.find(l=>l.id===currentUser.id);
  if(!lec){ setAlert(msgEl, "Lecturer not found.", "danger"); return; }

  const classId = uuid();
  const cls = {
    id: classId,
    lecturerId: lec.id,
    faculty: f, course: c, unit: u, year: y, semester: s,
    venue: v,
    dateTime: dt,
    status: status || "open",
    lecturerName: lec.salutation+" "+lec.fullName,
    lecturerSignature: null,
    hodName: "",
    hodSignature: null
  };
  DATA.classes.push(cls);
  saveData(DATA);

  renderLecturerClasses();
  refreshClassPick("repClassPickL", currentUser.id);
  refreshClassPick("repClassPick", null);

  const link = window.location.origin + window.location.pathname + "?mode=student&classId=" + encodeURIComponent(classId);
  setAlert(msgEl, "Class created. Share this link with students:\n" + link, "success");
});

/* ========================= CLASS LISTS (LECTURER / ADMIN) ========================= */
function renderLecturerClasses(){
  const wrap = $("lecturerClassesTableWrapper");
  DATA = loadData();
  if(!currentUser || currentUser.role!=="lecturer"){ wrap.textContent="Not logged in."; return; }

  let my = (DATA.classes||[]).filter(c=>c.lecturerId===currentUser.id);

  // filters
  const unitFilter = $("lecClassFilterUnit").value;
  const statusFilter = $("lecClassFilterStatus").value;
  if(unitFilter) my = my.filter(c=>c.unit===unitFilter);
  if(statusFilter) my = my.filter(c=>c.status===statusFilter);

  // sort
  const sort = $("lecClassSort").value;
  if(sort==="oldest") my.sort((a,b)=> new Date(a.dateTime||0)-new Date(b.dateTime||0));
  else if(sort==="unit") my.sort((a,b)=>(a.unit||"").localeCompare(b.unit||""));
  else my.sort((a,b)=> new Date(b.dateTime||0)-new Date(a.dateTime||0));

  if(!my.length){ wrap.textContent="No classes found (try changing filters)."; return; }

  let html = `<table><thead><tr>
    <th>Class</th><th>Venue / Date</th><th>Status</th><th>Attendance</th><th>Actions</th>
  </tr></thead><tbody>`;

  my.forEach(cls=>{
    const att = (DATA.attendance||[]).filter(a=>a.classId===cls.id);
    const statusBadge = cls.status==="open" ? `<span class="badge open">Open</span>` : `<span class="badge closed">Closed</span>`;
    html += `<tr>
      <td>
        <strong>${cls.unit}</strong><br>
        <span style="color:#55657a;">${cls.course}</span><br>
        <span style="color:#6b7280;">${cls.faculty} · ${cls.year} · ${cls.semester}</span>
      </td>
      <td>
        <strong>${cls.venue}</strong><br>
        <span style="color:#6b7280;">${formatDateTime(cls.dateTime)}</span>
      </td>
      <td>${statusBadge}</td>
      <td><strong>${att.length}</strong> student(s)</td>
      <td style="display:flex; gap:.45rem; flex-wrap:wrap;">
        <button class="btn btn-secondary" data-action="copy-link" data-id="${cls.id}">Copy Link</button>
        ${
          cls.status==="open"
          ? `<button class="btn btn-danger" data-action="close" data-id="${cls.id}">End</button>`
          : `<button class="btn btn-success" data-action="open" data-id="${cls.id}">Re-open</button>`
        }
        <button class="btn btn-primary" data-action="view" data-id="${cls.id}">View / Export</button>
      </td>
    </tr>`;
  });

  html += `</tbody></table>`;
  wrap.innerHTML = html;

  wrap.querySelectorAll("button[data-action]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const action = btn.getAttribute("data-action");
      const id = btn.getAttribute("data-id");

      if(action==="copy-link"){
        const link = window.location.origin + window.location.pathname + "?mode=student&classId=" + encodeURIComponent(id);
        navigator.clipboard.writeText(link).then(()=> alert("Link copied:\n"+link)).catch(()=> alert("Copy failed. Link:\n"+link));
      }
      if(action==="close" || action==="open"){
        DATA = loadData();
        const cls = DATA.classes.find(c=>c.id===id);
        if(!cls) return;
        cls.status = (action==="close") ? "closed" : "open";
        saveData(DATA);
        renderLecturerClasses();
        refreshClassPick("repClassPickL", currentUser.id);
        refreshClassPick("repClassPick", null);
      }
      if(action==="view"){
        openClassDetailDialog(id, "lecturer");
      }
    });
  });
}

function renderAdminClasses(){
  const wrap = $("adminClassesTableWrapper");
  DATA = loadData();
  let classes = [...(DATA.classes||[])];

  if(!classes.length){ wrap.textContent="No classes created yet."; return; }

  const sort = $("adminClassSort").value;
  if(sort==="oldest") classes.sort((a,b)=> new Date(a.dateTime||0)-new Date(b.dateTime||0));
  else if(sort==="unit") classes.sort((a,b)=>(a.unit||"").localeCompare(b.unit||""));
  else if(sort==="status") classes.sort((a,b)=>(a.status||"").localeCompare(b.status||""));
  else classes.sort((a,b)=> new Date(b.dateTime||0)-new Date(a.dateTime||0));

  let html = `<table><thead><tr>
    <th>Class</th><th>Lecturer</th><th>Venue / Date</th><th>Status</th><th>Attendance</th><th>Actions</th>
  </tr></thead><tbody>`;

  classes.forEach(cls=>{
    const att = (DATA.attendance||[]).filter(a=>a.classId===cls.id);
    const statusBadge = cls.status==="open" ? `<span class="badge open">Open</span>` : `<span class="badge closed">Closed</span>`;
    const lec = DATA.lecturers.find(l=>l.id===cls.lecturerId) || {};
    html += `<tr>
      <td>
        <strong>${cls.unit}</strong><br>
        <span style="color:#55657a;">${cls.course}</span><br>
        <span style="color:#6b7280;">${cls.faculty} · ${cls.year} · ${cls.semester}</span>
      </td>
      <td>${(lec.salutation||"")} ${(lec.fullName||"")}</td>
      <td><strong>${cls.venue}</strong><br><span style="color:#6b7280;">${formatDateTime(cls.dateTime)}</span></td>
      <td>${statusBadge}</td>
      <td><strong>${att.length}</strong></td>
      <td><button class="btn btn-primary" data-action="view" data-id="${cls.id}">View / Export</button></td>
    </tr>`;
  });

  html += `</tbody></table>`;
  wrap.innerHTML = html;

  wrap.querySelectorAll("button[data-action='view']").forEach(btn=>{
    btn.addEventListener("click", ()=> openClassDetailDialog(btn.getAttribute("data-id"), "admin"));
  });
}
$("adminClassSort").addEventListener("change", renderAdminClasses);

/* ========================= CLASS DETAIL (VIEW + EXPORT RAW) ========================= */
function openClassDetailDialog(classId, callerRole){
  DATA = loadData();
  const cls = DATA.classes.find(c=>c.id===classId);
  if(!cls){ alert("Class not found."); return; }
  const att = (DATA.attendance||[]).filter(a=>a.classId===cls.id);

  const overlay = document.createElement("div");
  overlay.style.position="fixed";
  overlay.style.inset="0";
  overlay.style.background="rgba(15,23,42,.62)";
  overlay.style.display="flex";
  overlay.style.alignItems="center";
  overlay.style.justifyContent="center";
  overlay.style.zIndex="9999";

  const card = document.createElement("div");
  card.className="card";
  card.style.maxWidth="980px";
  card.style.maxHeight="90vh";
  card.style.overflow="auto";
  card.style.width="95%";
  card.style.position="relative";
  card.style.boxShadow="var(--shadow2)";

  const link = window.location.origin + window.location.pathname + "?mode=student&classId=" + encodeURIComponent(cls.id);

  card.innerHTML = `
    <h2>Class Details & Student Attendance</h2>

    <div class="alert alert-info" style="white-space:pre-wrap;">
      <strong>${cls.unit}</strong> · ${cls.course}
      \n${cls.faculty} · ${cls.year} · ${cls.semester}
      \nVenue: <strong>${cls.venue}</strong> · Date/Time: <strong>${formatDateTime(cls.dateTime)}</strong>
      \nStatus: <strong>${cls.status}</strong>
      \nStudent Link: ${link}
    </div>

    <div class="pill-header">
      <div>
        <h3>Attendance List (${att.length})</h3>
        <small>Includes signatures; use exports below.</small>
      </div>
      <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
        <button class="btn btn-secondary" id="dlgCopyLink">Copy Link</button>
        <button class="btn btn-primary" id="dlgExportPDF">Export PDF</button>
        <button class="btn btn-secondary" id="dlgExportWord">Export Word</button>
        <button class="btn btn-secondary" id="dlgExportExcel">Export Excel</button>
        <button class="btn btn-secondary" id="dlgExportCSV">Export CSV</button>
      </div>
    </div>

    ${
      att.length ? `
      <table>
        <thead>
          <tr>
            <th>#</th><th>Admission No</th><th>Surname</th><th>Middle</th><th>First</th><th>Timestamp</th><th>Signature</th>
          </tr>
        </thead>
        <tbody>
          ${att.map((a,i)=>`
            <tr>
              <td>${i+1}</td>
              <td>${escapeHtml(a.admission)}</td>
              <td>${escapeHtml(a.surname)}</td>
              <td>${escapeHtml(a.middle||"")}</td>
              <td>${escapeHtml(a.first)}</td>
              <td>${formatDateTime(a.createdAt)}</td>
              <td><button class="btn btn-secondary" data-sig="${a.signature || ""}" data-action="viewSig">View</button></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
      ` : `<p style="color:#6b7280;">No students have signed yet.</p>`
    }

    <hr style="margin:1.1rem 0; border:none; border-top:1px solid rgba(0,82,204,.12);">

    <h3>Lecturer Confirmation</h3>
    <div class="row">
      <div>
        <label>Lecturer Name</label>
        <input id="dlgLecturerName" type="text" value="${escapeHtml(cls.lecturerName||"")}" />
      </div>
    </div>
    <label>Lecturer Signature</label>
    <canvas id="dlgLecturerSig" class="signature-pad"></canvas>
    <div class="signature-actions">
      <button class="btn btn-secondary" id="dlgLecturerClear">Clear</button>
    </div>

    <h3 style="margin-top:1rem;">HOD Approval</h3>
    <div class="row">
      <div>
        <label>HOD Name</label>
        <input id="dlgHodName" type="text" value="${escapeHtml(cls.hodName||"")}" />
      </div>
    </div>
    <label>HOD Signature</label>
    <canvas id="dlgHodSig" class="signature-pad"></canvas>
    <div class="signature-actions">
      <button class="btn btn-secondary" id="dlgHodClear">Clear</button>
    </div>

    <div class="btn-group">
      <button class="btn btn-success" id="dlgSave">Save Signatures</button>
      <button class="btn btn-secondary" id="dlgClose">Close</button>
    </div>

    <div id="dlgMsg" class="alert hidden"></div>
  `;

  overlay.appendChild(card);
  document.body.appendChild(overlay);

  // signature preview
  card.querySelectorAll("button[data-action='viewSig']").forEach(b=>{
    b.addEventListener("click", ()=>{
      const sig = b.getAttribute("data-sig");
      if(!sig){ alert("No signature saved."); return; }
      const win = window.open("", "_blank");
      win.document.write(`<title>Signature</title><img src="${sig}" style="max-width:100%;height:auto;" />`);
    });
  });

  card.querySelector("#dlgCopyLink").onclick = ()=>{
    navigator.clipboard.writeText(link).then(()=> alert("Link copied:\n"+link)).catch(()=> alert("Copy failed. Link:\n"+link));
  };

  // init signature canvases
  const lecSig = initSignatureCanvas(card.querySelector("#dlgLecturerSig"), cls.lecturerSignature);
  const hodSig = initSignatureCanvas(card.querySelector("#dlgHodSig"), cls.hodSignature);

  card.querySelector("#dlgLecturerClear").onclick = ()=> lecSig.clear();
  card.querySelector("#dlgHodClear").onclick = ()=> hodSig.clear();

  card.querySelector("#dlgSave").onclick = ()=>{
    DATA = loadData();
    const cls2 = DATA.classes.find(c=>c.id===classId);
    if(!cls2) return;

    const lecName = card.querySelector("#dlgLecturerName").value.trim();
    const hodName = card.querySelector("#dlgHodName").value.trim();
    cls2.lecturerName = lecName;
    cls2.hodName = hodName;

    if(callerRole==="lecturer" || callerRole==="admin") cls2.lecturerSignature = lecSig.getDataUrl();
    if(callerRole==="admin") cls2.hodSignature = hodSig.getDataUrl();
    else if(callerRole==="lecturer" && hodName) cls2.hodSignature = hodSig.getDataUrl();

    saveData(DATA);
    setAlert(card.querySelector("#dlgMsg"), "Signatures saved.", "success");

    // refresh lists
    if(currentUser?.role==="lecturer") renderLecturerClasses();
    if(currentUser?.role==="admin") renderAdminClasses();
  };

  card.querySelector("#dlgClose").onclick = ()=> overlay.remove();

  // exports
  card.querySelector("#dlgExportCSV").onclick = ()=> exportClassAttendanceCSV(cls, att);
  card.querySelector("#dlgExportExcel").onclick = ()=> exportClassAttendanceExcel(cls, att);
  card.querySelector("#dlgExportWord").onclick = ()=> exportClassAttendanceWord(cls, att);
  card.querySelector("#dlgExportPDF").onclick = ()=> exportClassAttendancePDF(cls, att);
}

/* ========================= SIGNATURE CANVAS (PHONE SAFE) ========================= */
function initSignatureCanvas(canvas, existingDataUrl=null){
  const ctx = canvas.getContext("2d");
  ctx.lineWidth = 2;
  ctx.lineCap = "round";

  function resize(){
    const ratio = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(1, Math.floor(rect.width * ratio));
    canvas.height = Math.max(1, Math.floor(rect.height * ratio));
    ctx.setTransform(ratio,0,0,ratio,0,0);
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    if(existingDataUrl){
      const img = new Image();
      img.onload = ()=> ctx.drawImage(img, 0, 0, rect.width, rect.height);
      img.src = existingDataUrl;
      existingDataUrl = null; // only once
    }
  }
  resize();
  window.addEventListener("resize", resize);

  let drawing = false;

  function getPos(e){
    const r = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: clientX - r.left, y: clientY - r.top };
  }

  function start(e){
    e.preventDefault();
    drawing = true;
    const p = getPos(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
  }
  function move(e){
    if(!drawing) return;
    e.preventDefault();
    const p = getPos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
  }
  function end(){ drawing = false; }

  canvas.addEventListener("pointerdown", start);
  canvas.addEventListener("pointermove", move);
  canvas.addEventListener("pointerup", end);
  canvas.addEventListener("pointercancel", end);

  // backup for older browsers
  canvas.addEventListener("touchstart", start, {passive:false});
  canvas.addEventListener("touchmove", move, {passive:false});
  canvas.addEventListener("touchend", end);

  return {
    clear: ()=> ctx.clearRect(0,0,canvas.width,canvas.height),
    getDataUrl: ()=> canvas.toDataURL("image/png")
  };
}

/* ========================= STUDENT VIEW ========================= */
function setupStudentView(){
  const mode = getQueryParam("mode");
  const classId = getQueryParam("classId");
  if(mode!=="student" || !classId) return;

  showSection("studentSection");
  $("logoutBtn").classList.add("hidden");
  $("userSummary").textContent = "";

  DATA = loadData();
  const cls = DATA.classes.find(c=>c.id===classId);
  const infoEl = $("studentClassInfo");

  if(!cls){
    infoEl.textContent = "Class not found. Check the link.";
    return;
  }

  infoEl.innerHTML = `
    <strong>${escapeHtml(cls.unit)}</strong> – ${escapeHtml(cls.course)}<br>
    Faculty: <strong>${escapeHtml(cls.faculty)}</strong> · Year: <strong>${escapeHtml(cls.year)}</strong> · Semester: <strong>${escapeHtml(cls.semester)}</strong><br>
    Venue: <strong>${escapeHtml(cls.venue)}</strong> · Date & Time: <strong>${formatDateTime(cls.dateTime)}</strong><br>
    Lecturer: <strong>${escapeHtml(cls.lecturerName || "N/A")}</strong>
  `;

  if(cls.status!=="open"){
    setAlert($("studentSubmitMsg"), "This class has been closed. Attendance link is not active.", "danger");
    $("studentFormWrapper").classList.add("hidden");
    return;
  }

  const deviceKey = "cls_submitted_" + classId;
  if(localStorage.getItem(deviceKey)){
    $("studentAlreadySubmitted").classList.remove("hidden");
  }

  const pad = initSignatureCanvas($("stSignaturePad"));
  $("stClearSignature").addEventListener("click", ()=> pad.clear());

  $("stSubmit").addEventListener("click", ()=>{
    const surname = $("stSurname").value.trim();
    const middle = $("stMiddleName").value.trim();
    const first = $("stFirstName").value.trim();
    const adm = $("stAdmission").value.trim();
    const msgEl = $("studentSubmitMsg");

    if(!surname || !first || !adm){
      setAlert(msgEl, "Surname, First Name and Admission are required.", "danger"); return;
    }

    DATA = loadData();
    const cls2 = DATA.classes.find(c=>c.id===classId);
    if(!cls2 || cls2.status!=="open"){
      setAlert(msgEl, "Class is not open.", "danger"); return;
    }

    const existing = DATA.attendance.find(a=>a.classId===classId && a.admission===adm);
    if(existing){
      setAlert(msgEl, "Attendance for this admission number already exists.", "danger"); return;
    }

    const sigDataUrl = pad.getDataUrl();
    const rec = {
      id: uuid(),
      classId,
      surname,
      middle,
      first,
      admission: adm,
      signature: sigDataUrl,
      createdAt: new Date().toISOString()
    };

    DATA.attendance.push(rec);
    saveData(DATA);

    localStorage.setItem(deviceKey, adm);
    setAlert(msgEl, "Attendance submitted successfully.", "success");
    $("studentFormWrapper").classList.add("hidden");
    $("studentAlreadySubmitted").classList.remove("hidden");
  });
}

/* ========================= REPORTING (SUMMARY) ========================= */
function buildReportRows({faculty, course, unit, year, semester, classId, lecturerOnlyId=null}){
  DATA = loadData();
  let classes = DATA.classes || [];

  if(lecturerOnlyId) classes = classes.filter(c=>c.lecturerId===lecturerOnlyId);
  if(classId) classes = classes.filter(c=>c.id===classId);

  classes = classes.filter(c=>{
    if(faculty && c.faculty!==faculty) return false;
    if(course && c.course!==course) return false;
    if(unit && c.unit!==unit) return false;
    if(year && c.year!==year) return false;
    if(semester && c.semester!==semester) return false;
    return true;
  });

  // newest first
  classes.sort((a,b)=> new Date(b.dateTime||0)-new Date(a.dateTime||0));

  return classes.map(cls=>{
    const count = (DATA.attendance||[]).filter(a=>a.classId===cls.id).length;
    return {
      classId: cls.id,
      faculty: cls.faculty,
      course: cls.course,
      unit: cls.unit,
      year: cls.year,
      semester: cls.semester,
      venue: cls.venue,
      dateTime: formatDateTime(cls.dateTime),
      lecturer: cls.lecturerName || "",
      students: count,
      status: cls.status
    };
  });
}

function renderReportTable(rows, tableEl){
  if(!rows.length){
    tableEl.innerHTML = "<tbody><tr><td>No records found.</td></tr></tbody>";
    return;
  }
  let html = `
    <thead>
      <tr>
        <th>#</th><th>Faculty</th><th>Course</th><th>Unit</th><th>Year</th><th>Sem</th>
        <th>Venue</th><th>Date/Time</th><th>Lecturer</th><th>Students</th><th>Status</th>
      </tr>
    </thead>
    <tbody>
  `;
  rows.forEach((r,i)=>{
    html += `
      <tr>
        <td>${i+1}</td>
        <td>${escapeHtml(r.faculty)}</td>
        <td>${escapeHtml(r.course)}</td>
        <td>${escapeHtml(r.unit)}</td>
        <td>${escapeHtml(r.year)}</td>
        <td>${escapeHtml(r.semester)}</td>
        <td>${escapeHtml(r.venue)}</td>
        <td>${escapeHtml(r.dateTime)}</td>
        <td>${escapeHtml(r.lecturer)}</td>
        <td><strong>${r.students}</strong></td>
        <td>${escapeHtml(r.status)}</td>
      </tr>
    `;
  });
  html += "</tbody>";
  tableEl.innerHTML = html;
}

$("generateReportBtn").addEventListener("click", ()=>{
  const rows = buildReportRows({
    faculty: $("repFaculty").value,
    course: $("repCourse").value,
    unit: $("repUnit").value,
    year: $("repYear").value,
    semester: $("repSemester").value,
    classId: $("repClassPick").value || null
  });
  renderReportTable(rows, $("reportTable"));
  $("reportArea").classList.remove("hidden");
  $("reportMeta").textContent = `Total classes found: ${rows.length}`;
  $("reportTable").dataset.rows = JSON.stringify(rows);
});

$("generateReportLecturerBtn").addEventListener("click", ()=>{
  if(!currentUser || currentUser.role!=="lecturer") return;
  const rows = buildReportRows({
    faculty: $("repFacultyL").value,
    course: $("repCourseL").value,
    unit: $("repUnitL").value,
    year: $("repYearL").value,
    semester: $("repSemesterL").value,
    classId: $("repClassPickL").value || null,
    lecturerOnlyId: currentUser.id
  });
  renderReportTable(rows, $("reportTableL"));
  $("reportAreaLecturer").classList.remove("hidden");
  $("reportMetaL").textContent = `Total classes found: ${rows.length}`;
  $("reportTableL").dataset.rows = JSON.stringify(rows);
});

/* ========================= EXPORT: SUMMARY (PDF/WORD/EXCEL) ========================= */
function exportSummaryPDF(rows, title){
  const {pdfOK} = libsReady();
  if(!pdfOK){ alert("PDF library not loaded. Check internet or CDN access."); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("l","pt","a4");
  const margin = 40;

  if(jooustLogoDataUrl){
    doc.addImage(jooustLogoDataUrl,"JPEG", margin, 18, 80, 60);
  }
  doc.setFontSize(15);
  doc.setTextColor(0,82,204);
  doc.text("Jaramogi Oginga Odinga University of Science & Technology", 140, 40);
  doc.setFontSize(11);
  doc.setTextColor(31,41,55);
  doc.text(title, 140, 58);

  const body = rows.map((r,i)=>[
    i+1, r.faculty, r.course, r.unit, r.year, r.semester, r.venue, r.dateTime, r.lecturer, r.students, r.status
  ]);

  doc.autoTable({
    startY: 90,
    head:[["#","Faculty","Course","Unit","Year","Sem","Venue","Date/Time","Lecturer","Students","Status"]],
    body,
    styles:{fontSize:8},
    headStyles:{fillColor:[0,82,204], textColor:255}
  });

  doc.setFontSize(9);
  doc.setTextColor(90);
  doc.text("Created by Gerotech — Dan Otieno", margin, doc.internal.pageSize.getHeight()-18);

  doc.save("jooust-attendance-summary.pdf");
}

function exportSummaryWord(rows, title){
  const dateStr = new Date().toLocaleString();
  const logoHtml = jooustLogoDataUrl
    ? `<img src="${jooustLogoDataUrl}" style="height:60px;" />`
    : `<div style="font-weight:800;color:#0052cc;">JOOUST</div>`;

  const tableRows = rows.map((r,i)=>`
    <tr>
      <td>${i+1}</td><td>${esc(r.faculty)}</td><td>${esc(r.course)}</td><td>${esc(r.unit)}</td>
      <td>${esc(r.year)}</td><td>${esc(r.semester)}</td><td>${esc(r.venue)}</td><td>${esc(r.dateTime)}</td>
      <td>${esc(r.lecturer)}</td><td>${r.students}</td><td>${esc(r.status)}</td>
    </tr>
  `).join("");

  const html = `
  <html><head><meta charset="UTF-8"></head><body>
    <div style="display:flex;align-items:center;gap:14px;">
      ${logoHtml}
      <div>
        <h2 style="margin:0;color:#0052cc;">Jaramogi Oginga Odinga University of Science & Technology</h2>
        <div style="margin:0;font-size:12px;color:#444;">${esc(title)}</div>
        <div style="margin:0;font-size:11px;color:#666;">Generated: ${esc(dateStr)}</div>
      </div>
    </div>
    <hr/>
    <table border="1" cellspacing="0" cellpadding="5" style="border-collapse:collapse;width:100%;font-size:11px;">
      <thead>
        <tr style="background:#eff6ff;color:#1d4ed8;">
          <th>#</th><th>Faculty</th><th>Course</th><th>Unit</th><th>Year</th><th>Sem</th>
          <th>Venue</th><th>Date/Time</th><th>Lecturer</th><th>Students</th><th>Status</th>
        </tr>
      </thead>
      <tbody>
        ${tableRows || "<tr><td colspan='11'>No records.</td></tr>"}
      </tbody>
    </table>
    <p style="margin-top:12px;color:#555;font-size:11px;"><strong>Created by Gerotech — Dan Otieno</strong></p>
  </body></html>`;

  const blob = new Blob(["\ufeff", html], {type:"application/msword"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "jooust-attendance-summary.doc";
  a.click();
  URL.revokeObjectURL(url);
}

function exportSummaryExcel(rows){
  const {xlsxOK} = libsReady();
  if(!xlsxOK){ alert("Excel library not loaded. Check internet or CDN access."); return; }
  const wsData = [["#","Faculty","Course","Unit","Year","Sem","Venue","Date/Time","Lecturer","Students","Status"]];
  rows.forEach((r,i)=> wsData.push([i+1,r.faculty,r.course,r.unit,r.year,r.semester,r.venue,r.dateTime,r.lecturer,r.students,r.status]));
  const wb = XLSX.utils.book_new();
  wb.Props = {Title:"JOOUST Attendance Summary", Subject:"Attendance", Author:"Gerotech — Dan Otieno"};
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "Summary");
  XLSX.writeFile(wb, "jooust-attendance-summary.xlsx");
}

$("exportPdfBtn").addEventListener("click", ()=>{
  const rows = JSON.parse($("reportTable").dataset.rows || "[]");
  exportSummaryPDF(rows, "Attendance Summary Report (Admin)");
});
$("exportWordBtn").addEventListener("click", ()=>{
  const rows = JSON.parse($("reportTable").dataset.rows || "[]");
  exportSummaryWord(rows, "Attendance Summary Report (Admin)");
});
$("exportExcelBtn").addEventListener("click", ()=>{
  const rows = JSON.parse($("reportTable").dataset.rows || "[]");
  exportSummaryExcel(rows);
});

$("exportPdfBtnL").addEventListener("click", ()=>{
  const rows = JSON.parse($("reportTableL").dataset.rows || "[]");
  exportSummaryPDF(rows, "Attendance Summary Report (Lecturer)");
});
$("exportWordBtnL").addEventListener("click", ()=>{
  const rows = JSON.parse($("reportTableL").dataset.rows || "[]");
  exportSummaryWord(rows, "Attendance Summary Report (Lecturer)");
});
$("exportExcelBtnL").addEventListener("click", ()=>{
  const rows = JSON.parse($("reportTableL").dataset.rows || "[]");
  exportSummaryExcel(rows);
});

/* ========================= EXPORT: RAW CLASS ATTENDANCE (WITH SIGNATURES) ========================= */
function classTitle(cls){
  return `${cls.unit} · ${cls.course} · ${cls.venue} · ${formatDateTime(cls.dateTime)}`;
}

function exportClassAttendanceCSV(cls, att){
  const headers = ["#","Admission","Surname","Middle","First","Timestamp","SignatureDataURL"];
  const lines = [headers.join(",")];
  att.forEach((a,i)=>{
    lines.push([
      i+1,
      csv(a.admission),
      csv(a.surname),
      csv(a.middle||""),
      csv(a.first),
      csv(formatDateTime(a.createdAt)),
      csv(a.signature||"")
    ].join(","));
  });
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `jooust-class-attendance-${safeFile(cls.unit)}.csv`;
  link.click();
  URL.revokeObjectURL(url);
}

function exportClassAttendanceExcel(cls, att){
  const {xlsxOK} = libsReady();
  if(!xlsxOK){ alert("Excel library not loaded. Check internet or CDN access."); return; }
  const wsData = [["#","Admission","Surname","Middle","First","Timestamp","SignatureDataURL"]];
  att.forEach((a,i)=> wsData.push([i+1,a.admission,a.surname,a.middle||"",a.first,formatDateTime(a.createdAt),a.signature||""]));
  const wb = XLSX.utils.book_new();
  wb.Props = {Title:"JOOUST Class Attendance", Subject:cls.unit, Author:"Gerotech — Dan Otieno"};
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "Attendance");
  XLSX.writeFile(wb, `jooust-class-attendance-${safeFile(cls.unit)}.xlsx`);
}

function exportClassAttendanceWord(cls, att){
  const dateStr = new Date().toLocaleString();
  const logoHtml = jooustLogoDataUrl
    ? `<img src="${jooustLogoDataUrl}" style="height:60px;" />`
    : `<div style="font-weight:800;color:#0052cc;">JOOUST</div>`;

  const rows = att.map((a,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${esc(a.admission)}</td>
      <td>${esc(a.surname)}</td>
      <td>${esc(a.middle||"")}</td>
      <td>${esc(a.first)}</td>
      <td>${esc(formatDateTime(a.createdAt))}</td>
      <td>${a.signature ? `<img src="${a.signature}" style="height:28px;border:1px solid #ccc;border-radius:6px;" />` : ""}</td>
    </tr>
  `).join("");

  const html = `
  <html><head><meta charset="UTF-8"></head><body>
    <div style="display:flex;align-items:center;gap:14px;">
      ${logoHtml}
      <div>
        <h2 style="margin:0;color:#0052cc;">Jaramogi Oginga Odinga University of Science & Technology</h2>
        <div style="margin:0;font-size:12px;color:#444;">Class Attendance (Raw) — ${esc(classTitle(cls))}</div>
        <div style="margin:0;font-size:11px;color:#666;">Generated: ${esc(dateStr)}</div>
      </div>
    </div>
    <hr/>
    <table border="1" cellspacing="0" cellpadding="5" style="border-collapse:collapse;width:100%;font-size:11px;">
      <thead>
        <tr style="background:#eff6ff;color:#1d4ed8;">
          <th>#</th><th>Admission</th><th>Surname</th><th>Middle</th><th>First</th><th>Timestamp</th><th>Signature</th>
        </tr>
      </thead>
      <tbody>
        ${rows || "<tr><td colspan='7'>No records.</td></tr>"}
      </tbody>
    </table>
    <p style="margin-top:12px;color:#555;font-size:11px;"><strong>Created by Gerotech — Dan Otieno</strong></p>
  </body></html>`;

  const blob = new Blob(["\ufeff", html], {type:"application/msword"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `jooust-class-attendance-${safeFile(cls.unit)}.doc`;
  a.click();
  URL.revokeObjectURL(url);
}

function exportClassAttendancePDF(cls, att){
  const {pdfOK} = libsReady();
  if(!pdfOK){ alert("PDF library not loaded. Check internet or CDN access."); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("l","pt","a4");
  const margin = 40;

  if(jooustLogoDataUrl){
    doc.addImage(jooustLogoDataUrl,"JPEG", margin, 18, 80, 60);
  }
  doc.setFontSize(15);
  doc.setTextColor(0,82,204);
  doc.text("Jaramogi Oginga Odinga University of Science & Technology", 140, 40);
  doc.setFontSize(11);
  doc.setTextColor(31,41,55);
  doc.text("Class Attendance (Raw) — " + classTitle(cls), 140, 58);

  const body = att.map((a,i)=>[
    i+1, a.admission, a.surname, a.middle||"", a.first, formatDateTime(a.createdAt), a.signature || ""
  ]);

  doc.autoTable({
    startY: 90,
    head:[["#","Admission","Surname","Middle","First","Timestamp","Signature"]],
    body,
    styles:{fontSize:8, cellPadding:4},
    headStyles:{fillColor:[0,82,204], textColor:255},
    columnStyles:{
      6:{cellWidth:90} // signature column width
    },
    didDrawCell: (data)=>{
      // draw signature image in body, signature column
      if(data.section==="body" && data.column.index===6){
        const sig = data.cell.raw;
        if(sig && typeof sig==="string" && sig.startsWith("data:image")){
          try{
            const x = data.cell.x + 6;
            const y = data.cell.y + 4;
            const w = 78;
            const h = 22;
            doc.addImage(sig, "PNG", x, y, w, h);
          }catch(e){ /* ignore */ }
        }
      }
    }
  });

  doc.setFontSize(9);
  doc.setTextColor(90);
  doc.text("Created by Gerotech — Dan Otieno", margin, doc.internal.pageSize.getHeight()-18);

  doc.save(`jooust-class-attendance-${safeFile(cls.unit)}.pdf`);
}

/* ========================= LECTURER: CHANGE PASSWORD ========================= */
$("lecChangePassBtn").addEventListener("click", ()=>{
  const oldP = $("lecOldPass").value;
  const newP = $("lecNewPass").value;
  const newP2 = $("lecNewPass2").value;
  const msgEl = $("lecPassMsg");

  if(!currentUser || currentUser.role!=="lecturer"){ setAlert(msgEl, "You must be logged in as lecturer.", "danger"); return; }
  if(!oldP || !newP || !newP2){ setAlert(msgEl, "Fill all password fields.", "danger"); return; }
  if(newP !== newP2){ setAlert(msgEl, "New passwords do not match.", "danger"); return; }

  DATA = loadData();
  const lec = DATA.lecturers.find(l=>l.id===currentUser.id);
  if(!lec || lec.password!==oldP){ setAlert(msgEl, "Old password is incorrect.", "danger"); return; }
  lec.password = newP;
  saveData(DATA);

  setAlert(msgEl, "Lecturer password changed successfully.", "success");
  $("lecOldPass").value = $("lecNewPass").value = $("lecNewPass2").value = "";
});

/* ========================= TABS ========================= */
document.querySelectorAll("[data-admin-tab]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const target = btn.getAttribute("data-admin-tab");
    document.querySelectorAll(".admin-tab").forEach(sec=> sec.classList.toggle("hidden", sec.id!==target));
    document.querySelectorAll(".tab[data-admin-tab]").forEach(tb=> tb.classList.remove("active"));
    btn.classList.add("active");
    if(target==="classesTab") renderAdminClasses();
    if(target==="reportsTab"){ initAdminReportDropdowns(); refreshClassPick("repClassPick", null); }
  });
});

document.querySelectorAll("[data-lec-tab]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const target = btn.getAttribute("data-lec-tab");
    document.querySelectorAll(".lec-tab").forEach(sec=> sec.classList.toggle("hidden", sec.id!==target));
    document.querySelectorAll(".tab[data-lec-tab]").forEach(tb=> tb.classList.remove("active"));
    btn.classList.add("active");
    if(target==="lecClassesTab") renderLecturerClasses();
    if(target==="lecReportsTab"){ initLecturerReportDropdowns(); refreshClassPick("repClassPickL", currentUser?.id||null); }
  });
});

/* ========================= HELPERS ========================= */
function safeFile(s){ return (s||"class").replace(/[^a-z0-9-_]+/gi,"_").slice(0,50); }
function csv(v){
  const str = (v??"").toString().replace(/"/g,'""');
  return `"${str}"`;
}
function esc(s){
  return (s??"").toString()
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}
function escapeHtml(s){ return esc(s); }

/* ========================= INIT ========================= */
window.addEventListener("load", ()=>{
  loadLogoAsDataUrl();
  setupStudentView();

  // pre-fill dropdowns even before login (safe)
  cascadeDropdowns("rep");
  cascadeDropdowns("repL");
  cascadeDropdowns("lc");

  // listeners to refresh class pick dropdowns when filters change
  ["repFaculty","repCourse","repUnit","repYear","repSemester"].forEach(id=>{
    const el=$(id); if(el) el.addEventListener("change", ()=> refreshClassPick("repClassPick", null));
  });
  ["repFacultyL","repCourseL","repUnitL","repYearL","repSemesterL"].forEach(id=>{
    const el=$(id); if(el) el.addEventListener("change", ()=> refreshClassPick("repClassPickL", currentUser?.id||null));
  });

  // lecturer class filters
  ["lecClassFilterUnit","lecClassFilterStatus","lecClassSort"].forEach(id=>{
    const el=$(id); if(el) el.addEventListener("change", renderLecturerClasses);
  });

  // admin class sort
  $("adminClassSort").addEventListener("change", renderAdminClasses);
});
</script>
</body>
</html>
