<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JOOUST Smart Attendance Management System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- ================= JOOUST BRANDING ================= -->
<style>
:root{
  --blue:#003b8c;
  --blue2:#0052cc;
  --green:#24a148;
  --gold:#f2c94c;
  --bg:#f4f7fb;
  --card:#ffffff;
  --text:#1f2933;
  --muted:#6b7280;
  --danger:#e11d48;
}
*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,sans-serif}
body{margin:0;background:var(--bg);color:var(--text)}

header{
  background:linear-gradient(135deg,var(--blue),var(--blue2));
  color:#fff;padding:1rem 1.5rem;
  display:flex;justify-content:space-between;align-items:center;
  box-shadow:0 6px 20px rgba(0,0,0,.25);
}
header .brand{display:flex;gap:1rem;align-items:center}
header img{height:54px;background:#fff;border-radius:6px;padding:4px}

main{max-width:1200px;margin:1.5rem auto;padding:0 1rem}
.card{background:var(--card);border-radius:16px;padding:1.6rem;margin-bottom:1.2rem;
box-shadow:0 12px 30px rgba(15,23,42,.08)}

h2,h3{margin-top:0;color:var(--blue)}

label{font-size:.85rem;color:var(--muted)}
input,select{width:100%;padding:.6rem;border-radius:8px;border:1px solid #d1d5db}

.row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
gap:1rem;margin-bottom:1rem}

.btn{border:none;border-radius:999px;padding:.65rem 1.4rem;font-weight:600;cursor:pointer}
.btn-primary{background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff}
.btn-success{background:linear-gradient(135deg,var(--green),#15803d);color:#fff}
.btn-secondary{background:#e5e7eb}
.btn-danger{background:var(--danger);color:#fff}

.hidden{display:none}

.signature-pad{
  border:2px dashed var(--blue2);
  border-radius:12px;
  height:140px;
  width:100%;
  background:#fff;
}

table{width:100%;border-collapse:collapse;font-size:.85rem}
th,td{border:1px solid #e5e7eb;padding:.55rem}
th{background:#eff6ff;color:#1d4ed8}

footer{
  margin-top:2rem;
  text-align:center;
  padding:1.5rem;
  background:linear-gradient(135deg,var(--blue),var(--blue2));
  color:#fff;
}
footer strong{color:var(--gold)}
</style>

<!-- ================= LIBRARIES ================= -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
</head>
<body>

<header>
  <div class="brand">
    <img src="logo.jpg">
    <div>
      <h2>JOOUST Smart Attendance System</h2>
      <small>Secure • Geo-Fenced • Digital Signatures • Smart Reports</small>
    </div>
  </div>
  <div id="topUser"></div>
</header>

<main>

<!-- LOGIN -->
<section id="loginSection" class="card">
  <h2>System Login</h2>
  <div class="row">
    <div>
      <label>Role</label>
      <select id="loginRole">
        <option value="admin">Admin</option>
        <option value="lecturer">Lecturer</option>
      </select>
    </div>
    <div><label>Username</label><input id="loginUser"></div>
    <div><label>Password</label><input id="loginPass" type="password"></div>
  </div>
  <button class="btn btn-primary" onclick="login()">Login</button>
  <button class="btn btn-secondary" onclick="showRegister()">Register Lecturer</button>
  <p id="loginMsg"></p>
</section>

<!-- STUDENT -->
<section id="studentSection" class="card hidden">
  <h2>Student Attendance</h2>
  <p id="classInfo"></p>
  <div class="row">
    <div><label>Surname</label><input id="stSurname"></div>
    <div><label>First Name</label><input id="stFirst"></div>
    <div><label>Admission No</label><input id="stAdm"></div>
  </div>
  <label>Signature</label>
  <canvas id="stSig" class="signature-pad"></canvas>
  <button class="btn btn-success" onclick="submitAttendance()">Submit Attendance</button>
  <p id="stMsg"></p>
</section>

</main>

<footer>
  © JOOUST Smart Attendance System  
  <br>Created by <strong>Gerotech</strong> under <strong>Dan Otieno</strong>
</footer>

<script>
/* ================= CONFIG ================= */
const JOOUST_LAT = -0.0917;
const JOOUST_LON = 34.7680;

/* ================= DATA ================= */
const KEY="jooust_final_prod";
let DB=JSON.parse(localStorage.getItem(KEY))||{
  admins:[{u:"admin",p:"admin123"}],
  classes:[],
  attendance:[]
};
function save(){localStorage.setItem(KEY,JSON.stringify(DB))}

/* ================= LOGIN ================= */
function login(){
  if(loginRole.value==="admin"){
    const a=DB.admins.find(x=>x.u===loginUser.value&&x.p===loginPass.value);
    if(!a){loginMsg.textContent="Invalid admin credentials";return}
    topUser.textContent="Admin logged in";
    loginSection.classList.add("hidden");
  }
}

/* ================= STUDENT ================= */
const url=new URLSearchParams(location.search);
const classId=url.get("student");
if(classId){
  loginSection.classList.add("hidden");
  studentSection.classList.remove("hidden");
  classInfo.textContent="Attendance for Class ID: "+classId;
}

const canvas=document.getElementById("stSig");
const ctx=canvas.getContext("2d");
ctx.lineWidth=2;ctx.lineCap="round";
let draw=false;

canvas.onmousedown=e=>{draw=true;ctx.beginPath();ctx.moveTo(e.offsetX,e.offsetY)};
canvas.onmousemove=e=>{if(draw){ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke()}};
window.onmouseup=()=>draw=false;

canvas.ontouchstart=e=>{
  e.preventDefault();
  draw=true;
  const t=e.touches[0];
  const r=canvas.getBoundingClientRect();
  ctx.beginPath();
  ctx.moveTo(t.clientX-r.left,t.clientY-r.top);
};
canvas.ontouchmove=e=>{
  e.preventDefault();
  if(draw){
    const t=e.touches[0];
    const r=canvas.getBoundingClientRect();
    ctx.lineTo(t.clientX-r.left,t.clientY-r.top);
    ctx.stroke();
  }
};
canvas.ontouchend=()=>draw=false;

function submitAttendance(){
  navigator.geolocation.getCurrentPosition(pos=>{
    const d=distance(pos.coords.latitude,pos.coords.longitude,JOOUST_LAT,JOOUST_LON);
    if(d>1){stMsg.textContent="You must be within JOOUST (1km)";return}
    DB.attendance.push({
      classId,
      surname:stSurname.value,
      first:stFirst.value,
      adm:stAdm.value,
      time:new Date().toLocaleString()
    });
    save();
    stMsg.textContent="Attendance submitted successfully";
  },()=>stMsg.textContent="Location permission required");
}

function distance(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+
  Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
  Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
</script>

</body>
</html>
