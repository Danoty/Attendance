<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JOOUST Smart Attendance System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>

  <!-- JS Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root {
      --primary:#003366;      /* JOOUST dark blue */
      --primary-light:#0b5394;
      --accent:#43a047;       /* JOOUST green-ish */
      --accent-soft:#e8f5e9;
      --bg:#f4f6fb;
      --card-bg:#ffffff;
      --text:#1f2933;
      --border:#d0d7e2;
      --danger:#c62828;
      --muted:#6b7280;
      --shadow:0 10px 25px rgba(15, 23, 42, 0.12);
      --radius-xl:18px;
    }

    * {
      box-sizing:border-box;
      font-family:"Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin:0;
      background:var(--bg);
      color:var(--text);
    }

    header {
      background:linear-gradient(120deg, var(--primary) 0%, var(--primary-light) 50%, var(--accent) 100%);
      color:#fff;
      padding:16px 4vw 12px;
      box-shadow:var(--shadow);
      position:sticky;
      top:0;
      z-index:50;
    }

    .header-inner {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }

    .brand {
      display:flex;
      align-items:center;
      gap:12px;
    }

    .brand img {
      height:56px;
      width:auto;
      border-radius:12px;
      background:#fff;
      padding:4px;
      box-shadow:0 4px 10px rgba(0,0,0,0.2);
    }

    .brand-text h1 {
      margin:0;
      font-size:1.25rem;
      font-weight:700;
      letter-spacing:0.03em;
    }

    .brand-text span {
      font-size:0.78rem;
      opacity:0.9;
    }

    nav {
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    nav button {
      border:none;
      border-radius:999px;
      padding:8px 14px;
      font-size:0.82rem;
      cursor:pointer;
      background:rgba(255,255,255,0.12);
      color:#fff;
      backdrop-filter:blur(4px);
      transition:background 0.2s, transform 0.1s, box-shadow 0.2s;
    }

    nav button.active {
      background:#fff;
      color:var(--primary);
      box-shadow:0 4px 10px rgba(15, 23, 42, 0.25);
      transform:translateY(-1px);
    }

    nav button:hover {
      background:rgba(255,255,255,0.25);
    }

    main {
      padding:20px 4vw 40px;
      max-width:1200px;
      margin:0 auto;
    }

    .section {
      display:none;
      animation:fadeIn 0.25s ease-out;
    }

    .section.active {
      display:block;
    }

    @keyframes fadeIn {
      from { opacity:0; transform:translateY(4px); }
      to   { opacity:1; transform:translateY(0); }
    }

    .card {
      background:var(--card-bg);
      border-radius:var(--radius-xl);
      box-shadow:var(--shadow);
      padding:18px 18px 20px;
      margin-bottom:20px;
      border:1px solid rgba(15, 23, 42, 0.04);
    }

    .card-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      gap:8px;
    }

    .card-title {
      font-size:1rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .badge {
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.7rem;
      background:var(--accent-soft);
      color:var(--accent);
      font-weight:500;
    }

    .card-subtitle {
      font-size:0.8rem;
      color:var(--muted);
    }

    label {
      font-size:0.8rem;
      font-weight:500;
      margin-bottom:4px;
      display:block;
      color:var(--muted);
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    select,
    textarea {
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:0.85rem;
      outline:none;
      transition:border 0.15s, box-shadow 0.15s;
      background:#f9fafb;
    }

    input:focus, select:focus, textarea:focus {
      border-color:var(--primary-light);
      box-shadow:0 0 0 1px rgba(11,83,148,0.2);
      background:#fff;
    }

    textarea {
      resize:vertical;
      min-height:80px;
    }

    .grid {
      display:grid;
      gap:12px;
    }

    @media (min-width:700px) {
      .grid-2 { grid-template-columns:repeat(2, minmax(0,1fr)); }
      .grid-3 { grid-template-columns:repeat(3, minmax(0,1fr)); }
    }

    .btn {
      border:none;
      border-radius:999px;
      padding:8px 16px;
      font-size:0.82rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-weight:500;
      background:var(--primary);
      color:#fff;
      box-shadow:0 4px 12px rgba(15, 23, 42, 0.25);
      transition:background 0.15s, transform 0.1s, box-shadow 0.15s;
    }

    .btn:hover {
      background:var(--primary-light);
      transform:translateY(-1px);
      box-shadow:0 6px 16px rgba(15, 23, 42, 0.30);
    }

    .btn-outline {
      background:#fff;
      color:var(--primary);
      border:1px solid var(--primary-light);
      box-shadow:none;
    }

    .btn-outline:hover {
      background:var(--primary-light);
      color:#fff;
    }

    .btn-soft {
      background:var(--accent-soft);
      color:var(--accent);
      box-shadow:none;
      border:1px solid rgba(67,160,71,0.25);
    }

    .btn-soft:hover {
      background:var(--accent);
      color:#fff;
    }

    .btn-danger {
      background:var(--danger);
    }

    .btn-sm {
      padding:6px 10px;
      font-size:0.75rem;
    }

    .helper-text {
      font-size:0.75rem;
      color:var(--muted);
      margin-top:3px;
    }

    .pill {
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.7rem;
      background:#eef2ff;
      color:#4f46e5;
      font-weight:500;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:0.8rem;
    }

    th, td {
      padding:6px 8px;
      border-bottom:1px solid #e5e7eb;
      text-align:left;
      vertical-align:top;
    }

    th {
      background:#f3f4ff;
      font-weight:600;
    }

    tr:nth-child(even) td {
      background:#f9fafb;
    }

    .tag {
      padding:2px 8px;
      border-radius:12px;
      font-size:0.7rem;
      background:#e0f2fe;
      color:#0369a1;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .status-dot {
      width:6px;
      height:6px;
      border-radius:999px;
      background:#22c55e;
    }

    .chip-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }

    .chip {
      padding:3px 9px;
      border-radius:999px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      font-size:0.72rem;
      color:var(--muted);
    }

    .signature-wrapper {
      border-radius:12px;
      border:1px dashed #cbd5e1;
      background:#f9fafb;
      padding:8px;
      margin-top:4px;
    }

    .signature-wrapper canvas {
      width:100%;
      height:160px;
      background:#fff;
      border-radius:10px;
      border:1px solid #e5e7eb;
      box-shadow:inset 0 0 0 1px rgba(148,163,184,0.25);
    }

    .signature-actions {
      margin-top:6px;
      display:flex;
      justify-content:flex-end;
      gap:6px;
    }

    .pill-info {
      font-size:0.76rem;
      color:var(--muted);
    }

    .highlight {
      color:var(--accent);
      font-weight:600;
    }

    .table-scroller {
      max-height:360px;
      overflow:auto;
      border-radius:12px;
      border:1px solid #e5e7eb;
      background:#fff;
    }

    .section-hint {
      font-size:0.8rem;
      color:var(--muted);
      margin-bottom:10px;
    }

    .stat-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }

    .stat-chip {
      background:#f9fafb;
      border-radius:999px;
      padding:6px 10px;
      font-size:0.78rem;
      border:1px solid #e5e7eb;
    }

    .label-inline {
      font-size:0.78rem;
      color:var(--muted);
      margin-right:8px;
    }

    .flex-between {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .mt-8 { margin-top:8px; }
    .mt-10 { margin-top:10px; }
    .mt-12 { margin-top:12px; }
    .mt-16 { margin-top:16px; }

    .empty-msg {
      font-size:0.8rem;
      color:var(--muted);
      padding:8px 0;
    }

    .badge-live {
      padding:3px 9px;
      border-radius:999px;
      background:#fee2e2;
      color:#b91c1c;
      font-size:0.7rem;
      display:inline-flex;
      align-items:center;
      gap:5px;
      font-weight:500;
    }

    .dot-pulse {
      width:8px;
      height:8px;
      border-radius:999px;
      background:#dc2626;
      box-shadow:0 0 0 0 rgba(220,38,38,0.8);
      animation:pulse 1.4s infinite;
    }

    @keyframes pulse {
      0% { box-shadow:0 0 0 0 rgba(220,38,38,0.8); }
      70% { box-shadow:0 0 0 8px rgba(220,38,38,0); }
      100% { box-shadow:0 0 0 0 rgba(220,38,38,0); }
    }

    footer {
      text-align:center;
      font-size:0.75rem;
      color:var(--muted);
      padding:14px 4vw 22px;
    }
  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <img src="logo.jpg" alt="JOOUST Logo" id="jooustLogo">
      <div class="brand-text">
        <h1>JOOUST Smart Attendance System</h1>
        <span>Digital class attendance · Signatures · JOOUST-branded reports</span>
      </div>
    </div>
  </div>
  <nav>
    <button class="active" data-section="adminSection">Admin Setup</button>
    <button data-section="lecturerSection">Lecturer Console</button>
    <button data-section="studentSection">Student Attendance Form</button>
    <button data-section="reportsSection">Reports & Exports</button>
  </nav>
</header>

<main>
  <!-- ADMIN SECTION -->
  <section id="adminSection" class="section active">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Faculty / Course / Class Setup</div>
          <div class="card-subtitle">
            Upload structure once, then lecturers can pick from dropdowns.
          </div>
        </div>
        <span class="badge">Step 1</span>
      </div>

      <p class="section-hint">
        Prepare a CSV file with columns: <strong>Faculty, Course, Unit</strong>.  
        Example: <span class="pill">School of Computing, BSc IT, Network Security</span>
      </p>

      <div class="grid grid-2">
        <div>
          <label for="structureFile">Upload structure (CSV)</label>
          <input type="file" id="structureFile" accept=".csv" />
          <div class="helper-text">
            After upload, the Faculty → Course → Unit dropdowns will be available everywhere.
          </div>
        </div>
        <div>
          <label>Current structures</label>
          <div id="structureSummary" class="helper-text">
            No structure uploaded yet.
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Register Lecturers</div>
          <div class="card-subtitle">Lecturers can later start and end classes.</div>
        </div>
        <span class="badge">Step 2</span>
      </div>

      <div class="grid grid-3">
        <div>
          <label for="lecturerName">Lecturer full name</label>
          <input type="text" id="lecturerName" placeholder="Dr. Jane A. Doe" />
        </div>
        <div>
          <label for="lecturerStaffId">Staff / Payroll / PF number</label>
          <input type="text" id="lecturerStaffId" placeholder="PF1234" />
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button class="btn btn-soft" id="addLecturerBtn">Add Lecturer</button>
        </div>
      </div>

      <div class="mt-12">
        <div class="card-subtitle">Registered lecturers</div>
        <div id="lecturerList" class="helper-text mt-8">
          None yet. Add at least one lecturer.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Student sharing link</div>
      </div>
      <p class="section-hint">
        Share this link with students for attendance:
        <br/>
        <span class="pill-info">
          <span class="highlight" id="studentLinkDisplay"></span>
        </span>
      </p>
    </div>
  </section>

  <!-- LECTURER SECTION -->
  <section id="lecturerSection" class="section">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">
            Create & Control Class Session
          </div>
          <div class="card-subtitle">
            Select class details, then start/end the session. Students sign from the link.
          </div>
        </div>
        <span class="badge">Lecturer Console</span>
      </div>

      <div class="grid grid-3">
        <div>
          <label for="lecturerSelect">Lecturer</label>
          <select id="lecturerSelect">
            <option value="">Select lecturer…</option>
          </select>
        </div>
        <div>
          <label for="lecturerDate">Class Date</label>
          <input type="date" id="lecturerDate">
        </div>
        <div>
          <label for="lecturerStartTime">Planned start time</label>
          <input type="time" id="lecturerStartTime">
        </div>
      </div>

      <div class="grid grid-3 mt-12">
        <div>
          <label for="facultySelect">Faculty / School</label>
          <select id="facultySelect">
            <option value="">Select…</option>
          </select>
        </div>
        <div>
          <label for="courseSelect">Course</label>
          <select id="courseSelect">
            <option value="">Select…</option>
          </select>
        </div>
        <div>
          <label for="unitSelect">Unit / Class</label>
          <select id="unitSelect">
            <option value="">Select…</option>
          </select>
        </div>
      </div>

      <div class="grid grid-2 mt-12">
        <div>
          <label for="venueInput">Venue / Lecture Room</label>
          <input type="text" id="venueInput" placeholder="Lab 3, Main Campus">
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="chip-row">
            <button class="btn" id="startClassBtn">Start Class</button>
            <button class="btn btn-outline" id="endClassBtn">End Class & Sign</button>
          </div>
        </div>
      </div>

      <div class="mt-10">
        <span class="label-inline">Current Session Status:</span>
        <span id="currentClassStatus" class="pill">No active class</span>
      </div>
    </div>

    <div class="card" id="lecturerSignatureCard" style="display:none;">
      <div class="card-header">
        <div>
          <div class="card-title">Lecturer Sign-off</div>
          <div class="card-subtitle">Sign to confirm that this class took place.</div>
        </div>
        <span class="badge">Signature</span>
      </div>
      <div class="signature-wrapper">
        <canvas id="lecturerSignatureCanvas"></canvas>
        <div class="signature-actions">
          <button class="btn-sm btn-outline" id="clearLecturerSignature">Clear</button>
          <button class="btn-sm btn-soft" id="saveLecturerSignature">Save Signature</button>
        </div>
      </div>
      <p class="helper-text mt-8">
        Once saved, the signature is locked with this class record and appears on reports.
      </p>
    </div>
  </section>

  <!-- STUDENT SECTION -->
  <section id="studentSection" class="section">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Student Attendance Form</div>
          <div class="card-subtitle">
            Fill this form only when the lecturer has started the class.
          </div>
        </div>
        <span class="badge">For Students</span>
      </div>

      <div id="studentClassInfo" class="chip-row">
        <span class="chip">Waiting for an active class…</span>
      </div>

      <div class="grid grid-2 mt-12">
        <div>
          <label for="surnameInput">Sir Name (Surname)</label>
          <input type="text" id="surnameInput" placeholder="Odhiambo">
        </div>
        <div>
          <label for="middleNameInput">Middle Name</label>
          <input type="text" id="middleNameInput" placeholder="Ochieng">
        </div>
      </div>

      <div class="grid grid-2 mt-12">
        <div>
          <label for="firstNameInput">First Name</label>
          <input type="text" id="firstNameInput" placeholder="Daniel">
        </div>
        <div>
          <label for="admissionInput">Admission / Registration Number</label>
          <input type="text" id="admissionInput" placeholder="JOOUST/SCIT/0001/2025">
        </div>
      </div>

      <div class="mt-12">
        <label>Student digital signature</label>
        <div class="signature-wrapper">
          <canvas id="studentSignatureCanvas"></canvas>
          <div class="signature-actions">
            <button class="btn-sm btn-outline" id="clearStudentSignature">Clear</button>
          </div>
        </div>
      </div>

      <div class="mt-16">
        <button class="btn" id="submitAttendanceBtn">Submit Attendance</button>
      </div>
      <p class="helper-text mt-8">
        Your attendance (with time and signature) will be captured against the active class.
      </p>
    </div>
  </section>

  <!-- REPORTS SECTION -->
  <section id="reportsSection" class="section">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Attendance Reports</div>
          <div class="card-subtitle">
            Generate weekly, monthly or per-class summaries. Export as Excel or PDF (with JOOUST logo).
          </div>
        </div>
        <span class="badge">Management</span>
      </div>

      <div class="grid grid-3">
        <div>
          <label for="reportClassSelect">Class / Unit</label>
          <select id="reportClassSelect">
            <option value="">Select a class session…</option>
          </select>
        </div>
        <div>
          <label for="reportTypeSelect">Report type</label>
          <select id="reportTypeSelect">
            <option value="class">Selected Class Summary</option>
            <option value="weekly">Last 7 Days (All)</option>
            <option value="monthly">Last 30 Days (All)</option>
          </select>
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button class="btn-soft btn" id="generateReportBtn">Generate Report</button>
        </div>
      </div>

      <div class="flex-between mt-12">
        <div class="chip-row">
          <span class="chip">JOOUST logo embedded in PDF</span>
          <span class="chip">Excel (XLSX) for analysis</span>
        </div>
        <div class="chip-row">
          <button class="btn-sm btn-outline" id="exportExcelBtn">Export Excel</button>
          <button class="btn-sm btn-outline" id="exportPdfBtn">Export PDF</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div id="reportPreview">
        <div class="flex-between">
          <div>
            <div class="card-title">Report Preview</div>
            <div class="card-subtitle">
              Select a report above to see details here.
            </div>
          </div>
          <div style="display:flex; align-items:center; gap:8px;">
            <img src="logo.jpg" alt="JOOUST Logo" style="height:40px; border-radius:10px; background:#fff; padding:4px; box-shadow:0 4px 10px rgba(15,23,42,.2);">
          </div>
        </div>

        <div id="reportSummary" class="stat-row mt-10"></div>

        <div class="mt-10 table-scroller" id="reportTableWrapper" style="display:none;">
          <table id="reportTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="reportEmptyState" class="empty-msg">
          No report generated yet.
        </div>
      </div>
    </div>

    <div class="card" id="hodSignatureCard" style="display:none;">
      <div class="card-header">
        <div>
          <div class="card-title">HOD Approval Signature</div>
          <div class="card-subtitle">
            Head of Department signs to approve that selected class took place.
          </div>
        </div>
        <span class="badge">HOD</span>
      </div>
      <div class="signature-wrapper">
        <canvas id="hodSignatureCanvas"></canvas>
        <div class="signature-actions">
          <button class="btn-sm btn-outline" id="clearHodSignature">Clear</button>
          <button class="btn-sm btn-soft" id="saveHodSignature">Save HOD Signature</button>
        </div>
      </div>
      <p class="helper-text mt-8">
        This signature is stored with the specific class and will appear on exported reports.
      </p>
    </div>
  </section>
</main>

<footer>
  JOOUST · Smart Attendance & Reporting · Built for Faculties, Courses & Units
</footer>

<script>
  // ------------------ DATA STORAGE ------------------
  const STORAGE_KEY = "jooustAttendanceApp";

  let appData = {
    structure: [],     // [{faculty, course, unit}]
    lecturers: [],     // [{id, name, staffId}]
    classes: []        // [{id, lecturerId, date, startTime, actualStart, faculty, course, unit, venue, endTime, lecturerSignature, hodSignature, attendees:[] }]
  };

  let activeClassId = null;

  function loadData() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) appData = JSON.parse(raw);
    } catch (e) {
      console.error("Error loading data", e);
    }
  }

  function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
    refreshUI();
  }

  function generateId(prefix) {
    return prefix + "_" + Math.random().toString(36).slice(2, 10);
  }

  // ------------------ NAVIGATION ------------------
  const sectionButtons = document.querySelectorAll("nav button");
  const sections = document.querySelectorAll(".section");

  sectionButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      sectionButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const target = btn.getAttribute("data-section");
      sections.forEach(sec => {
        sec.classList.toggle("active", sec.id === target);
      });
    });
  });

  // ------------------ ADMIN: STRUCTURE UPLOAD ------------------
  const structureFileInput = document.getElementById("structureFile");
  const structureSummary = document.getElementById("structureSummary");

  structureFileInput.addEventListener("change", () => {
    const file = structureFileInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      const text = e.target.result;
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
      const parsed = [];
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        if (i === 0 && line.toLowerCase().includes("faculty")) {
          // header row
          continue;
        }
        const parts = line.split(",").map(p => p.trim()).filter(p => p !== "");
        if (parts.length >= 3) {
          parsed.push({
            faculty: parts[0],
            course: parts[1],
            unit: parts[2]
          });
        }
      }
      if (parsed.length === 0) {
        alert("No valid rows found. Make sure CSV has Faculty, Course, Unit.");
        return;
      }
      appData.structure = parsed;
      saveData();
      alert("Structure uploaded successfully. Dropdowns updated.");
    };
    reader.readAsText(file);
  });

  function updateStructureSummary() {
    if (!appData.structure || appData.structure.length === 0) {
      structureSummary.textContent = "No structure uploaded yet.";
      return;
    }
    const faculties = new Set(appData.structure.map(s => s.faculty));
    const courses = new Set(appData.structure.map(s => s.course));
    const units = new Set(appData.structure.map(s => s.unit));
    structureSummary.innerHTML = `
      <span class="pill">Faculties: ${faculties.size}</span>
      &nbsp; <span class="pill">Courses: ${courses.size}</span>
      &nbsp; <span class="pill">Units: ${units.size}</span>
    `;
  }

  function buildStructureMaps() {
    const map = {};
    for (const row of appData.structure) {
      if (!map[row.faculty]) map[row.faculty] = {};
      if (!map[row.faculty][row.course]) map[row.faculty][row.course] = new Set();
      map[row.faculty][row.course].add(row.unit);
    }
    return map;
  }

  // ------------------ ADMIN: LECTURERS ------------------
  const lecturerNameInput = document.getElementById("lecturerName");
  const lecturerStaffIdInput = document.getElementById("lecturerStaffId");
  const addLecturerBtn = document.getElementById("addLecturerBtn");
  const lecturerListDiv = document.getElementById("lecturerList");
  const lecturerSelect = document.getElementById("lecturerSelect");

  addLecturerBtn.addEventListener("click", () => {
    const name = lecturerNameInput.value.trim();
    const staffId = lecturerStaffIdInput.value.trim();
    if (!name || !staffId) {
      alert("Please enter both lecturer name and staff number.");
      return;
    }
    appData.lecturers.push({
      id: generateId("lec"),
      name,
      staffId
    });
    lecturerNameInput.value = "";
    lecturerStaffIdInput.value = "";
    saveData();
  });

  function updateLecturerList() {
    if (!appData.lecturers || appData.lecturers.length === 0) {
      lecturerListDiv.textContent = "No lecturers registered yet.";
      return;
    }
    const items = appData.lecturers.map(l =>
      `<span class="chip">${l.name} · ${l.staffId}</span>`
    ).join(" ");
    lecturerListDiv.innerHTML = items;
  }

  function updateLecturerSelect() {
    lecturerSelect.innerHTML = `<option value="">Select lecturer…</option>`;
    for (const l of appData.lecturers) {
      const opt = document.createElement("option");
      opt.value = l.id;
      opt.textContent = `${l.name} (${l.staffId})`;
      lecturerSelect.appendChild(opt);
    }
  }

  // ------------------ LECTURER CLASS CONTROLS ------------------
  const lecturerDateInput = document.getElementById("lecturerDate");
  const lecturerStartTimeInput = document.getElementById("lecturerStartTime");
  const facultySelect = document.getElementById("facultySelect");
  const courseSelect = document.getElementById("courseSelect");
  const unitSelect = document.getElementById("unitSelect");
  const venueInput = document.getElementById("venueInput");
  const startClassBtn = document.getElementById("startClassBtn");
  const endClassBtn = document.getElementById("endClassBtn");
  const currentClassStatus = document.getElementById("currentClassStatus");

  function updateFacultyDropdowns() {
    const structureMap = buildStructureMaps();
    facultySelect.innerHTML = `<option value="">Select…</option>`;
    const faculties = Object.keys(structureMap).sort();
    faculties.forEach(f => {
      const opt = document.createElement("option");
      opt.value = f;
      opt.textContent = f;
      facultySelect.appendChild(opt);
    });
  }

  facultySelect.addEventListener("change", () => {
    const structureMap = buildStructureMaps();
    const faculty = facultySelect.value;
    courseSelect.innerHTML = `<option value="">Select…</option>`;
    unitSelect.innerHTML = `<option value="">Select…</option>`;
    if (!faculty || !structureMap[faculty]) return;
    const courses = Object.keys(structureMap[faculty]).sort();
    courses.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      courseSelect.appendChild(opt);
    });
  });

  courseSelect.addEventListener("change", () => {
    const structureMap = buildStructureMaps();
    const faculty = facultySelect.value;
    const course = courseSelect.value;
    unitSelect.innerHTML = `<option value="">Select…</option>`;
    if (!faculty || !course || !structureMap[faculty] || !structureMap[faculty][course]) return;
    const units = Array.from(structureMap[faculty][course]).sort();
    units.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u;
      opt.textContent = u;
      unitSelect.appendChild(opt);
    });
  });

  startClassBtn.addEventListener("click", () => {
    const lecturerId = lecturerSelect.value;
    const date = lecturerDateInput.value;
    const plannedTime = lecturerStartTimeInput.value;
    const faculty = facultySelect.value;
    const course = courseSelect.value;
    const unit = unitSelect.value;
    const venue = venueInput.value.trim();

    if (!lecturerId || !date || !faculty || !course || !unit || !venue) {
      alert("Please fill lecturer, date, faculty, course, unit and venue.");
      return;
    }

    if (activeClassId) {
      if (!confirm("Another class is active. End it before starting a new one?")) {
        return;
      }
      // leave the old one, but we still allow new one
    }

    const newClass = {
      id: generateId("class"),
      lecturerId,
      date,
      startTime: plannedTime || null,
      actualStart: new Date().toISOString(),
      faculty,
      course,
      unit,
      venue,
      endTime: null,
      lecturerSignature: null,
      hodSignature: null,
      attendees: []
    };

    appData.classes.push(newClass);
    activeClassId = newClass.id;
    saveData();
    alert("Class started. Share the student link for attendance.");
  });

  endClassBtn.addEventListener("click", () => {
    if (!activeClassId) {
      alert("No active class to end.");
      return;
    }
    const klass = appData.classes.find(c => c.id === activeClassId);
    if (!klass) {
      alert("Active class not found.");
      return;
    }
    klass.endTime = new Date().toISOString();
    saveData();
    document.getElementById("lecturerSignatureCard").style.display = "block";
    alert("Class ended. Please sign to confirm.");
  });

  function updateCurrentClassStatus() {
    if (!appData.classes || appData.classes.length === 0) {
      currentClassStatus.textContent = "No class sessions created yet.";
      currentClassStatus.className = "pill";
      return;
    }
    const current = appData.classes.find(c => c.id === activeClassId && !c.endTime);
    if (current) {
      currentClassStatus.innerHTML = `
        <span class="status-dot"></span>
        &nbsp; Active: ${current.faculty} · ${current.course} · ${current.unit} @ ${current.venue}
      `;
      currentClassStatus.className = "tag";
    } else {
      currentClassStatus.textContent = "No active class";
      currentClassStatus.className = "pill";
      activeClassId = null;
    }
  }

  // ------------------ SIGNATURES ------------------
  let studentSigPad, lecturerSigPad, hodSigPad;

  function setupSignaturePads() {
    const studentCanvas = document.getElementById("studentSignatureCanvas");
    const lecturerCanvas = document.getElementById("lecturerSignatureCanvas");
    const hodCanvas = document.getElementById("hodSignatureCanvas");

    function resizeCanvas(canvas) {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * ratio;
      canvas.height = rect.height * ratio;
      const ctx = canvas.getContext("2d");
      ctx.scale(ratio, ratio);
    }

    [studentCanvas, lecturerCanvas, hodCanvas].forEach(c => resizeCanvas(c));

    studentSigPad = new window.SignaturePad(studentCanvas, { backgroundColor:"#ffffff" });
    lecturerSigPad = new window.SignaturePad(lecturerCanvas, { backgroundColor:"#ffffff" });
    hodSigPad = new window.SignaturePad(hodCanvas, { backgroundColor:"#ffffff" });

    window.addEventListener("resize", () => {
      [studentCanvas, lecturerCanvas, hodCanvas].forEach(c => resizeCanvas(c));
    });

    document.getElementById("clearStudentSignature").onclick = () => studentSigPad.clear();
    document.getElementById("clearLecturerSignature").onclick = () => lecturerSigPad.clear();
    document.getElementById("clearHodSignature").onclick = () => hodSigPad.clear();

    document.getElementById("saveLecturerSignature").onclick = () => {
      if (!activeClassId) {
        alert("No active class to attach lecturer signature.");
        return;
      }
      if (lecturerSigPad.isEmpty()) {
        alert("Please sign before saving.");
        return;
      }
      const klass = appData.classes.find(c => c.id === activeClassId);
      if (!klass) {
        alert("Class not found.");
        return;
      }
      klass.lecturerSignature = lecturerSigPad.toDataURL("image/png");
      saveData();
      document.getElementById("lecturerSignatureCard").style.display = "none";
      alert("Lecturer signature saved.");
    };

    document.getElementById("saveHodSignature").onclick = () => {
      const classId = document.getElementById("reportClassSelect").value;
      if (!classId) {
        alert("Select a class from the report dropdown first.");
        return;
      }
      if (hodSigPad.isEmpty()) {
        alert("Please sign before saving.");
        return;
      }
      const klass = appData.classes.find(c => c.id === classId);
      if (!klass) {
        alert("Class not found.");
        return;
      }
      klass.hodSignature = hodSigPad.toDataURL("image/png");
      saveData();
      alert("HOD signature saved.");
    };
  }

  // ------------------ STUDENT ATTENDANCE ------------------
  const studentClassInfo = document.getElementById("studentClassInfo");
  const surnameInput = document.getElementById("surnameInput");
  const middleNameInput = document.getElementById("middleNameInput");
  const firstNameInput = document.getElementById("firstNameInput");
  const admissionInput = document.getElementById("admissionInput");
  const submitAttendanceBtn = document.getElementById("submitAttendanceBtn");

  function updateStudentClassInfo() {
    const current = appData.classes.find(c => c.id === activeClassId && !c.endTime);
    if (!current) {
      studentClassInfo.innerHTML = `<span class="chip">No active class right now. Please wait for your lecturer to start.</span>`;
      return;
    }
    const lec = appData.lecturers.find(l => l.id === current.lecturerId);
    const lecName = lec ? lec.name : "Unknown";
    studentClassInfo.innerHTML = `
      <span class="chip">
        <span class="dot-pulse"></span>&nbsp; Active Class
      </span>
      <span class="chip">${current.faculty}</span>
      <span class="chip">${current.course}</span>
      <span class="chip">${current.unit}</span>
      <span class="chip">Venue: ${current.venue}</span>
      <span class="chip">Lecturer: ${lecName}</span>
    `;
  }

  submitAttendanceBtn.addEventListener("click", () => {
    const current = appData.classes.find(c => c.id === activeClassId && !c.endTime);
    if (!current) {
      alert("No active class. Attendance cannot be recorded.");
      return;
    }
    const surname = surnameInput.value.trim();
    const middle = middleNameInput.value.trim();
    const first = firstNameInput.value.trim();
    const admission = admissionInput.value.trim();

    if (!surname || !first || !admission) {
      alert("Please fill Surname, First Name and Admission number.");
      return;
    }
    if (studentSigPad.isEmpty()) {
      alert("Please add your digital signature.");
      return;
    }

    current.attendees.push({
      surname,
      middle,
      first,
      admission,
      signature: studentSigPad.toDataURL("image/png"),
      time: new Date().toISOString()
    });

    saveData();

    surnameInput.value = "";
    middleNameInput.value = "";
    firstNameInput.value = "";
    admissionInput.value = "";
    studentSigPad.clear();

    alert("Attendance submitted. Thank you.");
  });

  // ------------------ REPORTS ------------------
  const reportClassSelect = document.getElementById("reportClassSelect");
  const reportTypeSelect = document.getElementById("reportTypeSelect");
  const generateReportBtn = document.getElementById("generateReportBtn");
  const reportSummaryDiv = document.getElementById("reportSummary");
  const reportTableWrapper = document.getElementById("reportTableWrapper");
  const reportTableHead = document.getElementById("reportTable").querySelector("thead");
  const reportTableBody = document.getElementById("reportTable").querySelector("tbody");
  const reportEmptyState = document.getElementById("reportEmptyState");
  const hodSignatureCard = document.getElementById("hodSignatureCard");

  function updateReportClassSelect() {
    reportClassSelect.innerHTML = `<option value="">Select a class session…</option>`;
    const sorted = [...appData.classes].sort((a, b) => new Date(b.actualStart || b.date) - new Date(a.actualStart || a.date));
    for (const klass of sorted) {
      const lec = appData.lecturers.find(l => l.id === klass.lecturerId);
      const label = `${klass.date || (klass.actualStart || '').slice(0,10)} · ${klass.unit} (${klass.course}) – ${lec ? lec.name : "Lecturer"}`;
      const opt = document.createElement("option");
      opt.value = klass.id;
      opt.textContent = label;
      reportClassSelect.appendChild(opt);
    }
  }

  function generateReport() {
    const type = reportTypeSelect.value;
    let rows = [];
    let summary = {};

    if (type === "class") {
      const classId = reportClassSelect.value;
      if (!classId) {
        alert("Please select a class.");
        return;
      }
      const klass = appData.classes.find(c => c.id === classId);
      if (!klass) {
        alert("Class not found.");
        return;
      }

      rows = klass.attendees.map(a => ({
        ClassDate: klass.date || (klass.actualStart || "").slice(0,10),
        Faculty: klass.faculty,
        Course: klass.course,
        Unit: klass.unit,
        Venue: klass.venue,
        Lecturer: (appData.lecturers.find(l => l.id === klass.lecturerId) || {}).name || "",
        Surname: a.surname,
        MiddleName: a.middle,
        FirstName: a.first,
        Admission: a.admission,
        TimeStamp: a.time
      }));

      summary = {
        scope: "Class",
        title: `${klass.faculty} · ${klass.course} · ${klass.unit}`,
        totalClasses: 1,
        totalStudents: klass.attendees.length,
        lecturerSigned: !!klass.lecturerSignature,
        hodSigned: !!klass.hodSignature
      };

      // Show HOD signature card for class reports
      hodSignatureCard.style.display = "block";
      if (klass.hodSignature && hodSigPad) {
        hodSigPad.clear(); // we don't re-draw; kept in data for exports
      }
    } else {
      const now = new Date();
      const days = type === "weekly" ? 7 : 30;
      const from = new Date(now.getTime() - days * 86400000);

      const filteredClasses = appData.classes.filter(c => {
        const d = new Date(c.date || c.actualStart || now);
        return d >= from && d <= now;
      });

      for (const klass of filteredClasses) {
        for (const a of klass.attendees) {
          rows.push({
            ClassDate: klass.date || (klass.actualStart || "").slice(0,10),
            Faculty: klass.faculty,
            Course: klass.course,
            Unit: klass.unit,
            Venue: klass.venue,
            Lecturer: (appData.lecturers.find(l => l.id === klass.lecturerId) || {}).name || "",
            Surname: a.surname,
            MiddleName: a.middle,
            FirstName: a.first,
            Admission: a.admission,
            TimeStamp: a.time
          });
        }
      }

      const studentSet = new Set(rows.map(r => r.Admission));
      summary = {
        scope: type === "weekly" ? "Last 7 days (all classes)" : "Last 30 days (all classes)",
        title: "University-wide summary",
        totalClasses: filteredClasses.length,
        totalStudents: studentSet.size,
        lecturerSigned: null,
        hodSigned: null
      };

      hodSignatureCard.style.display = "none";
    }

    renderReport(summary, rows);
    currentReportRows = rows; // for export
  }

  let currentReportRows = [];

  function renderReport(summary, rows) {
    reportSummaryDiv.innerHTML = "";
    if (!rows || rows.length === 0) {
      reportTableWrapper.style.display = "none";
      reportEmptyState.textContent = "No data found for selected period or class.";
      reportEmptyState.style.display = "block";
    } else {
      reportEmptyState.style.display = "none";
      reportTableWrapper.style.display = "block";
    }

    if (summary && summary.scope) {
      const chipsHtml = `
        <div class="stat-chip"><strong>Scope:</strong> ${summary.scope}</div>
        <div class="stat-chip"><strong>Title:</strong> ${summary.title}</div>
        <div class="stat-chip"><strong>Classes:</strong> ${summary.totalClasses}</div>
        <div class="stat-chip"><strong>Unique Students:</strong> ${summary.totalStudents}</div>
        ${
          summary.lecturerSigned === null ? "" :
          `<div class="stat-chip"><strong>Lecturer Signed:</strong> ${summary.lecturerSigned ? "Yes" : "No"}</div>`
        }
        ${
          summary.hodSigned === null ? "" :
          `<div class="stat-chip"><strong>HOD Signed:</strong> ${summary.hodSigned ? "Yes" : "No"}</div>`
        }
      `;
      reportSummaryDiv.innerHTML = chipsHtml;
    }

    if (!rows || rows.length === 0) {
      reportTableHead.innerHTML = "";
      reportTableBody.innerHTML = "";
      return;
    }

    // Build table from keys of first row
    const cols = Object.keys(rows[0]);
    reportTableHead.innerHTML = "<tr>" + cols.map(c => `<th>${c}</th>`).join("") + "</tr>";
    reportTableBody.innerHTML = rows.map(r =>
      "<tr>" + cols.map(c => `<td>${r[c] || ""}</td>`).join("") + "</tr>"
    ).join("");
  }

  generateReportBtn.addEventListener("click", generateReport);

  // ------------------ EXPORTS ------------------
  const exportExcelBtn = document.getElementById("exportExcelBtn");
  const exportPdfBtn = document.getElementById("exportPdfBtn");

  exportExcelBtn.addEventListener("click", () => {
    if (!currentReportRows || currentReportRows.length === 0) {
      alert("Generate a report first.");
      return;
    }
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(currentReportRows);
    XLSX.utils.book_append_sheet(wb, ws, "Attendance");
    XLSX.writeFile(wb, "jooust-attendance-report.xlsx");
  });

  exportPdfBtn.addEventListener("click", async () => {
    if (!currentReportRows || currentReportRows.length === 0) {
      alert("Generate a report first.");
      return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "pt", "a4");
    const reportElement = document.getElementById("reportPreview");

    await doc.html(reportElement, {
      callback: function (doc) {
        doc.save("jooust-attendance-report.pdf");
      },
      margin: [20, 20, 20, 20],
      autoPaging: "text",
      x: 20,
      y: 20,
      html2canvas: { scale: 0.7 }
    });
  });

  // ------------------ STUDENT LINK DISPLAY ------------------
  const studentLinkDisplay = document.getElementById("studentLinkDisplay");
  function updateStudentLink() {
    const url = window.location.href.split("#")[0] + "#student-form";
    studentLinkDisplay.textContent = url;
  }

  // On load, show student form if hash matches
  window.addEventListener("load", () => {
    if (window.location.hash === "#student-form") {
      sections.forEach(sec => sec.classList.remove("active"));
      sectionButtons.forEach(b => b.classList.remove("active"));
      document.getElementById("studentSection").classList.add("active");
      document.querySelector('nav button[data-section="studentSection"]').classList.add("active");
    }
  });

  // ------------------ INITIAL LOAD ------------------
  function refreshUI() {
    updateStructureSummary();
    updateLecturerList();
    updateLecturerSelect();
    updateFacultyDropdowns();
    updateCurrentClassStatus();
    updateStudentClassInfo();
    updateReportClassSelect();
  }

  loadData();
  setupSignaturePads();
  refreshUI();
  updateStudentLink();
</script>
</body>
</html>
