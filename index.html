<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple Attendance Register + Signature</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background: #f5f7fb; }
    .card { border-radius: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.06); }
    #signaturePad { border: 2px dashed #0d6efd; border-radius: 10px; background: white; cursor: crosshair; }
  </style>
</head>
<body>
<div class="container py-4">
  <h2 class="mb-4 text-center">Attendance Register With Signature</h2>

  <div class="row g-4">

    <!-- LEFT SECTION: Add Learners -->
    <div class="col-md-4">
      <div class="card p-3">
        <h5 class="mb-3">Register Learners</h5>

        <form id="studentForm" class="mb-3">
          <label class="form-label">Learner Name</label>
          <input type="text" id="studentName" class="form-control mb-2" required>

          <label class="form-label">Admission / ID</label>
          <input type="text" id="studentId" class="form-control mb-2" required>

          <button class="btn btn-primary w-100" type="submit">Add Learner</button>
        </form>

        <h6>Registered Learners</h6>
        <div class="table-responsive" style="max-height:260px;overflow-y:auto;">
          <table class="table table-sm table-striped">
            <thead><tr><th>#</th><th>Name</th><th>ID</th><th></th></tr></thead>
            <tbody id="studentsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- RIGHT SECTION -->
    <div class="col-md-8">

      <!-- Attendance -->
      <div class="card p-3 mb-3">
        <div class="d-flex flex-wrap gap-3 justify-content-between">
          <div>
            <label class="form-label mb-0">Date</label>
            <input type="date" id="attendanceDate" class="form-control">
          </div>

          <button id="saveAttendanceBtn" class="btn btn-success align-self-end">Save Attendance</button>

          <button id="exportCsvBtn" class="btn btn-outline-secondary align-self-end">Export CSV</button>
        </div>
      </div>

      <!-- Signature -->
      <div class="card p-3 mb-3">
        <h5>Signature</h5>
        <canvas id="signaturePad" width="500" height="200"></canvas>

        <div class="mt-2 d-flex gap-3">
          <button id="clearSignatureBtn" class="btn btn-warning">Clear</button>
          <button id="saveSignatureBtn" class="btn btn-primary">Save Signature</button>
        </div>

        <div class="mt-3">
          <h6>Saved Signature Preview:</h6>
          <img id="signaturePreview" src="" style="max-width:300px;border:1px solid #ddd;border-radius:6px;">
        </div>
      </div>

      <!-- Mark Attendance -->
      <div class="card p-3">
        <h5 class="mb-3">Mark Attendance</h5>
        <div class="table-responsive" style="max-height:350px;overflow-y:auto;">
          <table class="table table-bordered mb-0">
            <thead class="table-light">
              <tr><th>#</th><th>Name</th><th>ID</th><th class="text-center">Present?</th></tr>
            </thead>
            <tbody id="attendanceTableBody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  const STUDENTS_KEY = "attendance_students";
  const ATTENDANCE_KEY = "attendance_records";
  const SIGNATURE_KEY = "attendance_signatures";

  let students = [];
  let attendanceRecords = {};
  let signatures = {}; // date â†’ signaturePNG

  loadData();

  // Load stored data
  function loadData() {
    students = JSON.parse(localStorage.getItem(STUDENTS_KEY) || "[]");
    attendanceRecords = JSON.parse(localStorage.getItem(ATTENDANCE_KEY) || "{}");
    signatures = JSON.parse(localStorage.getItem(SIGNATURE_KEY) || "{}");
  }

  function saveAll() {
    localStorage.setItem(STUDENTS_KEY, JSON.stringify(students));
    localStorage.setItem(ATTENDANCE_KEY, JSON.stringify(attendanceRecords));
    localStorage.setItem(SIGNATURE_KEY, JSON.stringify(signatures));
  }

  // Render learners
  function renderStudents() {
    const tbody = document.getElementById("studentsTableBody");
    tbody.innerHTML = "";
    students.forEach((s, i) => {
      tbody.innerHTML += `
        <tr>
          <td>${i+1}</td>
          <td>${s.name}</td>
          <td>${s.id}</td>
          <td><button class="btn btn-sm btn-danger" onclick="deleteStudent('${s.id}')">X</button></td>
        </tr>`;
    });
  }

  function deleteStudent(id) {
    students = students.filter(s => s.id !== id);
    saveAll();
    renderStudents();
    renderAttendanceTable();
  }

  // Add student
  document.getElementById("studentForm").onsubmit = (e) => {
    e.preventDefault();
    let name = studentName.value.trim();
    let id = studentId.value.trim();
    if (!name || !id) return;

    students.push({ name, id });
    saveAll();
    studentName.value = "";
    studentId.value = "";
    renderStudents();
    renderAttendanceTable();
  };

  // Render attendance
  function renderAttendanceTable() {
    const date = attendanceDate.value;
    const tbody = document.getElementById("attendanceTableBody");
    tbody.innerHTML = "";

    if (!date) return;

    const dayRecord = attendanceRecords[date] || {};

    students.forEach((s, i) => {
      const checked = dayRecord[s.id] === "P" ? "checked" : "";
      tbody.innerHTML += `
        <tr>
          <td>${i+1}</td>
          <td>${s.name}</td>
          <td>${s.id}</td>
          <td class="text-center">
            <input type="checkbox" data-id="${s.id}" class="form-check-input" ${checked}>
          </td>
        </tr>`;
    });
  }

  attendanceDate.onchange = () => {
    renderAttendanceTable();
    loadSignaturePreview();
  };

  // Save attendance
  saveAttendanceBtn.onclick = () => {
    const date = attendanceDate.value;
    if (!date) return alert("Select date first.");

    if (!attendanceRecords[date]) attendanceRecords[date] = {};

    document.querySelectorAll("#attendanceTableBody input").forEach(cb => {
      const id = cb.dataset.id;
      attendanceRecords[date][id] = cb.checked ? "P" : "A";
    });

    saveAll();
    alert("Attendance saved!");
  };

  // ---------------- SIGNATURE PAD ----------------
  const canvas = document.getElementById("signaturePad");
  const ctx = canvas.getContext("2d");
  let drawing = false;

  canvas.addEventListener("mousedown", e => { drawing = true; draw(e); });
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("mouseup", () => drawing = false);
  canvas.addEventListener("mouseleave", () => drawing = false);

  function draw(e) {
    if (!drawing) return;
    const rect = canvas.getBoundingClientRect();
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "black";

    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
  }

  clearSignatureBtn.onclick = () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  };

  saveSignatureBtn.onclick = () => {
    const date = attendanceDate.value;
    if (!date) return alert("Select date first.");

    const dataUrl = canvas.toDataURL("image/png");
    signatures[date] = dataUrl;
    saveAll();
    loadSignaturePreview();
    alert("Signature saved!");
  };

  function loadSignaturePreview() {
    const date = attendanceDate.value;
    signaturePreview.src = signatures[date] || "";
  }

  // Export CSV
  exportCsvBtn.onclick = () => {
    let csv = "Date,ID,Name,Status\n";

    for (let date in attendanceRecords) {
      for (let id in attendanceRecords[date]) {
        const st = attendanceRecords[date][id];
        const student = students.find(s => s.id === id);
        csv += `${date},${id},${student?.name ?? ""},${st}\n`;
      }
    }

    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "attendance.csv";
    a.click();
  };

  // Init
  attendanceDate.value = new Date().toISOString().split("T")[0];
  renderStudents();
  renderAttendanceTable();
  loadSignaturePreview();
</script>

</body>
</html>
