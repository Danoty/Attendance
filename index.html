<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JOOUST Attendance Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Basic CSP (frontend-only) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' data: https:;
                 style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
                 font-src https://fonts.gstatic.com data:;
                 script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net;
                 connect-src 'self' https:;
                 base-uri 'self';
                 frame-ancestors 'none';
                 object-src 'none';
                 upgrade-insecure-requests">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --jooust-blue:#0052cc; --jooust-blue-dark:#003b8c; --jooust-green:#24a148; --jooust-gold:#f2c94c;
      --bg:#f4f7fb; --card:#ffffff; --text:#1f2933; --muted:#6b7280; --danger:#e11d48;
      --shadow: 0 10px 28px rgba(15,23,42,.10); --shadow2: 0 18px 40px rgba(15,23,42,.14);
      --radius: 16px;
    }
    *{ box-sizing:border-box; font-family: Inter, system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }
    body{ margin:0; background: var(--bg); color: var(--text); }
    header{
      background: linear-gradient(135deg, var(--jooust-blue-dark), var(--jooust-blue));
      color:#fff; padding: .9rem 1.2rem; position: sticky; top:0; z-index:50;
      box-shadow: 0 6px 22px rgba(0,0,0,.25);
    }
    .header-inner{ max-width: 1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap; }
    .brand{ display:flex; align-items:center; gap:.85rem; }
    .brand img{ height: 52px; width:auto; background:#fff; padding:6px; border-radius:10px; box-shadow: 0 8px 18px rgba(0,0,0,.20); }
    .brand h1{ margin:0; font-size:1.15rem; letter-spacing:.2px; line-height:1.25; }
    .brand h1 span{ display:block; font-size:.82rem; opacity:.92; font-weight:400; }
    .top-actions{ display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; justify-content:flex-end; }
    .user-pill{ display:flex; align-items:center; gap:.5rem; padding:.35rem .7rem; border-radius:999px;
      background: rgba(255,255,255,.14); border: 1px solid rgba(255,255,255,.22); font-size:.86rem; white-space:nowrap; }
    .user-pill b{ font-weight:800; }

    main{ max-width:1200px; margin:1.2rem auto 2.5rem; padding:0 1rem; }
    .hero{
      border-radius: var(--radius);
      background:
        radial-gradient(1200px 400px at 15% 10%, rgba(242,201,76,.25), transparent 55%),
        radial-gradient(1200px 400px at 85% 20%, rgba(36,161,72,.18), transparent 55%),
        linear-gradient(135deg, rgba(0,82,204,.10), rgba(0,59,140,.05));
      padding: 1rem 1.1rem; box-shadow: var(--shadow); margin-bottom: 1rem;
      border: 1px solid rgba(0,82,204,.12);
    }
    .hero h2{ margin:.1rem 0 .35rem; font-size: 1.1rem; display:flex; align-items:center; gap:.55rem; }
    .hero h2::before{
      content:""; width:7px; height:22px; border-radius:999px;
      background: linear-gradient(180deg, var(--jooust-green), var(--jooust-gold)); display:inline-block;
    }
    .hero p{ margin:0; color: var(--muted); font-size: .92rem; }

    .card{ background: var(--card); border-radius: var(--radius); padding: 1.25rem; margin-bottom: 1rem;
      box-shadow: var(--shadow); border: 1px solid rgba(15,23,42,.06); }
    .hidden{ display:none !important; }

    label{ font-size:.85rem; color: var(--muted); display:block; margin-bottom:.25rem; }
    input, select, textarea{
      width:100%; padding:.62rem .7rem; border-radius: 12px; border: 1px solid #d1d5db;
      font-size:.92rem; outline:none; transition: .15s ease; background:#f9fafb;
    }
    input:focus, select:focus, textarea:focus{
      border-color: var(--jooust-blue); box-shadow: 0 0 0 3px rgba(0,82,204,.14); background:#fff;
    }
    .row{ display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: .75rem 1rem; margin-bottom: .8rem; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:.45rem;
      padding:.62rem 1rem; border-radius: 999px; border:none; cursor:pointer;
      font-size:.92rem; font-weight:800; transition: transform .08s ease, box-shadow .08s ease, filter .15s ease;
      white-space:nowrap; user-select:none;
    }
    .btn:active{ transform: translateY(1px); box-shadow:none; }
    .btn-primary{ background: linear-gradient(135deg, var(--jooust-blue), var(--jooust-blue-dark)); color:#fff; box-shadow: 0 10px 18px rgba(0,82,204,.28); }
    .btn-success{ background: linear-gradient(135deg, var(--jooust-green), #16a34a); color:#fff; box-shadow: 0 10px 18px rgba(22,163,74,.25); }
    .btn-secondary{ background:#e5e7eb; color:#111827; }
    .btn-danger{ background: var(--danger); color:#fff; box-shadow: 0 10px 18px rgba(225,29,72,.18); }
    .btn-outline{ background: transparent; border: 1px solid rgba(255,255,255,.35); color:#fff; }
    .btn:hover{ filter: brightness(1.03); }

    .btn-group{ display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.5rem; }

    .chip{ display:inline-flex; align-items:center; gap:.35rem; padding:.22rem .65rem; border-radius:999px;
      font-size:.78rem; background:#e5f5ff; color:#075985; border: 1px solid rgba(7,89,133,.12); }
    .chip.green{ background:#dcfce7; color:#166534; border-color: rgba(22,101,52,.12); }
    .chip.red{ background:#fee2e2; color:#b91c1c; border-color: rgba(185,28,28,.12); }

    .tabs{ display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.5rem; }
    .tab{ padding:.45rem .95rem; border-radius:999px; font-size:.9rem; border: 1px solid #d1d5db;
      background:#f3f4f6; cursor:pointer; font-weight:900; }
    .tab.active{ background: var(--jooust-blue); border-color: var(--jooust-blue-dark); color:#fff; }

    table{ width:100%; border-collapse: collapse; font-size: .85rem; margin-top:.6rem; overflow:hidden; border-radius: 14px; }
    th, td{ border: 1px solid #e5e7eb; padding:.55rem .5rem; text-align:left; vertical-align: top; }
    th{ background:#eff6ff; color:#1d4ed8; font-weight:900; }
    tr:nth-child(even) td{ background:#f9fafb; }

    .badge{ padding:.1rem .55rem; border-radius:999px; font-size:.72rem; font-weight:900; background:#e5e7eb; }
    .badge.open{ background:#dcfce7; color:#166534; }
    .badge.closed{ background:#fee2e2; color:#b91c1c; }

    .muted{ color: var(--muted); font-size:.9rem; }
    .small{ font-size:.82rem; color: var(--muted); }

    .alert{ padding:.7rem .85rem; border-radius: 14px; font-size:.9rem; margin-bottom:.75rem;
      border: 1px solid rgba(15,23,42,.06); white-space: pre-wrap; }
    .alert-info{ background:#e0f2fe; color:#0b5394; border-color: rgba(11,83,148,.15); }
    .alert-danger{ background:#fee2e2; color:#991b1b; border-color: rgba(153,27,27,.14); }
    .alert-success{ background:#dcfce7; color:#166534; border-color: rgba(22,101,52,.14); }

    .signature-pad{
      border: 2px dashed rgba(0,82,204,.35);
      border-radius: 14px;
      background:#fff;
      width:100%;
      height: 150px;
      cursor: crosshair;
      box-shadow: inset 0 2px 10px rgba(15,23,42,.05);
      touch-action: none;
    }
    .signature-actions{ display:flex; justify-content:flex-end; gap:.4rem; margin-top:.35rem; }

    .footer{ margin-top: 1.2rem; padding: .9rem 1rem; text-align:center; color: rgba(31,41,51,.75); font-size:.86rem; }
    .footer b{ color: var(--jooust-blue-dark); }

    .kpi-grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:.75rem; margin-top:.9rem; }
    .kpi{
      border:1px solid rgba(0,82,204,.12);
      background: linear-gradient(135deg, rgba(0,82,204,.08), rgba(36,161,72,.05));
      border-radius:14px; padding:.8rem .9rem; box-shadow: 0 10px 22px rgba(15,23,42,.06);
    }
    .kpi .v{ font-size:1.1rem; font-weight:900; color: var(--jooust-blue-dark); }
    .kpi .t{ font-size:.82rem; color: var(--muted); margin-top:.1rem; }

    .qrBox{
      border:1px dashed rgba(0,82,204,.35);
      border-radius:14px;
      padding:.7rem;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      background:#f8fafc;
      margin-top:.6rem;
    }
    .qr{ width:140px; height:140px; background:#fff; border-radius:12px; padding:8px; border:1px solid #e5e7eb; }
    .qrMeta{ flex:1; min-width: 220px; }
    .linkBox{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:.55rem .65rem;
      font-size:.86rem;
      overflow:auto;
      max-height: 78px;
    }

    .miniSig{
      height: 36px;
      border:1px solid #e5e7eb;
      border-radius:10px;
      background:#fff;
      padding:2px;
    }

    @media (max-width:640px){
      .brand img{ height:46px; }
      .brand h1{ font-size: 1.05rem; }
      .signature-pad{ height: 170px; }
    }

    @media print{
      header, .tabs, .btn, .btn-group, .footer, #pwdModal, #sessionModal, #sigModal { display:none !important; }
      body{ background:#fff; }
      .card{ box-shadow:none; border:1px solid #e5e7eb; }
    }
  </style>

  <!-- Export libs -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- ✅ Charts (Student % + Graphs) -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
<header id="mainHeader">
  <div class="header-inner">
    <div class="brand">
      <img src="logo.jpg" alt="JOOUST Logo" />
      <h1>
        JOOUST Attendance System
        <span>Lectures · Staff Meetings · Digital Signatures · Smart Reports</span>
      </h1>
    </div>

    <div class="top-actions">
      <div id="userSummary" class="user-pill hidden"></div>
      <button id="openChangePwdBtn" class="btn btn-outline hidden" title="Change Password">Change Password</button>
      <button id="logoutBtn" class="btn btn-outline hidden" title="Logout">Logout</button>
    </div>
  </div>
</header>

<main>
  <div class="hero">
    <h2>Smart Attendance for Lectures & Meetings</h2>
    <p>
      Fast sign-in, digital signatures, class/meeting links (QR supported), and official exports (PDF/Word/Excel/CSV).
      Participants can sign using mobile phones (finger signature supported).
    </p>

    <div class="kpi-grid">
      <div class="kpi"><div class="v">Geo-Fenced</div><div class="t">Physical sessions can enforce within 1km of JOOUST</div></div>
      <div class="kpi"><div class="v">Online Meetings</div><div class="t">Staff can sign remotely for online meetings</div></div>
      <div class="kpi"><div class="v">Signatures</div><div class="t">Finger or mouse on phone/laptop</div></div>
      <div class="kpi"><div class="v">Academic Year</div><div class="t">Filters + reports include academic year (e.g. 2025/2026)</div></div>
    </div>
  </div>

  <!-- LOGIN -->
  <section id="loginSection" class="card">
    <h2 style="margin:0 0 .6rem;display:flex;align-items:center;gap:.55rem;">
      <span style="width:10px;height:10px;border-radius:999px;background:linear-gradient(135deg,var(--jooust-green),var(--jooust-gold));display:inline-block;"></span>
      Login
    </h2>

    <div class="row">
      <div>
        <label>Login as</label>
        <div style="display:flex;gap:.9rem;flex-wrap:wrap;">
          <label style="display:flex;align-items:center;gap:.45rem;color:var(--text);">
            <input type="radio" name="loginRole" value="admin" checked />
            Admin
          </label>
          <label style="display:flex;align-items:center;gap:.45rem;color:var(--text);">
            <input type="radio" name="loginRole" value="lecturer" />
            Lecturer
          </label>
        </div>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="loginUsername">Username</label>
        <input id="loginUsername" type="text" placeholder="Enter username" autocomplete="username" />
      </div>
      <div>
        <label for="loginPassword">Password</label>
        <input id="loginPassword" type="password" placeholder="Enter password" autocomplete="current-password" />
      </div>
    </div>

    <div class="btn-group">
      <button class="btn btn-primary" id="loginBtn">Login</button>
      <button class="btn btn-secondary" id="showLecturerRegistration">Register as Lecturer</button>
    </div>

    <div id="loginMessage" class="alert hidden"></div>
  </section>

  <!-- LECTURER REGISTRATION -->
  <section id="lecturerRegistrationSection" class="card hidden">
    <h2 style="margin:0 0 .6rem;">Lecturer Registration</h2>
    <div class="alert alert-info">
      Your account will be <b>pending</b> until approved by the Admin.
    </div>

    <div class="row">
      <div>
        <label for="regSalutation">Salutation</label>
        <select id="regSalutation">
          <option value="Dr.">Dr.</option>
          <option value="Mr.">Mr.</option>
          <option value="Mrs.">Mrs.</option>
          <option value="Ms.">Ms.</option>
          <option value="Prof.">Prof.</option>
        </select>
      </div>
      <div>
        <label for="regFullName">Full Name</label>
        <input id="regFullName" type="text" placeholder="e.g. Jane Doe" />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="regPF">PF No / ID</label>
        <input id="regPF" type="text" />
      </div>
      <div>
        <label for="regUsername">Preferred Username</label>
        <input id="regUsername" type="text" placeholder="e.g. jdoe" />
      </div>
      <div>
        <label for="regPassword">Password</label>
        <input id="regPassword" type="password" />
      </div>
    </div>

    <div class="btn-group">
      <button class="btn btn-primary" id="submitLecturerRegistration">Submit Registration</button>
      <button class="btn btn-secondary" id="backToLogin">Back to Login</button>
    </div>

    <div id="lecturerRegMessage" class="alert hidden"></div>
  </section>

  <!-- PARTICIPANT VIEW (Student / Staff) -->
  <section id="studentSection" class="card hidden">
    <h2 id="participantTitle" style="margin:0 0 .6rem;">Attendance Sign-In</h2>
    <div id="studentClassInfo" class="alert alert-info"></div>

    <div id="studentGeoInfo" class="alert alert-info hidden"></div>

    <div id="studentAlreadySubmitted" class="alert alert-success hidden">
      You have already submitted attendance for this session on this device.
    </div>

    <div id="studentFormWrapper">
      <!-- Meeting Staff No -->
      <div class="row hidden" id="staffNoRow">
        <div>
          <label for="stStaffNo">Staff No / PF No</label>
          <input id="stStaffNo" type="text" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="stSurname">Surname</label>
          <input id="stSurname" type="text" />
        </div>
        <div>
          <label for="stMiddleName">Middle Name</label>
          <input id="stMiddleName" type="text" />
        </div>
        <div>
          <label for="stFirstName">First Name</label>
          <input id="stFirstName" type="text" />
        </div>
      </div>

      <!-- Class Admission -->
      <div class="row" id="idRow">
        <div>
          <label id="idLabel" for="stAdmission">Admission Number</label>
          <input id="stAdmission" type="text" />
        </div>
      </div>

      <label>Digital Signature (use finger or mouse)</label>
      <canvas id="stSignaturePad" class="signature-pad"></canvas>
      <div class="signature-actions">
        <button class="btn btn-secondary" id="stClearSignature">Clear</button>
      </div>

      <div class="btn-group">
        <button class="btn btn-success" id="stSubmit">Submit Attendance</button>
      </div>

      <div id="studentSubmitMsg" class="alert hidden" style="margin-top:.8rem;"></div>
    </div>

    <div class="small" id="geoNote" style="margin-top:.8rem;">
      Note: Physical sessions may ask for location access (GPS) to confirm you are within JOOUST (1km radius).
    </div>
  </section>

  <!-- ADMIN DASHBOARD -->
  <section id="adminDashboard" class="hidden">
    <div class="card">
      <h2 style="margin:0;">Admin Dashboard</h2>
      <div class="tabs">
        <button class="tab active" data-admin-tab="lecturersTab">Lecturers</button>
        <button class="tab" data-admin-tab="facultyTab">Faculty / Course / Unit Upload</button>
        <button class="tab" data-admin-tab="classesTab">Sessions</button>
        <button class="tab" data-admin-tab="reportsTab">Reports</button>
        <button class="tab" data-admin-tab="exportsTab">Raw Exports</button>
      </div>
    </div>

    <!-- Lecturers -->
    <section id="lecturersTab" class="card admin-tab">
      <div style="display:flex;justify-content:space-between;gap:1rem;flex-wrap:wrap;align-items:flex-end;">
        <div>
          <h3 style="margin:.1rem 0;">Lecturer Accounts</h3>
          <div class="small">Approve new registrations & manage accounts.</div>
        </div>
      </div>
      <div id="lecturersTableWrapper" class="muted">No lecturers yet.</div>
    </section>

    <!-- Faculty CSV -->
    <section id="facultyTab" class="card admin-tab hidden">
      <div style="display:flex;justify-content:space-between;gap:1rem;flex-wrap:wrap;align-items:flex-end;">
        <div>
          <h3 style="margin:.1rem 0;">Faculty / Course / Unit Mapping</h3>
          <div class="small">Upload CSV to populate dropdown lists (Faculty, Course, Unit, Study Year, Semester, Academic Year).</div>
        </div>
      </div>

      <div class="alert alert-info">
        CSV Structure (recommended): <code>Faculty,Course,Unit,Year,Semester,AcademicYear</code><br />
        Example AcademicYear: <code>2025/2026</code><br/>
        <span class="small">Backward compatible: if you upload old 5-column CSV, AcademicYear will be set automatically.</span>
      </div>

      <input type="file" id="facultyCsvInput" accept=".csv" />

      <div class="btn-group">
        <button class="btn btn-primary" id="uploadFacultyCsvBtn">Upload & Save</button>
        <button class="btn btn-secondary" id="clearFacultyDataBtn">Clear All Mappings</button>
      </div>

      <div id="facultyUploadMsg" class="alert hidden" style="margin-top:.8rem;"></div>

      <h4 style="margin-top:1rem;margin-bottom:.4rem;">Current Records</h4>
      <div id="facultySummary" class="muted"></div>
    </section>

    <!-- Sessions -->
    <section id="classesTab" class="card admin-tab hidden">
      <div style="display:flex;justify-content:space-between;gap:1rem;flex-wrap:wrap;align-items:flex-end;">
        <div>
          <h3 style="margin:.1rem 0;">All Sessions</h3>
          <div class="small">Monitor all lectures and staff meetings and view attendance + signatures.</div>
        </div>

        <div style="min-width:260px;">
          <label for="adminClassFilter">Quick Filter (Unit / Lecturer / Course / Meeting / Academic Year)</label>
          <select id="adminClassFilter"></select>
        </div>
      </div>

      <div id="adminClassesTableWrapper" class="muted">No sessions created yet.</div>
    </section>

    <!-- Reports -->
    <section id="reportsTab" class="card admin-tab hidden">
      <h3 style="margin:.1rem 0 .25rem;">Reports</h3>
      <div class="muted" style="margin-bottom:.8rem;">
        Filter sessions and export official reports. You can also download <b>ALL matching session reports</b> as one Excel workbook.
      </div>

      <div class="row">
        <div>
          <label for="repAcademicYear">Academic Year</label>
          <select id="repAcademicYear"></select>
        </div>
        <div>
          <label for="repFaculty">Faculty</label>
          <select id="repFaculty"></select>
        </div>
        <div>
          <label for="repCourse">Course</label>
          <select id="repCourse"></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="repUnit">Unit</label>
          <select id="repUnit"></select>
        </div>
        <div>
          <label for="repYear">Study Year</label>
          <select id="repYear"></select>
        </div>
        <div>
          <label for="repSemester">Semester</label>
          <select id="repSemester"></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="repStatus">Status</label>
          <select id="repStatus">
            <option value="">All</option>
            <option value="open">Open</option>
            <option value="closed">Closed</option>
          </select>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" id="generateReportBtn">Generate Report</button>
        <button class="btn btn-secondary" id="downloadAllReportsBtn">Download ALL Reports (Excel)</button>
      </div>

      <div id="reportArea" class="hidden" style="margin-top:1rem;">
        <div class="btn-group">
          <button class="btn btn-primary" id="exportPdfBtn">Download PDF</button>
          <button class="btn btn-secondary" id="exportWordBtn">Download Word</button>
          <button class="btn btn-secondary" id="exportExcelBtn">Download Excel</button>
        </div>

        <div id="reportMeta" class="muted" style="margin-top:.6rem;"></div>
        <table id="reportTable"></table>
      </div>

      <!-- ✅ NEW: Student Report (percentage + chart) -->
      <hr style="margin:1.2rem 0;border:none;border-top:1px solid #e5e7eb;"/>

      <h3 style="margin:.1rem 0 .25rem;">Student Report (With % + Chart)</h3>
      <div class="muted" style="margin-bottom:.8rem;">
        Generate an individual student attendance report for a particular period (date range) and get attendance percentage + chart.
      </div>

      <div class="row">
        <div>
          <label for="stuReportIdType">ID Type</label>
          <select id="stuReportIdType">
            <option value="admission">Admission No (Class)</option>
            <option value="staffNo">Staff No (Meeting)</option>
          </select>
        </div>

        <div>
          <label for="stuReportId">Student/Staff ID</label>
          <input id="stuReportId" type="text" placeholder="e.g. BIT/1234/2024 or PF12345" />
        </div>

        <div>
          <label for="stuReportFrom">From</label>
          <input id="stuReportFrom" type="date" />
        </div>

        <div>
          <label for="stuReportTo">To</label>
          <input id="stuReportTo" type="date" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="stuReportGrouping">Chart Grouping</label>
          <select id="stuReportGrouping">
            <option value="day">By Day</option>
            <option value="week">By Week</option>
            <option value="unit">By Unit</option>
          </select>
        </div>

        <div>
          <label for="stuReportOnlyOpenClosed">Include Sessions</label>
          <select id="stuReportOnlyOpenClosed">
            <option value="">Open + Closed</option>
            <option value="open">Open only</option>
            <option value="closed">Closed only</option>
          </select>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" id="generateStudentReportBtn">Generate Student Report</button>
      </div>

      <div id="studentReportMsg" class="alert hidden" style="margin-top:.8rem;"></div>

      <div id="studentReportArea" class="hidden" style="margin-top:1rem;">
        <div class="kpi-grid" style="margin-top:.2rem;">
          <div class="kpi"><div class="v" id="srTotalSessions">0</div><div class="t">Total sessions in period</div></div>
          <div class="kpi"><div class="v" id="srAttendedSessions">0</div><div class="t">Attended sessions</div></div>
          <div class="kpi"><div class="v" id="srPercent">0%</div><div class="t">Attendance percentage</div></div>
        </div>

        <div class="card" style="margin-top:1rem;">
          <h4 style="margin:.1rem 0 .6rem;">Attendance Chart</h4>
          <canvas id="studentReportChart" style="width:100%;max-height:340px;"></canvas>
        </div>

        <h4 style="margin:1rem 0 .35rem;">Sessions Breakdown</h4>
        <table id="studentReportTable"></table>
      </div>
      <!-- /Student report -->
    </section>

    <!-- Raw exports -->
    <section id="exportsTab" class="card admin-tab hidden">
      <h3 style="margin:.1rem 0 .25rem;">Raw Attendance Export</h3>
      <div class="muted" style="margin-bottom:.8rem;">
        Export attendance including signatures data.
      </div>

      <div class="row">
        <div>
          <label for="rawClassPick">Pick Session</label>
          <select id="rawClassPick"></select>
        </div>
        <div>
          <label>Export Format</label>
          <div class="btn-group" style="margin-top:.2rem;">
            <button class="btn btn-primary" id="rawExportCsvBtn">Download CSV</button>
            <button class="btn btn-secondary" id="rawExportExcelBtn">Download Excel</button>
          </div>
        </div>
      </div>
      <div id="rawExportMsg" class="alert hidden"></div>

      <div class="small" style="margin-top:.6rem;">
        Note: Signature is exported as a <b>data URL</b> (base64). This is best for archiving/verification.
      </div>
    </section>
  </section>

  <!-- LECTURER DASHBOARD -->
  <section id="lecturerDashboard" class="hidden">
    <section class="card">
      <h2 style="margin:0;">Lecturer Dashboard</h2>
      <p class="muted" style="margin:.4rem 0 0;">
        Create sessions (classes or staff meetings), share link (QR), view attendance & export official reports.
      </p>
    </section>

    <!-- Create session -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;gap:1rem;flex-wrap:wrap;align-items:flex-end;">
        <div>
          <h3 style="margin:.1rem 0;">Create / Start Session</h3>
          <div class="small">For classes pick from mappings; for staff meetings, you can set mode physical/online.</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="lcType">Session Type</label>
          <select id="lcType">
            <option value="class">Lecture / Class</option>
            <option value="meeting">Staff Meeting</option>
          </select>
        </div>

        <div id="meetingModeWrap">
          <label for="lcMeetingMode">Meeting Mode</label>
          <select id="lcMeetingMode">
            <option value="physical">Physical (Geo-fenced)</option>
            <option value="online">Online (No Geo-fence)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="lcAcademicYear">Academic Year</label>
          <select id="lcAcademicYear"></select>
        </div>
        <div>
          <label for="lcFaculty">Faculty</label>
          <select id="lcFaculty"></select>
        </div>
        <div>
          <label for="lcCourse">Course</label>
          <select id="lcCourse"></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="lcUnit">Unit</label>
          <select id="lcUnit"></select>
        </div>
        <div>
          <label for="lcUnitCode">Unit Code</label>
          <input id="lcUnitCode" type="text" placeholder="e.g. CSC 210" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="lcYear">Study Year</label>
          <select id="lcYear"></select>
        </div>
        <div>
          <label for="lcSemester">Semester</label>
          <select id="lcSemester"></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="lcVenue">Venue / Platform</label>
          <input id="lcVenue" type="text" placeholder="e.g. LT1 / Zoom / Teams / Lab 3" />
        </div>
        <div>
          <label for="lcDateTime">Date & Time</label>
          <input id="lcDateTime" type="datetime-local" />
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-success" id="createClassBtn">Create / Start</button>
      </div>
      <div id="createClassMsg" class="alert hidden" style="margin-top:.8rem;"></div>
    </section>

    <!-- My sessions -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;gap:1rem;flex-wrap:wrap;align-items:flex-end;">
        <div>
          <h3 style="margin:.1rem 0;">My Sessions</h3>
          <div class="small">Copy link/QR, close/open, view attendance & export.</div>
        </div>
        <div style="min-width:260px;">
          <label for="lecClassFilter">Quick Filter</label>
          <select id="lecClassFilter"></select>
        </div>
      </div>
      <div id="lecturerClassesTableWrapper" class="muted">No sessions yet.</div>
    </section>

    <!-- Lecturer reports -->
    <section class="card">
      <h3 style="margin:.1rem 0 .25rem;">Quick Reports (My Sessions)</h3>
      <p class="muted" style="margin:.35rem 0 .9rem;">
        Filter and export official reports.
      </p>

      <div class="row">
        <div><label for="repAcademicYearL">Academic Year</label><select id="repAcademicYearL"></select></div>
        <div><label for="repFacultyL">Faculty</label><select id="repFacultyL"></select></div>
        <div><label for="repCourseL">Course</label><select id="repCourseL"></select></div>
      </div>
      <div class="row">
        <div><label for="repUnitL">Unit</label><select id="repUnitL"></select></div>
        <div><label for="repYearL">Study Year</label><select id="repYearL"></select></div>
        <div><label for="repSemesterL">Semester</label><select id="repSemesterL"></select></div>
      </div>
      <div class="row">
        <div>
          <label for="repStatusL">Status</label>
          <select id="repStatusL">
            <option value="">All</option>
            <option value="open">Open</option>
            <option value="closed">Closed</option>
          </select>
        </div>
      </div>

      <div class="btn-group">
        <button class="btn btn-primary" id="generateReportLecturerBtn">Generate My Report</button>
      </div>

      <div id="reportAreaLecturer" class="hidden" style="margin-top:1rem;">
        <div class="btn-group">
          <button class="btn btn-primary" id="exportPdfBtnL">Download PDF</button>
          <button class="btn btn-secondary" id="exportWordBtnL">Download Word</button>
          <button class="btn btn-secondary" id="exportExcelBtnL">Download Excel</button>
        </div>

        <div id="reportMetaL" class="muted" style="margin-top:.6rem;"></div>
        <table id="reportTableL"></table>
      </div>
    </section>
  </section>

  <div class="footer">
    System created by <b>Gerotech</b> <b>Enterprises</b> <b>@2025</b>.
  </div>
</main>

<!-- Change Password Modal -->
<div id="pwdModal" class="hidden" style="position:fixed;inset:0;z-index:9999;background:rgba(15,23,42,.62);display:flex;align-items:center;justify-content:center;padding:1rem;">
  <div class="card" style="width:min(520px,96%);box-shadow:var(--shadow2);">
    <h3 style="margin:.1rem 0 .6rem;">Change Password</h3>
    <div class="row">
      <div>
        <label for="pwdOld">Current Password</label>
        <input id="pwdOld" type="password" />
      </div>
    </div>
    <div class="row">
      <div>
        <label for="pwdNew">New Password</label>
        <input id="pwdNew" type="password" />
      </div>
      <div>
        <label for="pwdNew2">Confirm New Password</label>
        <input id="pwdNew2" type="password" />
      </div>
    </div>

    <div class="btn-group">
      <button class="btn btn-primary" id="pwdSaveBtn">Save</button>
      <button class="btn btn-secondary" id="pwdCloseBtn">Close</button>
    </div>
    <div id="pwdMsg" class="alert hidden" style="margin-top:.8rem;"></div>
  </div>
</div>

<!-- Session modal (view link/QR/attendance/export/sign) -->
<div id="sessionModal" class="hidden" style="position:fixed;inset:0;z-index:9998;background:rgba(15,23,42,.62);display:flex;align-items:center;justify-content:center;padding:1rem;">
  <div class="card" style="width:min(980px,96%);max-height:90vh;overflow:auto;box-shadow:var(--shadow2);">
    <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap;">
      <div>
        <h3 style="margin:.1rem 0 .2rem;" id="sessionModalTitle">Session</h3>
        <div class="small" id="sessionModalMeta"></div>
      </div>
      <div class="btn-group" style="margin-top:0;">
        <button class="btn btn-secondary" id="sessionModalPrintBtn">Print</button>
        <button class="btn btn-secondary" id="sessionModalCloseBtn">Close</button>
      </div>
    </div>

    <div class="qrBox" id="sessionLinkBox">
      <div class="qr" id="qrTarget"></div>
      <div class="qrMeta">
        <div class="small"><b>Share this sign-in link</b> (works on phones)</div>
        <div class="linkBox" id="sessionLinkText"></div>
        <div class="btn-group">
          <button class="btn btn-primary" id="copyLinkBtn">Copy Link</button>
          <button class="btn btn-secondary" id="openLinkBtn">Open Link</button>
        </div>
      </div>
    </div>

    <div class="btn-group">
      <button class="btn btn-success" id="toggleStatusBtn">Close Session</button>
      <button class="btn btn-primary" id="exportSessionPdfBtn">Download PDF</button>
      <button class="btn btn-secondary" id="exportSessionWordBtn">Download Word</button>
      <button class="btn btn-secondary" id="exportSessionExcelBtn">Download Excel</button>
      <button class="btn btn-secondary" id="exportSessionCsvBtn">Download CSV</button>
      <button class="btn btn-secondary" id="lecturerSignBtn">Add Lecturer Signature</button>
      <button class="btn btn-secondary hidden" id="hodSignBtn">Add HOD Signature (Admin)</button>
    </div>

    <div class="alert hidden" id="sessionModalMsg"></div>

    <h4 style="margin:1rem 0 .35rem;">Attendance (Signatures included)</h4>
    <div class="muted" id="sessionAttendanceMeta"></div>
    <table id="sessionAttendanceTable"></table>
  </div>
</div>

<!-- Signature modal (lecturer/hod) -->
<div id="sigModal" class="hidden" style="position:fixed;inset:0;z-index:9999;background:rgba(15,23,42,.62);display:flex;align-items:center;justify-content:center;padding:1rem;">
  <div class="card" style="width:min(720px,96%);box-shadow:var(--shadow2);">
    <h3 style="margin:.1rem 0 .6rem;" id="sigModalTitle">Signature</h3>

    <div id="hodNameWrap" class="row hidden">
      <div>
        <label for="hodNameInput">HOD Name</label>
        <input id="hodNameInput" type="text" placeholder="e.g. Dr. John Doe" />
      </div>
    </div>

    <label>Draw Signature</label>
    <canvas id="sigPad" class="signature-pad"></canvas>
    <div class="signature-actions">
      <button class="btn btn-secondary" id="sigClearBtn">Clear</button>
    </div>

    <div class="btn-group">
      <button class="btn btn-primary" id="sigSaveBtn">Save</button>
      <button class="btn btn-secondary" id="sigCancelBtn">Cancel</button>
    </div>
    <div id="sigMsg" class="alert hidden" style="margin-top:.8rem;"></div>
  </div>
</div>

<script>
/* ===========================
   STORAGE + BASE DATA
=========================== */
const STORAGE_KEY = "jooust_attendance_data_v6_merged";

/* JOOUST Center (Approx) */
const JOOUST_CENTER = { lat: -0.0936, lon: 34.2809 };
const GEOFENCE_RADIUS_KM = 1.0;

/* Session timeout (frontend-only) */
const SESSION_TIMEOUT_MIN = 20;
let lastActivityTs = Date.now();

function touchActivity(){ lastActivityTs = Date.now(); }
["click","keydown","mousemove","touchstart"].forEach(ev => window.addEventListener(ev, touchActivity, {passive:true}));
setInterval(()=>{
  if(!currentUser) return;
  const mins = (Date.now() - lastActivityTs) / 60000;
  if(mins >= SESSION_TIMEOUT_MIN){
    currentUser = null;
    updateTopBar();
    showSection("loginSection");
    alert("Session timed out for security. Please login again.");
  }
}, 15000);

function getDefaultAcademicYear(){
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth()+1;
  const start = (m >= 9) ? y : (y-1);
  return `${start}/${start+1}`;
}

function baseData(){
  return {
    version: 6,
    admins: [{ username:"admin", password:"admin123" }],
    lecturers: [],
    facultyConfig: [],
    classes: [],
    attendance: []
  };
}

function migrateData(d){
  d.admins = d.admins || [{ username:"admin", password:"admin123" }];
  d.lecturers = d.lecturers || [];
  d.facultyConfig = d.facultyConfig || [];
  d.classes = d.classes || [];
  d.attendance = d.attendance || [];

  const defAY = getDefaultAcademicYear();

  d.facultyConfig = d.facultyConfig.map(r=>({
    faculty: r.faculty || "",
    course: r.course || "",
    unit: r.unit || "",
    year: r.year || "",
    semester: r.semester || "",
    academicYear: r.academicYear || r.academic_year || defAY
  }));

  d.classes = d.classes.map(c=>({
    id: c.id || (Date.now().toString(36)+Math.random().toString(36).slice(2,8)),
    type: c.type || "class",
    meetingMode: c.meetingMode || (c.type==="meeting" ? "online" : "physical"),
    academicYear: c.academicYear || c.academic_year || (c.type==="meeting" ? "" : defAY),
    unitCode: c.unitCode || c.unit_code || "",
    lecturerId: c.lecturerId || "",
    faculty: c.faculty || "",
    course: c.course || "",
    unit: c.unit || (c.type==="meeting" ? "Staff Meeting" : ""),
    year: c.year || "",
    semester: c.semester || "",
    venue: c.venue || "",
    dateTime: c.dateTime || c.date_time || "",
    status: c.status || "open",
    lecturerName: c.lecturerName || c.lecturer_name || "",
    lecturerSignature: c.lecturerSignature || null,
    hodName: c.hodName || "",
    hodSignature: c.hodSignature || null,
    createdAt: c.createdAt || Date.now()
  }));

  d.attendance = d.attendance.map(a=>({
    id: a.id || (Date.now().toString(36)+Math.random().toString(36).slice(2,8)),
    classId: a.classId || a.class_id || "",
    surname: a.surname || "",
    middle: a.middle || "",
    first: a.first || "",
    admission: a.admission || "",
    staffNo: a.staffNo || "",
    signature: a.signature || "",
    createdAt: a.createdAt || Date.now(),
    geo: a.geo || null,
    deviceId: a.deviceId || ""
  }));

  d.version = 6;
  return d;
}

function loadData(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){
    const b = baseData();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(b));
    return b;
  }
  try{
    return migrateData(JSON.parse(raw));
  } catch(e){
    const b = baseData();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(b));
    return b;
  }
}
function saveData(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(migrateData(d))); }
let DATA = loadData();

let currentUser = null;
let jooustLogoDataUrl = null;

function $(id){ return document.getElementById(id); }
function showSection(id){
  ["loginSection","lecturerRegistrationSection","adminDashboard","lecturerDashboard","studentSection"].forEach(sid=>{
    const el = $(sid); if(!el) return;
    el.classList.toggle("hidden", sid !== id);
  });
}

function uuid(){ return Date.now().toString(36) + "-" + Math.random().toString(36).substring(2,10); }
function setAlert(el, msg, type="info"){
  el.textContent = msg;
  el.classList.remove("hidden","alert-info","alert-danger","alert-success");
  if(type==="danger") el.classList.add("alert-danger");
  else if(type==="success") el.classList.add("alert-success");
  else el.classList.add("alert-info");
}
function clearAlert(el){ el.classList.add("hidden"); }

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function formatDateTime(dt){
  if(!dt) return "";
  const d = new Date(dt);
  if(isNaN(d)) return dt;
  return d.toLocaleDateString() + " " + d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
}
function getQueryParam(name){
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(name);
}
function unique(arr){ return [...new Set(arr)].filter(x=>x!=null && x!=="").sort((a,b)=>a.localeCompare(b)); }

function setOptions(selectEl, values, placeholder="All / Select"){
  if(!selectEl) return;
  const cur = selectEl.value;
  selectEl.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = placeholder;
  selectEl.appendChild(opt0);

  values.forEach(v=>{
    const o = document.createElement("option");
    o.value = v;
    o.textContent = v;
    selectEl.appendChild(o);
  });
  if(cur && values.includes(cur)) selectEl.value = cur;
}

function loadLogoAsDataUrl(){
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.src = "logo.jpg";
  img.onload = ()=>{
    try{
      const canvas = document.createElement("canvas");
      canvas.width = img.width; canvas.height = img.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img,0,0);
      jooustLogoDataUrl = canvas.toDataURL("image/jpeg");
    }catch(e){ jooustLogoDataUrl = null; }
  };
}
loadLogoAsDataUrl();

/* ===========================
   Signature pads
=========================== */
function setupSignaturePad(canvas, opts={}){
  const ctx = canvas.getContext("2d");
  ctx.lineWidth = opts.lineWidth || 2.2;
  ctx.lineCap = "round";

  function resize(){
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    const rect = canvas.getBoundingClientRect();
    const prev = canvas.toDataURL("image/png");
    canvas.width = Math.floor(rect.width * ratio);
    canvas.height = Math.floor(rect.height * ratio);
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
    if(prev && prev.length > 50){
      const img = new Image();
      img.onload = ()=> ctx.drawImage(img, 0, 0, rect.width, rect.height);
      img.src = prev;
    }
  }
  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    const point = e.touches ? e.touches[0] : e;
    return { x: point.clientX - rect.left, y: point.clientY - rect.top };
  }
  let drawing = false;
  function start(e){
    e.preventDefault();
    drawing = true;
    const p = getPos(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
  }
  function move(e){
    if(!drawing) return;
    e.preventDefault();
    const p = getPos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
  }
  function end(){ drawing = false; }

  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", move);
  window.addEventListener("mouseup", end);
  canvas.addEventListener("touchstart", start, {passive:false});
  canvas.addEventListener("touchmove", move, {passive:false});
  window.addEventListener("touchend", end);
  window.addEventListener("resize", ()=> resize());
  resize();

  return {
    clear: ()=> ctx.clearRect(0,0, canvas.width, canvas.height),
    toDataUrl: ()=> canvas.toDataURL("image/png"),
    isBlank: ()=> {
      const tmp = document.createElement("canvas");
      tmp.width = canvas.width; tmp.height = canvas.height;
      return tmp.toDataURL() === canvas.toDataURL();
    }
  };
}
const stSig = setupSignaturePad($("stSignaturePad"));
$("stClearSignature").addEventListener("click", ()=> stSig.clear());

/* ===========================
   Top bar + logout + change pwd
=========================== */
function updateTopBar(){
  const summary = $("userSummary");
  const logoutBtn = $("logoutBtn");
  const changeBtn = $("openChangePwdBtn");

  if(!currentUser){
    summary.classList.add("hidden");
    logoutBtn.classList.add("hidden");
    changeBtn.classList.add("hidden");
    summary.textContent = "";
    return;
  }
  summary.classList.remove("hidden");
  logoutBtn.classList.remove("hidden");
  changeBtn.classList.remove("hidden");

  if(currentUser.role==="admin"){
    summary.innerHTML = `Logged in as <b>Admin</b>`;
  } else {
    const lec = DATA.lecturers.find(l=>l.id===currentUser.id);
    const name = lec ? `${lec.salutation} ${lec.fullName}` : currentUser.username;
    summary.innerHTML = `Logged in as <b>Lecturer</b> · <b>${name}</b>`;
  }
}
$("logoutBtn").addEventListener("click", ()=>{
  currentUser = null;
  updateTopBar();
  showSection("loginSection");
  $("loginUsername").value = "";
  $("loginPassword").value = "";
  clearAlert($("loginMessage"));
});

$("openChangePwdBtn").addEventListener("click", ()=>{
  clearAlert($("pwdMsg"));
  $("pwdOld").value = "";
  $("pwdNew").value = "";
  $("pwdNew2").value = "";
  $("pwdModal").classList.remove("hidden");
});
$("pwdCloseBtn").addEventListener("click", ()=> $("pwdModal").classList.add("hidden"));

$("pwdSaveBtn").addEventListener("click", ()=>{
  const oldP = $("pwdOld").value;
  const newP = $("pwdNew").value;
  const newP2 = $("pwdNew2").value;
  const msgEl = $("pwdMsg");

  if(!currentUser){ setAlert(msgEl,"Not logged in.","danger"); return; }
  if(!oldP || !newP || !newP2){ setAlert(msgEl,"Fill all fields.","danger"); return; }
  if(newP.length < 4){ setAlert(msgEl,"New password too short (min 4).","danger"); return; }
  if(newP !== newP2){ setAlert(msgEl,"New passwords do not match.","danger"); return; }

  DATA = loadData();

  if(currentUser.role==="admin"){
    const adm = DATA.admins.find(a=>a.username===currentUser.username);
    if(!adm || adm.password !== oldP){ setAlert(msgEl,"Current password is wrong.","danger"); return; }
    adm.password = newP;
    saveData(DATA);
    setAlert(msgEl,"Password updated successfully.","success");
  } else {
    const lec = DATA.lecturers.find(l=>l.id===currentUser.id);
    if(!lec || lec.password !== oldP){ setAlert(msgEl,"Current password is wrong.","danger"); return; }
    lec.password = newP;
    saveData(DATA);
    setAlert(msgEl,"Password updated successfully.","success");
  }
});

/* ===========================
   Admin tab switching
=========================== */
document.querySelectorAll("[data-admin-tab]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll("[data-admin-tab]").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.getAttribute("data-admin-tab");
    document.querySelectorAll(".admin-tab").forEach(sec=>{
      sec.classList.toggle("hidden", sec.id !== tab);
    });
  });
});

/* ===========================
   Lecturer Registration + Login
=========================== */
$("showLecturerRegistration").addEventListener("click", ()=>{
  showSection("lecturerRegistrationSection");
  clearAlert($("loginMessage"));
});
$("backToLogin").addEventListener("click", ()=>{
  showSection("loginSection");
  clearAlert($("lecturerRegMessage"));
});

$("submitLecturerRegistration").addEventListener("click", ()=>{
  const salutation = $("regSalutation").value;
  const fullName = $("regFullName").value.trim();
  const pf = $("regPF").value.trim();
  const username = $("regUsername").value.trim();
  const password = $("regPassword").value;
  const msgEl = $("lecturerRegMessage");

  if(!fullName || !pf || !username || !password){
    setAlert(msgEl,"Please fill all required fields.","danger");
    return;
  }

  DATA = loadData();
  if(DATA.lecturers.some(l=>l.username===username) || DATA.admins.some(a=>a.username===username)){
    setAlert(msgEl,"Username already exists.","danger");
    return;
  }

  const lecturer = { id: uuid(), salutation, fullName, pf, username, password, approved:false };
  DATA.lecturers.push(lecturer);
  saveData(DATA);

  setAlert(msgEl,"Registration submitted. Wait for Admin approval.","success");
  $("regFullName").value = $("regPF").value = $("regUsername").value = $("regPassword").value = "";
});

$("loginBtn").addEventListener("click", ()=>{
  const username = $("loginUsername").value.trim();
  const password = $("loginPassword").value;
  const role = document.querySelector('input[name="loginRole"]:checked').value;
  const msgEl = $("loginMessage");

  if(!username || !password){
    setAlert(msgEl,"Please enter username and password.","danger");
    return;
  }

  DATA = loadData();

  if(role==="admin"){
    const found = DATA.admins.find(a=>a.username===username && a.password===password);
    if(!found){ setAlert(msgEl,"Invalid admin credentials.","danger"); return; }
    currentUser = { role:"admin", username };
    clearAlert(msgEl);
    updateTopBar();
    showSection("adminDashboard");
    renderAdminLecturers();
    renderFacultySummary();
    refreshAllDropdowns();
    renderAdminClasses();
    refreshClassPickers();
  } else {
    const lec = DATA.lecturers.find(l=>l.username===username && l.password===password);
    if(!lec){ setAlert(msgEl,"Lecturer not found or wrong password.","danger"); return; }
    if(!lec.approved){ setAlert(msgEl,"Your account is pending approval by Admin.","danger"); return; }

    currentUser = { role:"lecturer", id: lec.id, username: lec.username };
    clearAlert(msgEl);
    updateTopBar();
    showSection("lecturerDashboard");
    refreshAllDropdowns();
    renderLecturerClasses();
    refreshClassPickers();
  }
});

/* ===========================
   ADMIN: Lecturers approve + reset password
=========================== */
function renderAdminLecturers(){
  const wrapper = $("lecturersTableWrapper");
  DATA = loadData();

  if(!DATA.lecturers.length){
    wrapper.textContent = "No lecturers registered yet.";
    return;
  }

  let html = `<table><thead><tr>
    <th>Lecturer</th><th>PF/ID</th><th>Username</th><th>Status</th><th>Actions</th>
  </tr></thead><tbody>`;

  DATA.lecturers.forEach(lec=>{
    const status = lec.approved ? `<span class="chip green">Approved</span>` : `<span class="chip red">Pending</span>`;
    html += `<tr>
      <td><b>${escapeHtml(lec.salutation)} ${escapeHtml(lec.fullName)}</b></td>
      <td>${escapeHtml(lec.pf)}</td>
      <td>${escapeHtml(lec.username)}</td>
      <td>${status}</td>
      <td style="display:flex;gap:.4rem;flex-wrap:wrap;">
        <button class="btn ${lec.approved ? "btn-secondary":"btn-success"}" data-action="toggle" data-id="${lec.id}">
          ${lec.approved ? "Revoke":"Approve"}
        </button>
        <button class="btn btn-danger" data-action="resetpwd" data-id="${lec.id}">
          Reset Password
        </button>
      </td>
    </tr>`;
  });

  html += `</tbody></table>`;
  wrapper.innerHTML = html;

  wrapper.querySelectorAll("button[data-action]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");
      DATA = loadData();
      const lec = DATA.lecturers.find(l=>l.id===id);
      if(!lec) return;

      if(action==="toggle"){
        lec.approved = !lec.approved;
        saveData(DATA);
        renderAdminLecturers();
      }
      if(action==="resetpwd"){
        const np = prompt("Enter new password for lecturer:", "1234");
        if(!np) return;
        lec.password = np;
        saveData(DATA);
        alert("Lecturer password reset successfully.");
      }
    });
  });
}

/* ===========================
   FACULTY CSV upload + summary
=========================== */
$("uploadFacultyCsvBtn").addEventListener("click", ()=>{
  const file = $("facultyCsvInput").files[0];
  const msgEl = $("facultyUploadMsg");
  if(!file){ setAlert(msgEl,"Select a CSV file first.","danger"); return; }

  const reader = new FileReader();
  reader.onload = (e)=>{
    const text = e.target.result || "";
    const lines = text.split(/\r?\n/).filter(l=>l.trim());
    const records = [];
    const defAY = getDefaultAcademicYear();

    for(let i=0;i<lines.length;i++){
      const line = lines[i].trim();
      if(i===0 && line.toLowerCase().includes("faculty") && line.toLowerCase().includes("course") && line.toLowerCase().includes("unit")) continue;

      const parts = line.split(",").map(p=>p.trim());
      if(parts.length < 5) continue;

      const faculty = parts[0] || "";
      const course  = parts[1] || "";
      const unit    = parts[2] || "";
      const year    = parts[3] || "";
      const semester= parts[4] || "";
      const academicYear = (parts[5] && parts[5].trim()) ? parts[5].trim() : defAY;

      if(!faculty || !course || !unit || !year || !semester) continue;
      records.push({ faculty, course, unit, year, semester, academicYear });
    }

    DATA = loadData();
    DATA.facultyConfig = records;
    saveData(DATA);

    setAlert(msgEl, `Uploaded ${records.length} entries successfully.`, "success");
    renderFacultySummary();
    refreshAllDropdowns();
  };
  reader.readAsText(file);
});

$("clearFacultyDataBtn").addEventListener("click", ()=>{
  const msgEl = $("facultyUploadMsg");
  if(!confirm("Clear all existing faculty/course/unit mappings?")) return;
  DATA = loadData();
  DATA.facultyConfig = [];
  saveData(DATA);
  setAlert(msgEl,"All mappings cleared.","success");
  renderFacultySummary();
  refreshAllDropdowns();
});

function renderFacultySummary(){
  const wrap = $("facultySummary");
  DATA = loadData();
  if(!DATA.facultyConfig.length){
    wrap.textContent = "No mappings uploaded yet.";
    return;
  }
  const total = DATA.facultyConfig.length;
  const faculties = unique(DATA.facultyConfig.map(r=>r.faculty));
  const acYears = unique(DATA.facultyConfig.map(r=>r.academicYear || ""));
  wrap.innerHTML = `<p class="muted" style="margin:.2rem 0 0;">
    Total entries: <b>${total}</b><br/>
    Academic Years: <b>${escapeHtml(acYears.join(", ") || "N/A")}</b><br/>
    Faculties: ${escapeHtml(faculties.join(", "))}
  </p>`;
}

function getMapping(){ DATA = loadData(); return DATA.facultyConfig || []; }

function refreshAllDropdowns(){
  const m = getMapping();

  // Admin report filters
  setOptions($("repAcademicYear"), unique(m.map(x=>x.academicYear)), "All Academic Years");
  setOptions($("repFaculty"), unique(m.map(x=>x.faculty)), "All Faculties");
  setOptions($("repCourse"), unique(m.map(x=>x.course)), "All Courses");
  setOptions($("repUnit"), unique(m.map(x=>x.unit)), "All Units");
  setOptions($("repYear"), unique(m.map(x=>x.year)), "All Study Years");
  setOptions($("repSemester"), unique(m.map(x=>x.semester)), "All Semesters");

  // Lecturer create session
  const ayList = unique(m.map(x=>x.academicYear));
  setOptions($("lcAcademicYear"), ayList.length ? ayList : [getDefaultAcademicYear()], "Select Academic Year");
  setOptions($("lcFaculty"), unique(m.map(x=>x.faculty)), "Select Faculty");
  setOptions($("lcCourse"), unique(m.map(x=>x.course)), "Select Course");
  setOptions($("lcUnit"), unique(m.map(x=>x.unit)), "Select Unit");
  setOptions($("lcYear"), unique(m.map(x=>x.year)), "Select Study Year");
  setOptions($("lcSemester"), unique(m.map(x=>x.semester)), "Select Semester");

  // Lecturer report filters
  setOptions($("repAcademicYearL"), unique(m.map(x=>x.academicYear)), "All Academic Years");
  setOptions($("repFacultyL"), unique(m.map(x=>x.faculty)), "All Faculties");
  setOptions($("repCourseL"), unique(m.map(x=>x.course)), "All Courses");
  setOptions($("repUnitL"), unique(m.map(x=>x.unit)), "All Units");
  setOptions($("repYearL"), unique(m.map(x=>x.year)), "All Study Years");
  setOptions($("repSemesterL"), unique(m.map(x=>x.semester)), "All Semesters");

  hookupCascadingCreateClass();
  updateCreateSessionUI();
}

function hookupCascadingCreateClass(){
  const m = getMapping();
  const ay = $("lcAcademicYear"), f = $("lcFaculty"), c = $("lcCourse"), u = $("lcUnit"), y = $("lcYear"), s = $("lcSemester");
  if(!ay || !f || !c || !u || !y || !s) return;

  function apply(){
    const ayv = ay.value, fv = f.value, cv = c.value, uv = u.value, yv = y.value, sv = s.value;

    const m0 = ayv ? m.filter(r=>r.academicYear===ayv) : m;
    setOptions(f, unique(m0.map(r=>r.faculty)), "Select Faculty");

    const m1 = (ay.value && f.value) ? m.filter(r=>r.academicYear===ay.value && r.faculty===f.value) : (f.value ? m0.filter(r=>r.faculty===f.value) : m0);
    setOptions(c, unique(m1.map(r=>r.course)), "Select Course");

    const m2 = (ay.value && f.value && c.value)
      ? m.filter(r=>r.academicYear===ay.value && r.faculty===f.value && r.course===c.value)
      : (c.value ? m1.filter(r=>r.course===c.value) : m1);
    setOptions(u, unique(m2.map(r=>r.unit)), "Select Unit");

    const m3 = (ay.value && f.value && c.value && u.value)
      ? m.filter(r=>r.academicYear===ay.value && r.faculty===f.value && r.course===c.value && r.unit===u.value)
      : (u.value ? m2.filter(r=>r.unit===u.value) : m2);
    setOptions(y, unique(m3.map(r=>r.year)), "Select Study Year");

    const m4 = (ay.value && f.value && c.value && u.value && y.value)
      ? m.filter(r=>r.academicYear===ay.value && r.faculty===f.value && r.course===c.value && r.unit===u.value && r.year===y.value)
      : (y.value ? m3.filter(r=>r.year===y.value) : m3);
    setOptions(s, unique(m4.map(r=>r.semester)), "Select Semester");

    if(ayv && [...ay.options].some(o=>o.value===ayv)) ay.value = ayv;
    if(fv && [...f.options].some(o=>o.value===fv)) f.value = fv;
    if(cv && [...c.options].some(o=>o.value===cv)) c.value = cv;
    if(uv && [...u.options].some(o=>o.value===uv)) u.value = uv;
    if(yv && [...y.options].some(o=>o.value===yv)) y.value = yv;
    if(sv && [...s.options].some(o=>o.value===sv)) s.value = sv;
  }

  ay.onchange = apply;
  f.onchange = apply;
  c.onchange = apply;
  u.onchange = apply;
  y.onchange = apply;
  apply();
}

/* ===========================
   Session type UI
=========================== */
function updateCreateSessionUI(){
  const type = $("lcType")?.value || "class";
  const meetingWrap = $("meetingModeWrap");
  if(meetingWrap) meetingWrap.classList.toggle("hidden", type !== "meeting");
}
$("lcType").addEventListener("change", updateCreateSessionUI);

/* ===========================
   GEO helpers
=========================== */
function haversineKm(lat1, lon1, lat2, lon2){
  const R = 6371;
  const toRad = (d)=> d * Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function getGeo(){
  return new Promise((resolve, reject)=>{
    if(!navigator.geolocation) return reject(new Error("Geolocation not supported"));
    navigator.geolocation.getCurrentPosition(
      (pos)=> resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude, acc: pos.coords.accuracy }),
      (err)=> reject(err),
      { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
    );
  });
}

/* ===========================
   CLASSES/MEETINGS: Lecturer create
=========================== */
$("createClassBtn").addEventListener("click", ()=>{
  const type = $("lcType").value;
  const meetingMode = $("lcMeetingMode").value;

  const academicYear = $("lcAcademicYear").value.trim();
  const f = $("lcFaculty").value.trim();
  const c = $("lcCourse").value.trim();
  const u = $("lcUnit").value.trim();
  const unitCode = $("lcUnitCode").value.trim();
  const y = $("lcYear").value.trim();
  const s = $("lcSemester").value.trim();

  const v = $("lcVenue").value.trim();
  const dt = $("lcDateTime").value;
  const msgEl = $("createClassMsg");

  if(!currentUser || currentUser.role!=="lecturer"){
    setAlert(msgEl,"You must be logged in as lecturer to create sessions.","danger");
    return;
  }
  if(!v || !dt){
    setAlert(msgEl,"Please fill Venue/Platform and Date & Time.","danger");
    return;
  }

  if(type==="class"){
    if(!academicYear){ setAlert(msgEl,"Please select Academic Year.","danger"); return; }
    if(!f || !c || !u || !y || !s){
      setAlert(msgEl,"Please select Faculty/Course/Unit/Study Year/Semester for classes.","danger");
      return;
    }
    if(!unitCode){
      setAlert(msgEl,"Unit Code is required for classes.","danger");
      return;
    }
  }

  DATA = loadData();
  const lec = DATA.lecturers.find(l=>l.id===currentUser.id);
  if(!lec){ setAlert(msgEl,"Lecturer not found.","danger"); return; }

  const classId = uuid();
  const cls = {
    id: classId,
    type,
    meetingMode: type==="meeting" ? meetingMode : "physical",
    academicYear: type==="meeting" ? (academicYear || "") : academicYear,
    unitCode: unitCode || "",
    lecturerId: lec.id,
    faculty: f || "",
    course: c || "",
    unit: type==="meeting" ? "Staff Meeting" : (u || ""),
    year: y || "",
    semester: s || "",
    venue: v,
    dateTime: dt,
    status: "open",
    lecturerName: lec.salutation + " " + lec.fullName,
    lecturerSignature: null,
    hodName: "",
    hodSignature: null,
    createdAt: Date.now()
  };

  DATA.classes.push(cls);
  saveData(DATA);

  renderLecturerClasses();
  refreshClassPickers();

  const link = window.location.origin + window.location.pathname + "?mode=student&classId=" + encodeURIComponent(classId);
  setAlert(msgEl, "Session created. Share this sign-in link:\n" + link, "success");
});

/* ===========================
   Filters + pickers
=========================== */
function classFilterMatch(cls, filterValue){
  const v = (filterValue||"").toLowerCase();
  if(!v) return true;
  return (
    (cls.unit||"").toLowerCase().includes(v) ||
    (cls.unitCode||"").toLowerCase().includes(v) ||
    (cls.course||"").toLowerCase().includes(v) ||
    (cls.faculty||"").toLowerCase().includes(v) ||
    (cls.academicYear||"").toLowerCase().includes(v) ||
    (cls.status||"").toLowerCase().includes(v) ||
    (cls.lecturerName||"").toLowerCase().includes(v) ||
    (cls.type||"").toLowerCase().includes(v) ||
    (cls.meetingMode||"").toLowerCase().includes(v)
  );
}

function setClassFilterOptions(selectId, classes, includeStatusHint){
  const sel = $(selectId);
  if(!sel) return;
  const old = sel.value;

  const items = [];
  unique(classes.map(c=>c.type)).forEach(t=> items.push({label:`TYPE: ${t.toUpperCase()}`, value:t}));
  unique(classes.map(c=>c.academicYear).filter(Boolean)).forEach(a=> items.push({label:`AY: ${a}`, value:a}));
  unique(classes.map(c=>c.unitCode).filter(Boolean)).forEach(c=> items.push({label:`CODE: ${c}`, value:c}));
  unique(classes.map(c=>c.unit).filter(Boolean)).forEach(u=> items.push({label:`UNIT: ${u}`, value:u}));
  unique(classes.map(c=>c.course).filter(Boolean)).forEach(x=> items.push({label:`COURSE: ${x}`, value:x}));
  if(includeStatusHint) unique(classes.map(c=>c.status)).forEach(s=> items.push({label:`STATUS: ${s.toUpperCase()}`, value:s}));

  sel.innerHTML = "";
  const o0 = document.createElement("option");
  o0.value = "";
  o0.textContent = "All Sessions";
  sel.appendChild(o0);

  items.forEach(it=>{
    const o = document.createElement("option");
    o.value = it.value;
    o.textContent = it.label;
    sel.appendChild(o);
  });

  if(old && [...sel.options].some(x=>x.value===old)) sel.value = old;

  sel.onchange = ()=>{
    if(selectId==="lecClassFilter") renderLecturerClasses();
    if(selectId==="adminClassFilter") renderAdminClasses();
  };
}

function refreshClassPickers(){
  DATA = loadData();
  const classes = DATA.classes.slice().sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));

  setClassFilterOptions("lecClassFilter", currentUser?.role==="lecturer" ? classes.filter(c=>c.lecturerId===currentUser.id) : [], true);
  setClassFilterOptions("adminClassFilter", classes, true);

  const rawPick = $("rawClassPick");
  if(rawPick){
    rawPick.innerHTML = "";
    const o0 = document.createElement("option");
    o0.value = "";
    o0.textContent = "Select Session";
    rawPick.appendChild(o0);

    classes.forEach(cls=>{
      const o = document.createElement("option");
      o.value = cls.id;
      o.textContent = `${(cls.type==="meeting" ? "MEETING" : "CLASS")} · ${cls.academicYear||""} · ${cls.unitCode||""} · ${cls.unit||""} · ${formatDateTime(cls.dateTime)} · ${cls.status.toUpperCase()}`;
      rawPick.appendChild(o);
    });
  }
}

/* ===========================
   Lecturer sessions table
=========================== */
function renderLecturerClasses(){
  const wrapper = $("lecturerClassesTableWrapper");
  DATA = loadData();
  const lecId = currentUser?.id;
  const filter = $("lecClassFilter")?.value || "";

  const list = DATA.classes
    .filter(c=>c.lecturerId===lecId)
    .filter(c=>classFilterMatch(c, filter))
    .sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));

  if(!list.length){
    wrapper.textContent = "No sessions yet.";
    return;
  }

  let html = `<table><thead><tr>
    <th>Type</th><th>Academic Year</th><th>Unit Code</th><th>Unit/Meeting</th><th>Venue</th><th>Date/Time</th><th>Status</th><th>Actions</th>
  </tr></thead><tbody>`;

  list.forEach(cls=>{
    const badge = `<span class="badge ${cls.status}">${(cls.status||"").toUpperCase()}</span>`;
    html += `<tr>
      <td>${cls.type==="meeting" ? `MEETING <span class="chip ${cls.meetingMode==="online"?"green":"red"}">${(cls.meetingMode||"").toUpperCase()}</span>` : "CLASS"}</td>
      <td>${escapeHtml(cls.academicYear || "")}</td>
      <td>${escapeHtml(cls.unitCode || "")}</td>
      <td><b>${escapeHtml(cls.unit || "")}</b><div class="small">${escapeHtml(cls.course || "")} ${cls.faculty ? "· "+escapeHtml(cls.faculty) : ""}</div></td>
      <td>${escapeHtml(cls.venue || "")}</td>
      <td>${escapeHtml(formatDateTime(cls.dateTime))}</td>
      <td>${badge}</td>
      <td style="display:flex;gap:.4rem;flex-wrap:wrap;">
        <button class="btn btn-primary" data-act="view" data-id="${cls.id}">View</button>
        <button class="btn btn-secondary" data-act="toggle" data-id="${cls.id}">${cls.status==="open"?"Close":"Open"}</button>
      </td>
    </tr>`;
  });

  html += `</tbody></table>`;
  wrapper.innerHTML = html;

  wrapper.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-id");
      const act = btn.getAttribute("data-act");
      if(act==="view") openSessionModal(id);
      if(act==="toggle") toggleSessionStatus(id);
    });
  });
}

/* ===========================
   Admin sessions table
=========================== */
function renderAdminClasses(){
  const wrapper = $("adminClassesTableWrapper");
  DATA = loadData();
  const filter = $("adminClassFilter")?.value || "";

  const list = DATA.classes
    .filter(c=>classFilterMatch(c, filter))
    .sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));

  if(!list.length){
    wrapper.textContent = "No sessions created yet.";
    return;
  }

  let html = `<table><thead><tr>
    <th>Type</th><th>Academic Year</th><th>Unit Code</th><th>Unit/Meeting</th><th>Lecturer</th><th>Venue</th><th>Date/Time</th><th>Status</th><th>Actions</th>
  </tr></thead><tbody>`;

  list.forEach(cls=>{
    const badge = `<span class="badge ${cls.status}">${(cls.status||"").toUpperCase()}</span>`;
    html += `<tr>
      <td>${cls.type==="meeting" ? `MEETING <span class="chip ${cls.meetingMode==="online"?"green":"red"}">${(cls.meetingMode||"").toUpperCase()}</span>` : "CLASS"}</td>
      <td>${escapeHtml(cls.academicYear || "")}</td>
      <td>${escapeHtml(cls.unitCode || "")}</td>
      <td><b>${escapeHtml(cls.unit || "")}</b><div class="small">${escapeHtml(cls.course || "")} ${cls.faculty ? "· "+escapeHtml(cls.faculty) : ""}</div></td>
      <td>${escapeHtml(cls.lecturerName || "")}</td>
      <td>${escapeHtml(cls.venue || "")}</td>
      <td>${escapeHtml(formatDateTime(cls.dateTime))}</td>
      <td>${badge}</td>
      <td style="display:flex;gap:.4rem;flex-wrap:wrap;">
        <button class="btn btn-primary" data-act="view" data-id="${cls.id}">View</button>
        <button class="btn btn-secondary" data-act="toggle" data-id="${cls.id}">${cls.status==="open"?"Close":"Open"}</button>
      </td>
    </tr>`;
  });

  html += `</tbody></table>`;
  wrapper.innerHTML = html;

  wrapper.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-id");
      const act = btn.getAttribute("data-act");
      if(act==="view") openSessionModal(id);
      if(act==="toggle") toggleSessionStatus(id);
    });
  });
}

function toggleSessionStatus(classId){
  DATA = loadData();
  const cls = DATA.classes.find(c=>c.id===classId);
  if(!cls) return;
  cls.status = (cls.status==="open") ? "closed" : "open";
  saveData(DATA);
  renderLecturerClasses();
  renderAdminClasses();
  refreshClassPickers();

  if($("sessionModal") && !$("sessionModal").classList.contains("hidden")) openSessionModal(classId, true);
}

/* ===========================
   Session modal (QR + attendance + export + signatures)
=========================== */
let currentModalClassId = null;
let sigPad = setupSignaturePad($("sigPad"));

$("sessionModalCloseBtn").addEventListener("click", ()=>{
  $("sessionModal").classList.add("hidden");
  $("qrTarget").innerHTML = "";
  currentModalClassId = null;
});
$("sessionModalPrintBtn").addEventListener("click", ()=> window.print());

$("copyLinkBtn").addEventListener("click", async ()=>{
  const link = $("sessionLinkText").textContent.trim();
  try{
    await navigator.clipboard.writeText(link);
    alert("Link copied.");
  }catch(e){
    alert("Copy failed. Please manually copy the link.");
  }
});
$("openLinkBtn").addEventListener("click", ()=>{
  const link = $("sessionLinkText").textContent.trim();
  window.open(link, "_blank");
});

$("toggleStatusBtn").addEventListener("click", ()=>{
  if(!currentModalClassId) return;
  toggleSessionStatus(currentModalClassId);
});

$("exportSessionPdfBtn").addEventListener("click", async ()=>{
  if(!currentModalClassId) return;
  const { cls, rows } = getClassAndRows(currentModalClassId);
  await exportClassAttendancePdf(cls, rows);
});
$("exportSessionWordBtn").addEventListener("click", async ()=>{
  if(!currentModalClassId) return;
  const { cls, rows } = getClassAndRows(currentModalClassId);
  await exportClassAttendanceWord(cls, rows);
});
$("exportSessionExcelBtn").addEventListener("click", async ()=>{
  if(!currentModalClassId) return;
  const { cls, rows } = getClassAndRows(currentModalClassId);
  await exportClassAttendanceExcel(cls, rows);
});
$("exportSessionCsvBtn").addEventListener("click", ()=>{
  if(!currentModalClassId) return;
  const { cls, rows } = getClassAndRows(currentModalClassId);
  exportRawAttendanceCsv(cls, rowsToRawRows(rows));
});

$("lecturerSignBtn").addEventListener("click", ()=>{ if(currentModalClassId) openSigModal("lecturer"); });
$("hodSignBtn").addEventListener("click", ()=>{ if(currentModalClassId) openSigModal("hod"); });

$("sigClearBtn").addEventListener("click", ()=> sigPad.clear());
$("sigCancelBtn").addEventListener("click", ()=>{
  $("sigModal").classList.add("hidden");
  clearAlert($("sigMsg"));
});
let sigMode = "lecturer";
function openSigModal(mode){
  sigMode = mode;
  sigPad.clear();
  clearAlert($("sigMsg"));

  $("hodNameWrap").classList.toggle("hidden", mode !== "hod");
  $("sigModalTitle").textContent = (mode==="hod" ? "HOD Signature" : "Lecturer Signature");
  if(mode==="hod"){
    const cls = loadData().classes.find(c=>c.id===currentModalClassId);
    $("hodNameInput").value = cls?.hodName || "";
  }
  $("sigModal").classList.remove("hidden");
}

$("sigSaveBtn").addEventListener("click", ()=>{
  if(!currentModalClassId) return;
  DATA = loadData();
  const cls = DATA.classes.find(c=>c.id===currentModalClassId);
  if(!cls) return;

  if(sigPad.isBlank()){
    setAlert($("sigMsg"), "Please draw the signature first.", "danger");
    return;
  }
  const dataUrl = sigPad.toDataUrl();

  if(sigMode==="lecturer"){
    cls.lecturerSignature = dataUrl;
  } else {
    const hodName = $("hodNameInput").value.trim();
    if(!hodName){
      setAlert($("sigMsg"), "Please enter HOD name.", "danger");
      return;
    }
    cls.hodName = hodName;
    cls.hodSignature = dataUrl;
  }
  saveData(DATA);
  $("sigModal").classList.add("hidden");
  openSessionModal(currentModalClassId, true);
});

function openSessionModal(classId){
  DATA = loadData();
  const cls = DATA.classes.find(c=>c.id===classId);
  if(!cls) return;

  currentModalClassId = classId;

  $("hodSignBtn").classList.toggle("hidden", !(currentUser && currentUser.role==="admin"));

  $("sessionModalTitle").textContent = `${cls.type==="meeting" ? "Staff Meeting" : "Class"} · ${cls.academicYear || ""} · ${cls.unitCode || ""} · ${cls.unit || ""}`;
  $("sessionModalMeta").textContent = `${cls.lecturerName || ""} · ${cls.venue || ""} · ${formatDateTime(cls.dateTime)} · Status: ${(cls.status||"").toUpperCase()}`;

  const link = window.location.origin + window.location.pathname + "?mode=student&classId=" + encodeURIComponent(cls.id);
  $("sessionLinkText").textContent = link;

  $("qrTarget").innerHTML = "";
  try{
    new QRCode($("qrTarget"), { text: link, width: 130, height: 130 });
  }catch(e){
    $("qrTarget").innerHTML = "<div class='small'>QR failed to load</div>";
  }

  $("toggleStatusBtn").textContent = (cls.status==="open") ? "Close Session" : "Open Session";

  const rows = buildAttendanceRowsForClass(cls.id);
  $("sessionAttendanceMeta").textContent = `Total attendance: ${rows.length}. Signatures are embedded in exports (PDF/Word/Excel).`;

  renderAttendanceTable("sessionAttendanceTable", rows, true);

  $("sessionModal").classList.remove("hidden");
}

/* ===========================
   Attendance table renderer
=========================== */
function renderAttendanceTable(tableId, rows, includeSigThumb){
  const table = $(tableId);
  if(!table) return;

  if(!rows.length){
    table.innerHTML = `<thead><tr><th>No data</th></tr></thead><tbody><tr><td>No attendance yet.</td></tr></tbody>`;
    return;
  }

  let head = `<thead><tr>
    <th>#</th><th>ID</th><th>Surname</th><th>Middle</th><th>First</th>${includeSigThumb? "<th>Signature</th>": ""}<th>Timestamp</th>
  </tr></thead>`;

  let body = "<tbody>";
  rows.forEach(r=>{
    const sigCell = includeSigThumb
      ? `<td>${r.SignatureDataURL ? `<img class="miniSig" src="${r.SignatureDataURL}" alt="sig">` : ""}</td>`
      : "";
    body += `<tr>
      <td>${escapeHtml(r["#"])}</td>
      <td>${escapeHtml(r.ID)}</td>
      <td>${escapeHtml(r.Surname)}</td>
      <td>${escapeHtml(r.Middle)}</td>
      <td>${escapeHtml(r.First)}</td>
      ${sigCell}
      <td>${escapeHtml(r.Timestamp)}</td>
    </tr>`;
  });
  body += "</tbody>";
  table.innerHTML = head + body;
}

function buildAttendanceRowsForClass(classId){
  DATA = loadData();
  const cls = DATA.classes.find(c=>c.id===classId) || {};
  const items = DATA.attendance
    .filter(a=>a.classId===classId)
    .sort((a,b)=> (a.createdAt||0)-(b.createdAt||0))
    .map((a,i)=>({
      "#": i+1,
      ID: (cls.type==="meeting") ? (a.staffNo||"") : (a.admission||""),
      Surname: a.surname || "",
      Middle: a.middle || "",
      First: a.first || "",
      Timestamp: formatDateTime(a.createdAt),
      SignatureDataURL: a.signature || ""
    }));
  return items;
}
function getClassAndRows(classId){
  DATA = loadData();
  const cls = DATA.classes.find(c=>c.id===classId);
  const rows = buildAttendanceRowsForClass(classId);
  return { cls, rows };
}
function rowsToRawRows(rows){
  return rows.map(r=>({
    "#": r["#"],
    ID: r.ID,
    Surname: r.Surname,
    Middle: r.Middle,
    First: r.First,
    Timestamp: r.Timestamp,
    SignatureDataURL: r.SignatureDataURL
  }));
}

/* ===========================
   PARTICIPANT view (mode=student)
=========================== */
function getOrCreateDeviceId(){
  const k = "jooust_device_id";
  let v = localStorage.getItem(k);
  if(!v){
    v = uuid();
    localStorage.setItem(k, v);
  }
  return v;
}

async function loadStudentMode(){
  const classId = getQueryParam("classId");
  if(!classId) return false;

  DATA = loadData();
  const cls = DATA.classes.find(c=>c.id===classId);
  if(!cls){
    showSection("studentSection");
    setAlert($("studentClassInfo"), "Invalid session link (classId not found).", "danger");
    $("studentFormWrapper").classList.add("hidden");
    return true;
  }

  showSection("studentSection");
  $("participantTitle").textContent = (cls.type==="meeting") ? "Staff Meeting Sign-In" : "Class Attendance Sign-In";

  const isMeeting = cls.type === "meeting";
  $("staffNoRow").classList.toggle("hidden", !isMeeting);
  $("idRow").classList.toggle("hidden", isMeeting);
  $("idLabel").textContent = "Admission Number";
  $("stAdmission").placeholder = "Enter Admission Number";

  const meta = isMeeting
    ? `Meeting Mode: ${(cls.meetingMode||"").toUpperCase()}
Venue/Platform: ${cls.venue}
Date/Time: ${formatDateTime(cls.dateTime)}
Organizer: ${cls.lecturerName}
Status: ${(cls.status||"").toUpperCase()}`
    : `Academic Year: ${cls.academicYear}
Unit Code: ${cls.unitCode}
Unit Name: ${cls.unit}
Course: ${cls.course}
Faculty: ${cls.faculty}
Study Year/Semester: ${cls.year} / ${cls.semester}
Venue: ${cls.venue}
Date/Time: ${formatDateTime(cls.dateTime)}
Lecturer: ${cls.lecturerName}
Status: ${(cls.status||"").toUpperCase()}`;

  $("studentClassInfo").textContent = meta;
  $("studentFormWrapper").classList.remove("hidden");

  if(cls.status !== "open"){
    setAlert($("studentSubmitMsg"), "This session is CLOSED. Please contact the organizer/lecturer.", "danger");
    $("stSubmit").disabled = true;
  }else{
    $("stSubmit").disabled = false;
    clearAlert($("studentSubmitMsg"));
  }

  const deviceId = getOrCreateDeviceId();
  const devKey = `submitted_${classId}_${deviceId}`;
  if(localStorage.getItem(devKey)==="1"){
    $("studentAlreadySubmitted").classList.remove("hidden");
    $("studentFormWrapper").classList.add("hidden");
  } else {
    $("studentAlreadySubmitted").classList.add("hidden");
  }

  const requireGeo = (cls.type==="class") || (cls.type==="meeting" && cls.meetingMode==="physical");
  let geoNoteEl = $("geoNote");
  if(requireGeo){
    $("studentGeoInfo").classList.remove("hidden");
    $("studentGeoInfo").textContent = "This is a PHYSICAL session. Location verification is required (within 1km of JOOUST). When you submit, the system will verify your location.";
    if(geoNoteEl) geoNoteEl.classList.remove("hidden");
  }else{
    $("studentGeoInfo").classList.add("hidden");
    if(geoNoteEl) geoNoteEl.classList.add("hidden");
  }

  return true;
}

$("stSubmit").addEventListener("click", async ()=>{
  const classId = getQueryParam("classId");
  if(!classId) return;
  DATA = loadData();
  const cls = DATA.classes.find(c=>c.id===classId);
  if(!cls) return;

  if(cls.status!=="open"){
    setAlert($("studentSubmitMsg"), "Session is CLOSED.", "danger");
    return;
  }

  const surname = $("stSurname").value.trim();
  const middle = $("stMiddleName").value.trim();
  const first = $("stFirstName").value.trim();

  const isMeeting = cls.type==="meeting";
  const idValue = isMeeting ? $("stStaffNo").value.trim() : $("stAdmission").value.trim();

  if(!surname || !first || !idValue){
    setAlert($("studentSubmitMsg"), "Please fill required fields (Surname, First Name, ID).", "danger");
    return;
  }
  if(stSig.isBlank()){
    setAlert($("studentSubmitMsg"), "Please add your signature.", "danger");
    return;
  }

  const exists = DATA.attendance.some(a=>a.classId===classId && ((isMeeting && (a.staffNo||"")===idValue) || (!isMeeting && (a.admission||"")===idValue)));
  if(exists){
    setAlert($("studentSubmitMsg"), "This ID has already submitted attendance for this session.", "danger");
    return;
  }

  const requireGeo = (cls.type==="class") || (cls.type==="meeting" && cls.meetingMode==="physical");
  let geoObj = null;

  if(requireGeo){
    try{
      const g = await getGeo();
      const distKm = haversineKm(g.lat, g.lon, JOOUST_CENTER.lat, JOOUST_CENTER.lon);
      geoObj = { lat:g.lat, lon:g.lon, acc:g.acc, distKm: +distKm.toFixed(3) };

      if(distKm > GEOFENCE_RADIUS_KM){
        setAlert($("studentSubmitMsg"), `Location check failed. You are ${distKm.toFixed(2)} km away. Required within ${GEOFENCE_RADIUS_KM} km of JOOUST.`, "danger");
        return;
      }
    }catch(e){
      setAlert($("studentSubmitMsg"), "Location permission is required for physical sessions. Please enable GPS and try again.", "danger");
      return;
    }
  }

  const deviceId = getOrCreateDeviceId();
  const record = {
    id: uuid(),
    classId,
    surname, middle, first,
    admission: isMeeting ? "" : idValue,
    staffNo: isMeeting ? idValue : "",
    signature: stSig.toDataUrl(),
    createdAt: Date.now(),
    geo: geoObj,
    deviceId
  };

  DATA.attendance.push(record);
  saveData(DATA);

  localStorage.setItem(`submitted_${classId}_${deviceId}`, "1");

  setAlert($("studentSubmitMsg"), "Attendance submitted successfully. Thank you.", "success");
  $("studentAlreadySubmitted").classList.remove("hidden");
  $("studentFormWrapper").classList.add("hidden");
});

/* ===========================
   RAW export (CSV/Excel)
=========================== */
function exportRawAttendanceCsv(cls, rows){
  if(!rows.length){
    alert("No attendance to export.");
    return;
  }
  const header = Object.keys(rows[0]);
  const csv = [
    ["JOOUST Attendance (Raw)", `${cls.type||""}`, `${cls.academicYear||""}`, `${cls.unitCode||""}`, `${cls.unit||""}`, `${cls.course||""}`, `${cls.faculty||""}`].join(","),
    "",
    header.join(","),
    ...rows.map(r=> header.map(h=>{
      const val = (r[h] ?? "").toString().replaceAll('"','""');
      return `"${val}"`;
    }).join(","))
  ].join("\n");

  const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `jooust-raw-attendance-${(cls.unitCode||cls.unit||"session").replace(/\s+/g,"_")}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

$("rawExportCsvBtn").addEventListener("click", ()=>{
  const id = $("rawClassPick").value;
  if(!id){ setAlert($("rawExportMsg"), "Pick a session first.", "danger"); return; }
  const { cls, rows } = getClassAndRows(id);
  exportRawAttendanceCsv(cls, rowsToRawRows(rows));
  setAlert($("rawExportMsg"), "CSV exported successfully.", "success");
});

$("rawExportExcelBtn").addEventListener("click", ()=>{
  const id = $("rawClassPick").value;
  if(!id){ setAlert($("rawExportMsg"), "Pick a session first.", "danger"); return; }
  const { cls, rows } = getClassAndRows(id);
  exportClassAttendanceExcel(cls, rows);
  setAlert($("rawExportMsg"), "Excel exported successfully.", "success");
});

/* ===========================
   OFFICIAL exports (PDF/Word/Excel)
=========================== */
async function exportClassAttendanceExcel(cls, rows){
  if(!window.XLSX){
    alert("Excel library not loaded. Ensure internet is available, then refresh.");
    return;
  }
  const wb = XLSX.utils.book_new();
  wb.Props = { Title:"JOOUST Session Attendance", Subject:"Attendance", Author:"JOOUST Attendance System" };

  const summary = [
    ["Jaramogi Oginga Odinga University of Science & Technology"],
    ["Session Attendance Export"],
    [""],
    ["Type", (cls.type||"").toUpperCase()],
    ["Meeting Mode", cls.type==="meeting" ? (cls.meetingMode||"") : ""],
    ["Academic Year", cls.academicYear || ""],
    ["Unit Code", cls.unitCode || ""],
    ["Unit/Meeting", cls.unit || ""],
    ["Course", cls.course || ""],
    ["Faculty", cls.faculty || ""],
    ["Study Year", cls.year || ""],
    ["Semester", cls.semester || ""],
    ["Venue/Platform", cls.venue || ""],
    ["Date/Time", formatDateTime(cls.dateTime)],
    ["Lecturer", cls.lecturerName || ""],
    ["Status", cls.status || ""],
    [""],
    ["System created by Gerotech — Dan Otieno."]
  ];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summary), "Summary");

  const header = ["#","ID","Surname","Middle","First","Timestamp","SignatureDataURL"];
  const wsData = [header];
  rows.forEach(r=>{
    wsData.push([r["#"], r.ID, r.Surname, r.Middle, r.First, r.Timestamp, r.SignatureDataURL]);
  });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), "Attendance");

  XLSX.writeFile(wb, `jooust-session-attendance-${(cls.unitCode||cls.unit||"session").replace(/\s+/g,"_")}.xlsx`);
}

async function exportClassAttendancePdf(cls, rows){
  if(!(window.jspdf && window.jspdf.jsPDF)){
    alert("PDF library not loaded. Ensure internet is available, then refresh.");
    return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p","pt","a4");
  const margin = 40;

  if(jooustLogoDataUrl){
    try{ doc.addImage(jooustLogoDataUrl, "JPEG", margin, 18, 70, 52); } catch(e){}
  }
  doc.setFontSize(14);
  doc.setTextColor(0,82,204);
  doc.text("Jaramogi Oginga Odinga University of Science & Technology", 120, 38);
  doc.setFontSize(11);
  doc.setTextColor(31,41,55);
  doc.text("Session Attendance Sheet", 120, 56);

  doc.setFontSize(10);
  doc.setTextColor(71,85,105);
  const metaY = 82;
  doc.text(`Type: ${(cls.type||"").toUpperCase()}${cls.type==="meeting" ? (" ("+(cls.meetingMode||"")+")") : ""}`, margin, metaY);
  doc.text(`Academic Year: ${cls.academicYear || ""}`, margin, metaY+14);
  doc.text(`Unit Code: ${cls.unitCode || ""}`, margin, metaY+28);
  doc.text(`Unit/Meeting: ${cls.unit || ""}`, margin, metaY+42);

  if(cls.type!=="meeting"){
    doc.text(`Course: ${cls.course}`, margin, metaY+56);
    doc.text(`Faculty: ${cls.faculty}`, margin, metaY+70);
    doc.text(`Study Year/Sem: ${cls.year} / ${cls.semester}`, margin, metaY+84);
    doc.text(`Venue: ${cls.venue}`, margin, metaY+98);
    doc.text(`Date/Time: ${formatDateTime(cls.dateTime)}`, margin, metaY+112);
    doc.text(`Lecturer: ${cls.lecturerName || ""}`, margin, metaY+126);
  } else {
    doc.text(`Venue/Platform: ${cls.venue}`, margin, metaY+56);
    doc.text(`Date/Time: ${formatDateTime(cls.dateTime)}`, margin, metaY+70);
    doc.text(`Organizer: ${cls.lecturerName || ""}`, margin, metaY+84);
  }

  const startY = cls.type==="meeting" ? (metaY + 105) : (metaY + 150);

  const body = rows.map(r=>[
    r["#"], r.ID, r.Surname, r.Middle, r.First, "", r.Timestamp
  ]);

  doc.autoTable({
    startY,
    head: [["#","ID","Surname","Middle","First","Signature","Timestamp"]],
    body,
    styles:{ fontSize: 8, cellPadding: 3, minCellHeight: 22 },
    headStyles:{ fillColor:[0,82,204], textColor:255 },
    columnStyles: { 5: { cellWidth: 90 } },
    didDrawCell: (data)=>{
      if(data.section === "body" && data.column.index === 5){
        const rowIndex = data.row.index;
        const sig = (rows[rowIndex] && rows[rowIndex].SignatureDataURL) ? rows[rowIndex].SignatureDataURL : "";
        if(sig && sig.startsWith("data:image")){
          try{
            const x = data.cell.x + 2;
            const y = data.cell.y + 2;
            const w = Math.min(86, data.cell.width - 4);
            const h = Math.min(18, data.cell.height - 4);
            doc.addImage(sig, "PNG", x, y, w, h);
          }catch(e){}
        }
      }
    }
  });

  let y = doc.lastAutoTable.finalY + 24;
  doc.setFontSize(10);
  doc.setTextColor(31,41,55);
  doc.text("Lecturer Signature:", margin, y);
  if(cls.lecturerSignature){
    try{ doc.addImage(cls.lecturerSignature, "PNG", margin, y+8, 160, 55); } catch(e){}
  }
  doc.text(`Lecturer: ${cls.lecturerName || ""}`, margin+180, y+24);

  y += 85;
  doc.text("HOD Signature:", margin, y);
  if(cls.hodSignature){
    try{ doc.addImage(cls.hodSignature, "PNG", margin, y+8, 160, 55); } catch(e){}
  }
  doc.text(`HOD: ${cls.hodName || ""}`, margin+180, y+24);

  doc.setFontSize(9);
  doc.setTextColor(100,116,139);
  doc.text("System created by Gerotech — Dan Otieno.", margin, doc.internal.pageSize.getHeight()-18);

  doc.save(`jooust-session-attendance-${(cls.unitCode||cls.unit||"session").replace(/\s+/g,"_")}.pdf`);
}

async function exportClassAttendanceWord(cls, rows){
  const dateStr = new Date().toLocaleString();
  const logoHtml = jooustLogoDataUrl
    ? `<img src="${jooustLogoDataUrl}" style="height:58px;border-radius:10px;" />`
    : `<div style="font-weight:800;color:#003b8c;">JOOUST</div>`;

  const bodyRows = rows.map(r=>{
    const sig = r.SignatureDataURL ? `<img src="${r.SignatureDataURL}" style="height:32px;border:1px solid #ddd;border-radius:8px;" />` : "";
    return `
      <tr>
        <td>${r["#"]}</td>
        <td>${escapeHtml(r.ID)}</td>
        <td>${escapeHtml(r.Surname)}</td>
        <td>${escapeHtml(r.Middle)}</td>
        <td>${escapeHtml(r.First)}</td>
        <td>${sig}</td>
        <td>${escapeHtml(r.Timestamp)}</td>
      </tr>
    `;
  }).join("");

  const lecSig = cls.lecturerSignature ? `<img src="${cls.lecturerSignature}" style="height:70px;border:1px solid #ddd;border-radius:10px;" />` : `<i>Not provided</i>`;
  const hodSig = cls.hodSignature ? `<img src="${cls.hodSignature}" style="height:70px;border:1px solid #ddd;border-radius:10px;" />` : `<i>Not provided</i>`;

  const metaBlock = cls.type==="meeting"
    ? `
      <tr><td><b>Type:</b> STAFF MEETING (${escapeHtml((cls.meetingMode||"").toUpperCase())})</td><td><b>Academic Year:</b> ${escapeHtml(cls.academicYear || "")}</td></tr>
      <tr><td><b>Venue/Platform:</b> ${escapeHtml(cls.venue)}</td><td><b>Date/Time:</b> ${escapeHtml(formatDateTime(cls.dateTime))}</td></tr>
      <tr><td colspan="2"><b>Organizer:</b> ${escapeHtml(cls.lecturerName || "")}</td></tr>
    `
    : `
      <tr><td><b>Academic Year:</b> ${escapeHtml(cls.academicYear || "")}</td><td><b>Unit Code:</b> ${escapeHtml(cls.unitCode || "")}</td></tr>
      <tr><td><b>Unit Name:</b> ${escapeHtml(cls.unit)}</td><td><b>Course:</b> ${escapeHtml(cls.course)}</td></tr>
      <tr><td><b>Faculty:</b> ${escapeHtml(cls.faculty)}</td><td><b>Study Year/Sem:</b> ${escapeHtml(cls.year)} / ${escapeHtml(cls.semester)}</td></tr>
      <tr><td><b>Venue:</b> ${escapeHtml(cls.venue)}</td><td><b>Date/Time:</b> ${escapeHtml(formatDateTime(cls.dateTime))}</td></tr>
      <tr><td colspan="2"><b>Lecturer:</b> ${escapeHtml(cls.lecturerName || "")}</td></tr>
    `;

  const html = `
  <html><head><meta charset="UTF-8"></head>
  <body style="font-family:Calibri,Arial,sans-serif;">
    <div style="display:flex;gap:16px;align-items:center;">
      ${logoHtml}
      <div>
        <h2 style="margin:0;color:#0052cc;">Jaramogi Oginga Odinga University of Science & Technology</h2>
        <div style="margin:0;font-size:12px;color:#555;">Session Attendance Sheet</div>
        <div style="margin:0;font-size:11px;color:#777;">Generated: ${escapeHtml(dateStr)}</div>
      </div>
    </div>
    <hr/>

    <table border="0" cellspacing="0" cellpadding="4" style="width:100%;font-size:11px;">
      ${metaBlock}
    </table>

    <br/>

    <table border="1" cellspacing="0" cellpadding="5" style="border-collapse:collapse;width:100%;font-size:11px;">
      <thead>
        <tr style="background:#eff6ff;color:#1d4ed8;font-weight:700;">
          <th>#</th><th>ID</th><th>Surname</th><th>Middle</th><th>First</th><th>Signature</th><th>Timestamp</th>
        </tr>
      </thead>
      <tbody>
        ${bodyRows || "<tr><td colspan='7'>No attendance.</td></tr>"}
      </tbody>
    </table>

    <br/>
    <table border="0" cellspacing="0" cellpadding="6" style="width:100%;font-size:11px;">
      <tr>
        <td style="width:50%;vertical-align:top;">
          <b>Lecturer Signature</b><br/>${lecSig}<br/>
          <b>Lecturer:</b> ${escapeHtml(cls.lecturerName || "")}
        </td>
        <td style="width:50%;vertical-align:top;">
          <b>HOD Signature</b><br/>${hodSig}<br/>
          <b>HOD:</b> ${escapeHtml(cls.hodName || "")}
        </td>
      </tr>
    </table>

    <p style="margin-top:14px;font-size:11px;color:#555;">
      System created by <b>Gerotech</b> — <b>Dan Otieno</b>.
    </p>
  </body></html>`;

  const blob = new Blob(["\ufeff", html], { type:"application/msword" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `jooust-session-attendance-${(cls.unitCode||cls.unit||"session").replace(/\s+/g,"_")}.doc`;
  a.click();
  URL.revokeObjectURL(url);
}

/* ===========================
   REPORTS
=========================== */
function filterClassesForReport({ ay, faculty, course, unit, year, semester, status, onlyLecturerId=null }){
  DATA = loadData();
  return DATA.classes.filter(c=>{
    if(onlyLecturerId && c.lecturerId !== onlyLecturerId) return false;
    if(ay && (c.academicYear||"") !== ay) return false;
    if(faculty && (c.faculty||"") !== faculty) return false;
    if(course && (c.course||"") !== course) return false;
    if(unit && (c.unit||"") !== unit) return false;
    if(year && (c.year||"") !== year) return false;
    if(semester && (c.semester||"") !== semester) return false;
    if(status && (c.status||"") !== status) return false;
    return true;
  }).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
}

function renderReportTable(tableElId, classes){
  const table = $(tableElId);
  if(!classes.length){
    table.innerHTML = `<thead><tr><th>No results</th></tr></thead><tbody><tr><td>No sessions match your filters.</td></tr></tbody>`;
    return;
  }

  const d = loadData();
  const counts = new Map();
  d.attendance.forEach(a => counts.set(a.classId, (counts.get(a.classId)||0)+1));

  let head = `<thead><tr>
    <th>#</th><th>Type</th><th>Academic Year</th><th>Unit Code</th><th>Unit/Meeting</th><th>Lecturer</th><th>Venue</th><th>Date/Time</th><th>Status</th><th>Attendance</th>
  </tr></thead>`;

  let body = "<tbody>";
  classes.forEach((c,i)=>{
    const count = counts.get(c.id) || 0;
    body += `<tr>
      <td>${i+1}</td>
      <td>${c.type==="meeting" ? `MEETING (${escapeHtml(c.meetingMode||"")})` : "CLASS"}</td>
      <td>${escapeHtml(c.academicYear||"")}</td>
      <td>${escapeHtml(c.unitCode||"")}</td>
      <td><b>${escapeHtml(c.unit||"")}</b></td>
      <td>${escapeHtml(c.lecturerName||"")}</td>
      <td>${escapeHtml(c.venue||"")}</td>
      <td>${escapeHtml(formatDateTime(c.dateTime))}</td>
      <td><span class="badge ${c.status}">${escapeHtml((c.status||"").toUpperCase())}</span></td>
      <td><b>${count}</b></td>
    </tr>`;
  });
  body += "</tbody>";
  table.innerHTML = head + body;
}

let lastReport = { classes: [], scope:"admin" };

$("generateReportBtn").addEventListener("click", ()=>{
  const filters = {
    ay: $("repAcademicYear").value,
    faculty: $("repFaculty").value,
    course: $("repCourse").value,
    unit: $("repUnit").value,
    year: $("repYear").value,
    semester: $("repSemester").value,
    status: $("repStatus").value
  };
  const classes = filterClassesForReport(filters);
  lastReport = { classes, scope:"admin" };

  $("reportArea").classList.remove("hidden");
  $("reportMeta").textContent = `Matched sessions: ${classes.length}`;
  renderReportTable("reportTable", classes);
});

$("generateReportLecturerBtn").addEventListener("click", ()=>{
  const filters = {
    ay: $("repAcademicYearL").value,
    faculty: $("repFacultyL").value,
    course: $("repCourseL").value,
    unit: $("repUnitL").value,
    year: $("repYearL").value,
    semester: $("repSemesterL").value,
    status: $("repStatusL").value
  };
  const classes = filterClassesForReport(filters);
  const mine = classes.filter(c=>c.lecturerId===currentUser?.id);
  lastReport = { classes: mine, scope:"lecturer" };

  $("reportAreaLecturer").classList.remove("hidden");
  $("reportMetaL").textContent = `Matched my sessions: ${mine.length}`;
  renderReportTable("reportTableL", mine);
});

// Export report list (sessions list)
function exportReportExcel(classes, filename){
  if(!window.XLSX){
    alert("Excel library not loaded.");
    return;
  }
  const d = loadData();
  const counts = new Map();
  d.attendance.forEach(a => counts.set(a.classId, (counts.get(a.classId)||0)+1));

  const rows = classes.map((c,i)=>({
    "#": i+1,
    Type: c.type==="meeting" ? `MEETING (${c.meetingMode||""})` : "CLASS",
    AcademicYear: c.academicYear||"",
    UnitCode: c.unitCode||"",
    UnitName: c.unit||"",
    Lecturer: c.lecturerName||"",
    Venue: c.venue||"",
    DateTime: formatDateTime(c.dateTime),
    Status: (c.status||"").toUpperCase(),
    AttendanceCount: counts.get(c.id)||0
  }));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), "Sessions");
  XLSX.writeFile(wb, filename);
}

function exportReportCsv(classes, filename){
  if(!classes.length){
    alert("No data.");
    return;
  }
  const d = loadData();
  const counts = new Map();
  d.attendance.forEach(a => counts.set(a.classId, (counts.get(a.classId)||0)+1));

  const rows = classes.map((c,i)=>[
    i+1,
    c.type==="meeting" ? `MEETING (${c.meetingMode||""})` : "CLASS",
    c.academicYear||"",
    c.unitCode||"",
    c.unit||"",
    c.lecturerName||"",
    c.venue||"",
    formatDateTime(c.dateTime),
    (c.status||"").toUpperCase(),
    counts.get(c.id)||0
  ]);
  const header = ["#","Type","AcademicYear","UnitCode","UnitName","Lecturer","Venue","DateTime","Status","AttendanceCount"];
  const csv = [header.join(","), ...rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(","))].join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

$("exportExcelBtn").addEventListener("click", ()=> exportReportExcel(lastReport.classes, "jooust-report-sessions.xlsx"));
$("exportExcelBtnL").addEventListener("click", ()=> exportReportExcel(lastReport.classes, "jooust-my-report-sessions.xlsx"));

$("exportPdfBtn").addEventListener("click", ()=>{
  exportReportCsv(lastReport.classes, "jooust-report-sessions.csv");
  alert("For the sessions-list report, CSV is generated quickly. For attendance sheet PDF, open a session then Download PDF.");
});
$("exportPdfBtnL").addEventListener("click", ()=>{
  exportReportCsv(lastReport.classes, "jooust-my-report-sessions.csv");
  alert("For the sessions-list report, CSV is generated quickly. For attendance sheet PDF, open a session then Download PDF.");
});
$("exportWordBtn").addEventListener("click", ()=>{
  exportReportCsv(lastReport.classes, "jooust-report-sessions.csv");
  alert("For sessions-list Word export, use CSV/Excel. Attendance sheet Word is available inside each session (View → Download Word).");
});
$("exportWordBtnL").addEventListener("click", ()=>{
  exportReportCsv(lastReport.classes, "jooust-my-report-sessions.csv");
  alert("For sessions-list Word export, use CSV/Excel. Attendance sheet Word is available inside each session (View → Download Word).");
});

// Download ALL Reports (Excel workbook)
$("downloadAllReportsBtn").addEventListener("click", ()=>{
  if(!window.XLSX){
    alert("Excel library not loaded.");
    return;
  }
  const filters = {
    ay: $("repAcademicYear").value,
    faculty: $("repFaculty").value,
    course: $("repCourse").value,
    unit: $("repUnit").value,
    year: $("repYear").value,
    semester: $("repSemester").value,
    status: $("repStatus").value
  };
  const classes = filterClassesForReport(filters);
  if(!classes.length){
    alert("No matching sessions to export.");
    return;
  }

  const wb = XLSX.utils.book_new();

  const d = loadData();
  const counts = new Map();
  d.attendance.forEach(a => counts.set(a.classId, (counts.get(a.classId)||0)+1));

  const summary = classes.map((c,i)=>({
    "#": i+1,
    Type: c.type==="meeting" ? `MEETING (${c.meetingMode||""})` : "CLASS",
    AcademicYear: c.academicYear||"",
    UnitCode: c.unitCode||"",
    UnitName: c.unit||"",
    Lecturer: c.lecturerName||"",
    Venue: c.venue||"",
    DateTime: formatDateTime(c.dateTime),
    Status: (c.status||"").toUpperCase(),
    AttendanceCount: counts.get(c.id)||0
  }));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summary), "Summary");

  classes.forEach((cls, idx)=>{
    const rows = buildAttendanceRowsForClass(cls.id);
    const sheetName = (`S${idx+1}_${(cls.unitCode||"").replace(/[^a-z0-9]/gi,"").slice(0,6)}_${(cls.type||"").slice(0,3)}`).slice(0,31);
    const wsData = [
      ["Type", (cls.type||"").toUpperCase()],
      ["MeetingMode", cls.type==="meeting" ? (cls.meetingMode||"") : ""],
      ["AcademicYear", cls.academicYear||""],
      ["UnitCode", cls.unitCode||""],
      ["UnitName", cls.unit||""],
      ["Course", cls.course||""],
      ["Faculty", cls.faculty||""],
      ["StudyYear", cls.year||""],
      ["Semester", cls.semester||""],
      ["Venue/Platform", cls.venue||""],
      ["DateTime", formatDateTime(cls.dateTime)],
      ["Lecturer", cls.lecturerName||""],
      ["Status", (cls.status||"").toUpperCase()],
      [""],
      ["#","ID","Surname","Middle","First","Timestamp","SignatureDataURL"]
    ];
    rows.forEach(r=>{
      wsData.push([r["#"], r.ID, r.Surname, r.Middle, r.First, r.Timestamp, r.SignatureDataURL]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), sheetName);
  });

  XLSX.writeFile(wb, "jooust-all-session-reports.xlsx");
});

/* ===========================
   ✅ STUDENT % REPORT + CHART
=========================== */
let studentChartInstance = null;

function toDateOnly(tsOrIso){
  const d = new Date(tsOrIso);
  if (isNaN(d)) return null;
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}

function withinRange(d, fromD, toD){
  if(!d) return false;
  const t = d.getTime();
  if(fromD && t < fromD.getTime()) return false;
  if(toD && t > toD.getTime()) return false;
  return true;
}

function weekKey(dateObj){
  const d = new Date(Date.UTC(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
  return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
}

function safePct(attended, total){
  if(!total) return 0;
  return Math.round((attended / total) * 1000) / 10; // 1 decimal
}

function buildStudentReportRows(classesInRange, attendanceRecords, idType, idValue){
  const attendedSet = new Set();
  attendanceRecords.forEach(a=>{
    if(idType==="admission" && (a.admission||"").trim()===idValue) attendedSet.add(a.classId);
    if(idType==="staffNo" && (a.staffNo||"").trim()===idValue) attendedSet.add(a.classId);
  });

  const rows = classesInRange
    .sort((a,b)=> new Date(a.dateTime) - new Date(b.dateTime))
    .map((cls, idx)=>({
      "#": idx+1,
      Type: cls.type==="meeting" ? `MEETING (${(cls.meetingMode||"").toUpperCase()})` : "CLASS",
      AcademicYear: cls.academicYear || "",
      UnitCode: cls.unitCode || "",
      UnitOrMeeting: cls.unit || "",
      Course: cls.course || "",
      Faculty: cls.faculty || "",
      Venue: cls.venue || "",
      DateTime: formatDateTime(cls.dateTime),
      Status: (cls.status||"").toUpperCase(),
      Attended: attendedSet.has(cls.id) ? "YES" : "NO"
    }));

  return { rows, attendedSet };
}

function renderStudentReportTable(rows){
  const table = $("studentReportTable");
  if(!rows.length){
    table.innerHTML = `<thead><tr><th>No results</th></tr></thead>
                       <tbody><tr><td>No sessions found in this period.</td></tr></tbody>`;
    return;
  }

  const head = `<thead><tr>
    <th>#</th><th>Type</th><th>AY</th><th>Code</th><th>Unit/Meeting</th><th>Venue</th><th>Date/Time</th><th>Status</th><th>Attended</th>
  </tr></thead>`;

  const body = `<tbody>` + rows.map(r=>`
    <tr>
      <td>${escapeHtml(r["#"])}</td>
      <td>${escapeHtml(r.Type)}</td>
      <td>${escapeHtml(r.AcademicYear)}</td>
      <td>${escapeHtml(r.UnitCode)}</td>
      <td><b>${escapeHtml(r.UnitOrMeeting)}</b></td>
      <td>${escapeHtml(r.Venue)}</td>
      <td>${escapeHtml(r.DateTime)}</td>
      <td>${escapeHtml(r.Status)}</td>
      <td><span class="chip ${r.Attended==="YES"?"green":"red"}">${escapeHtml(r.Attended)}</span></td>
    </tr>
  `).join("") + `</tbody>`;

  table.innerHTML = head + body;
}

function buildStudentChartData(classesInRange, attendedSet, grouping){
  const bucket = new Map();

  classesInRange.forEach(cls=>{
    const d = toDateOnly(cls.dateTime);
    if(!d) return;

    let key = "";
    if(grouping==="day") key = d.toISOString().slice(0,10);
    else if(grouping==="week") key = weekKey(d);
    else if(grouping==="unit") key = (cls.unitCode ? `${cls.unitCode} - ${cls.unit}` : (cls.unit||"UNKNOWN"));

    const cur = bucket.get(key) || { total:0, attended:0 };
    cur.total += 1;
    if(attendedSet.has(cls.id)) cur.attended += 1;
    bucket.set(key, cur);
  });

  let labels = Array.from(bucket.keys());
  if(grouping==="day"){
    labels.sort((a,b)=> new Date(a) - new Date(b));
  }else{
    labels.sort((a,b)=> a.localeCompare(b));
  }

  const attendedVals = labels.map(l=> bucket.get(l).attended);
  const totalVals = labels.map(l=> bucket.get(l).total);

  return { labels, attendedVals, totalVals };
}

function renderStudentChart(chartData, idLabel){
  const canvas = $("studentReportChart");
  if(!canvas) return;

  if(studentChartInstance){
    studentChartInstance.destroy();
    studentChartInstance = null;
  }

  if(!window.Chart){
    setAlert($("studentReportMsg"), "Chart.js not loaded. Ensure internet then refresh.", "danger");
    return;
  }

  studentChartInstance = new Chart(canvas, {
    type: "bar",
    data: {
      labels: chartData.labels,
      datasets: [
        { label: `Attended (${idLabel})`, data: chartData.attendedVals },
        { label: "Total Sessions", data: chartData.totalVals }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: true } },
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
    }
  });
}

$("generateStudentReportBtn")?.addEventListener("click", ()=>{
  const msgEl = $("studentReportMsg");
  clearAlert(msgEl);

  const idType = $("stuReportIdType").value;
  const idValue = $("stuReportId").value.trim();

  const fromVal = $("stuReportFrom").value;
  const toVal = $("stuReportTo").value;
  const grouping = $("stuReportGrouping").value;
  const statusFilter = $("stuReportOnlyOpenClosed").value;

  if(!idValue){
    setAlert(msgEl, "Enter Student/Staff ID first.", "danger");
    return;
  }

  const fromD = fromVal ? new Date(fromVal+"T00:00:00") : null;
  const toD = toVal ? new Date(toVal+"T23:59:59") : null;

  DATA = loadData();

  let sessions = DATA.classes.slice();
  sessions = (idType==="admission") ? sessions.filter(c=>c.type==="class") : sessions.filter(c=>c.type==="meeting");

  if(statusFilter){
    sessions = sessions.filter(c=>(c.status||"")===statusFilter);
  }

  const sessionsInRange = sessions.filter(c=>{
    const d = new Date(c.dateTime);
    if(isNaN(d)) return false;
    return withinRange(d, fromD, toD);
  });

  const attendanceRecords = DATA.attendance.filter(a=>{
    if(idType==="admission") return (a.admission||"").trim()===idValue;
    return (a.staffNo||"").trim()===idValue;
  });

  const { rows, attendedSet } = buildStudentReportRows(sessionsInRange, attendanceRecords, idType, idValue);

  const total = sessionsInRange.length;
  const attended = sessionsInRange.filter(s=>attendedSet.has(s.id)).length;
  const pct = safePct(attended, total);

  $("srTotalSessions").textContent = String(total);
  $("srAttendedSessions").textContent = String(attended);
  $("srPercent").textContent = `${pct}%`;

  $("studentReportArea").classList.remove("hidden");

  renderStudentReportTable(rows);

  const chartData = buildStudentChartData(sessionsInRange, attendedSet, grouping);
  renderStudentChart(chartData, `${idType}:${idValue}`);
});

/* ===========================
   Startup: student mode vs normal
=========================== */
(async ()=>{
  const inStudent = await loadStudentMode();
  if(inStudent) return;

  showSection("loginSection");
  refreshAllDropdowns();
  refreshClassPickers();
})();
</script>
</body>
</html>
