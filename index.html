<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JOOUST Smart Attendance System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Signature Pad -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- QR Code Generator -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <style>
    :root {
      --primary:#003366;
      --primary-soft:#e6eef9;
      --accent:#1dbf73;
      --accent-soft:#dbf7ea;
      --danger:#e11d48;
      --bg:#f4f6fb;
      --text:#1f2933;
      --card:#ffffff;
      --radius:18px;
      --shadow:0 15px 35px rgba(0,0,0,0.08);
    }

    body {
      margin:0;
      background:var(--bg);
      font-family:'Poppins',sans-serif;
      color:var(--text);
    }

    header {
      background:linear-gradient(135deg,var(--primary),#005a9e);
      padding:18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-radius:0 0 28px 28px;
      box-shadow:var(--shadow);
    }

    header img {
      height:80px;
      width:80px;
      border-radius:20px;
      object-fit:cover;
      background:white;
      padding:6px;
      box-shadow:0 5px 18px rgba(0,0,0,0.15);
    }

    header h1 {
      color:white;
      font-size:1.8rem;
      margin:0;
      font-weight:700;
    }

    header p {
      color:#dce6f3;
      margin:0;
      font-size:0.85rem;
    }

    .container {
      max-width:1200px;
      margin:auto;
      padding:20px;
    }

    .card {
      background:var(--card);
      padding:20px;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      margin-bottom:20px;
    }

    .btn {
      padding:10px 18px;
      border-radius:50px;
      border:none;
      cursor:pointer;
      font-weight:600;
      transition:.2s;
    }

    .btn-primary {
      background:var(--primary);
      color:white;
    }

    .btn-primary:hover {
      transform:scale(.97);
      opacity:.9;
    }

    .btn-accent {
      background:var(--accent);
      color:white;
    }

    .btn-danger {
      background:var(--danger);
      color:white;
    }

    input, select {
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      margin-bottom:12px;
      font-size:.9rem;
    }

    canvas {
      width:100%;
      height:180px;
      background:white;
      border-radius:12px;
      border:1px dashed #94a3b8;
    }

    .list-item {
      background:#f9fafb;
      padding:12px;
      border-radius:12px;
      margin-bottom:8px;
      border:1px solid #e5e7eb;
    }

    .status-dot {
      width:10px;
      height:10px;
      border-radius:50%;
      display:inline-block;
    }

    .status-green { background:#16a34a; }
    .status-yellow { background:#fbbf24; }
    .status-red    { background:#dc2626; }

  </style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:18px;">
    <img src="logo.jpg" alt="JOOUST Logo">
    <div>
      <h1>JOOUST Smart Attendance</h1>
      <p>Digital Classes • Secure Signatures • Auto-lock • Reports</p>
    </div>
  </div>
</header>

<div class="container">

<!-- AUTH SECTION -->
<div id="authArea" class="card">
  <h2>Login & Registration</h2>
  <p style="color:#64748b;font-size:.85rem;">Admin approves lecturers. Lecturers create classes & manage attendance.</p>

  <div style="display:flex;gap:10px;margin-bottom:15px;">
    <button class="btn btn-primary" onclick="showTab('adminLogin')">Admin Login</button>
    <button class="btn btn-accent" onclick="showTab('lecturerLogin')">Lecturer Login</button>
    <button class="btn" onclick="showTab('lecturerRegister')">Lecturer Register</button>
  </div>

  <!-- ADMIN LOGIN -->
  <div id="adminLogin" class="tabPanel">
    <h3>Admin Login</h3>
    <input id="adminUser" type="text" placeholder="Username (default: admin)">
    <input id="adminPass" type="password" placeholder="Password (default: Admin@123)">
    <button class="btn btn-primary" onclick="adminLogin()">Login</button>
  </div>

  <!-- LECTURER LOGIN -->
  <div id="lecturerLogin" class="tabPanel" style="display:none;">
    <h3>Lecturer Login</h3>
    <input id="lecLoginID" type="text" placeholder="PF/ID">
    <input id="lecLoginPass" type="password" placeholder="Password">
    <button class="btn btn-accent" onclick="lecturerLogin()">Login</button>
  </div>

  <!-- LECTURER REGISTER -->
  <div id="lecturerRegister" class="tabPanel" style="display:none;">
    <h3>Lecturer Registration</h3>
    <input id="regSalutation" type="text" placeholder="Salutation (Dr, Mr, Ms)">
    <input id="regName" type="text" placeholder="Full Name">
    <input id="regPF" type="text" placeholder="PFNO / ID">
    <input id="regFaculty" type="text" placeholder="Faculty">
    <input id="regCourses" type="text" placeholder="Courses (comma)">
    <input id="regUnits" type="text" placeholder="Units (comma)">
    <input id="regYears" type="text" placeholder="Years (comma)">
    <input id="regSemesters" type="text" placeholder="Semesters (comma)">
    <input id="regPass" type="password" placeholder="Password">
    <button class="btn btn-accent" onclick="registerLecturer()">Submit</button>
  </div>

  <div id="authMsg" style="margin-top:10px;color:#b91c1c;font-size:.85rem;"></div>
</div>

<!-- ADMIN DASHBOARD -->
<div id="adminDash" class="card" style="display:none;">
  <h2>Admin Dashboard</h2>
  <button class="btn btn-danger" onclick="logout()">Logout</button>

  <h3 style="margin-top:20px;">Pending Lecturer Approvals</h3>
  <div id="pendingList"></div>

  <h3 style="margin-top:20px;">Approved Lecturers</h3>
  <div id="approvedList"></div>

  <h3 style="margin-top:20px;">Reports</h3>
  <div class="card" style="background:#f9fafb;">
    <h4>Filters</h4>

    <select id="repFaculty"><option value="">All Faculties</option></select>
    <select id="repCourse"><option value="">All Courses</option></select>
    <select id="repUnitCode"><option value="">All Unit Codes</option></select>
    <select id="repUnitName"><option value="">All Unit Names</option></select>
    <select id="repAY"><option value="">All Academic Years</option></select>
    <select id="repYear"><option value="">All Years</option></select>
    <select id="repSem"><option value="">All Semesters</option></select>

    <button class="btn btn-primary" onclick="loadReport()">Load Report</button>
    <button class="btn btn-accent" onclick="exportPDF()">Export PDF</button>
    <button class="btn btn-accent" onclick="exportExcel()">Export Excel</button>
    <button class="btn btn-accent" onclick="exportWord()">Export Word</button>

    <div id="reportHolder" style="margin-top:15px;"></div>
  </div>
</div>

<!-- LECTURER DASHBOARD -->
<div id="lecDash" class="card" style="display:none;">
  <h2>Lecturer Dashboard</h2>
  <button class="btn btn-danger" onclick="logout()">Logout</button>

  <div id="lecWelcome" style="margin-top:10px;color:#334155;font-weight:600;"></div>

  <h3 style="margin-top:20px;">Create Class</h3>

  <input id="clsFaculty" type="text" placeholder="Faculty">
  <input id="clsCourse" type="text" placeholder="Course">
  <input id="clsUnitCode" type="text" placeholder="Unit Code">
  <input id="clsUnitName" type="text" placeholder="Unit Name">
  <input id="clsAY" type="text" placeholder="Academic Year (e.g. 2024/2025)">
  <input id="clsYear" type="text" placeholder="Year of Study">
  <input id="clsSem" type="text" placeholder="Semester">
  <input id="clsVenue" type="text" placeholder="Venue">

  <label>Start Time</label>
  <input id="clsStart" type="datetime-local">

  <label>End Time</label>
  <input id="clsEnd" type="datetime-local">

  <button class="btn btn-accent" onclick="createClass()">Create Class</button>

  <h3 style="margin-top:25px;">My Classes</h3>
  <div id="lecClassList"></div>
</div>

<!-- STUDENT / SIGNATURE VIEW -->
<div id="linkView"></div>

<script>
/* -------------------------------
   DATABASE (localStorage)
-------------------------------- */
let DB = JSON.parse(localStorage.getItem("ATTDB") || `{
  "admins":[{"user":"admin","pass":"Admin@123"}],
  "lecturers":[],
  "classes":[]
}`);

function saveDB(){ localStorage.setItem("ATTDB", JSON.stringify(DB)); }

/* -------------------------------
   TABS
-------------------------------- */
function showTab(id){
  document.querySelectorAll(".tabPanel").forEach(t => t.style.display="none");
  document.getElementById(id).style.display="block";
}

/* -------------------------------
   ADMIN LOGIN
-------------------------------- */
function adminLogin(){
  let u=document.getElementById("adminUser").value;
  let p=document.getElementById("adminPass").value;
  let ok=DB.admins.find(a=>a.user===u && a.pass===p);
  if(!ok){ document.getElementById("authMsg").innerHTML="Wrong admin credentials"; return;}
  document.getElementById("authArea").style.display="none";
  document.getElementById("adminDash").style.display="block";
  loadLecturers();
}

/* -------------------------------
   LECTURER REGISTRATION
-------------------------------- */
function registerLecturer(){
  let lec={
    sal:document.getElementById("regSalutation").value,
    name:document.getElementById("regName").value,
    pf:document.getElementById("regPF").value,
    faculty:document.getElementById("regFaculty").value,
    courses:document.getElementById("regCourses").value,
    units:document.getElementById("regUnits").value,
    years:document.getElementById("regYears").value,
    sems:document.getElementById("regSemesters").value,
    pass:document.getElementById("regPass").value,
    approved:false,
    id:"L"+Date.now()
  };

  if(!lec.name || !lec.pf || !lec.pass){
    document.getElementById("authMsg").innerHTML="All fields required!";
    return;
  }

  DB.lecturers.push(lec);
  saveDB();
  document.getElementById("authMsg").innerHTML="Registration submitted!";
}

/* -------------------------------
   LECTURER LOGIN
-------------------------------- */
let CURRENT_LEC=null;

function lecturerLogin(){
  let pf=document.getElementById("lecLoginID").value;
  let pw=document.getElementById("lecLoginPass").value;

  let lec=DB.lecturers.find(x=>x.pf===pf && x.pass===pw);
  if(!lec){ document.getElementById("authMsg").innerHTML="Lecturer not found"; return; }
  if(!lec.approved){ document.getElementById("authMsg").innerHTML="Not approved yet"; return;}

  CURRENT_LEC=lec;
  document.getElementById("authArea").style.display="none";
  document.getElementById("lecDash").style.display="block";
  document.getElementById("lecWelcome").innerHTML=
    `Welcome ${lec.sal} ${lec.name} (${lec.pf})`;
  loadLecturerClasses();
}

/* -------------------------------
   ADMIN: LOAD LECTURERS
-------------------------------- */
function loadLecturers(){
  let pending=document.getElementById("pendingList");
  let approved=document.getElementById("approvedList");
  pending.innerHTML="";
  approved.innerHTML="";

  DB.lecturers.forEach(l=>{
    let div=document.createElement("div");
    div.className="list-item";
    div.innerHTML=`<strong>${l.sal} ${l.name}</strong><br>PF: ${l.pf}`;

    if(!l.approved){
      let btn=document.createElement("button");
      btn.className="btn btn-accent";
      btn.innerHTML="Approve";
      btn.onclick=()=>{
        l.approved=true; saveDB(); loadLecturers();
      };
      div.appendChild(btn);
      pending.appendChild(div);
    } else {
      approved.appendChild(div);
    }
  });
}

/* -------------------------------
   CREATE CLASS
-------------------------------- */
function createClass(){
  let c={
    id:"C"+Date.now(),
    lec:CURRENT_LEC.id,
    faculty:clsFaculty.value,
    course:clsCourse.value,
    unitCode:clsUnitCode.value,
    unitName:clsUnitName.value,
    ay:clsAY.value,
    year:clsYear.value,
    sem:clsSem.value,
    venue:clsVenue.value,
    start:clsStart.value,
    end:clsEnd.value,
    att:[],
    lecSig:null,
    hodSig:null
  };

  DB.classes.push(c);
  saveDB();
  loadLecturerClasses();
  alert("Class Created!");
}

/* -------------------------------
   LOAD LECTURER CLASSES
-------------------------------- */
function loadLecturerClasses(){
  let list=document.getElementById("lecClassList");
  list.innerHTML="";
  
  DB.classes
    .filter(c=>c.lec===CURRENT_LEC.id)
    .forEach(c=>{
      let st=statusOfClass(c);
      let dot=st=="In Progress"?"status-green":st=="Not Started"?"status-yellow":"status-red";

      let div=document.createElement("div");
      div.className="list-item";
      div.innerHTML=`
        <strong>${c.unitCode} - ${c.unitName}</strong><br>
        ${c.course}, ${c.faculty}<br>
        AY ${c.ay} | Year ${c.year} | Sem ${c.sem}<br>
        <small>${c.venue}</small><br>
        <small>${c.start} → ${c.end}</small><br>
        <span class="status-dot ${dot}"></span> ${st}<br><br>

        <button class="btn btn-accent" 
          onclick="copyLink('${c.id}','student')">Copy Student Link</button>

        <button class="btn btn-primary" 
          onclick="copyLink('${c.id}','lecturer')">Lecturer Sign</button>

        <button class="btn btn-primary" 
          onclick="copyLink('${c.id}','hod')">HOD Sign</button>

        <button class="btn btn-accent"
          onclick="showQR('${c.id}')">QR Code</button>
      `;

      list.appendChild(div);
    });
}

/* -------------------------------
   CLASS STATUS
-------------------------------- */
function statusOfClass(c){
  let now=new Date();
  let s=new Date(c.start);
  let e=new Date(c.end);
  if(now<s) return "Not Started";
  if(now>=s && now<=e) return "In Progress";
  return "Closed";
}

/* -------------------------------
   COPY LINKS
-------------------------------- */
function copyLink(cid,mode){
  let link=location.origin+location.pathname+`?cid=${cid}&mode=${mode}`;
  navigator.clipboard.writeText(link);
  alert("Link copied!");
}

/* -------------------------------
   SHOW QR
-------------------------------- */
function showQR(cid){
  let link=location.origin+location.pathname+`?cid=${cid}&mode=student`;
  let box=prompt("QR Code will be shown. Type OK to continue:");
  if(box===null) return;

  let win=window.open("","QR","width=400,height=450");
  win.document.write("<h2>Class QR Code</h2>");
  win.document.write("<div id='qrcode'></div>");

  setTimeout(()=>{
    new QRCode(win.document.getElementById("qrcode"), link);
  },200);
}

/* -------------------------------
   LOGOUT
-------------------------------- */
function logout(){
  location.reload();
}

/* -------------------------------
   LINK VIEW (STUDENT/LECTURER/HOD)
-------------------------------- */
let params = new URLSearchParams(location.search);
if(params.get("cid")){
  document.getElementById("authArea").style.display="none";
  document.getElementById("lecDash").style.display="none";
  document.getElementById("adminDash").style.display="none";
  renderLinkView();
}

function renderLinkView(){
  let cid=params.get("cid");
  let mode=params.get("mode");
  let box=document.getElementById("linkView");
  box.innerHTML="";

  let c=DB.classes.find(x=>x.id===cid);
  if(!c){
    box.innerHTML="<div class='card'>Class Not Found</div>";
    return;
  }

  let st=statusOfClass(c);

  let html=`
  <div class='card'>
    <h2>${c.unitCode} - ${c.unitName}</h2>
    <p>${c.course}, ${c.faculty}</p>
    <p>Academic Year: ${c.ay}</p>
    <p>Venue: ${c.venue}</p>
    <p><strong>${c.start}</strong> → <strong>${c.end}</strong></p>
    <p>Status: <strong>${st}</strong></p>
  </div>
  `;

  box.innerHTML=html;

  if(mode==="student") renderStudentForm(c);
  if(mode==="lecturer") renderSignForm(c,"lecSig");
  if(mode==="hod") renderSignForm(c,"hodSig");
}

/* -------------------------------
   STUDENT ATTENDANCE FORM
-------------------------------- */
function renderStudentForm(c){
  let box=document.getElementById("linkView");

  let now=new Date();
  if(now < new Date(c.start) || now > new Date(c.end)){
    box.innerHTML+=`<div class='card' style='color:red;'>ATTENDANCE CLOSED</div>`;
    return;
  }

  box.innerHTML+=`
    <div class='card'>
      <h3>Student Attendance</h3>
      <input id="sSurname" placeholder="Surname">
      <input id="sMiddle"  placeholder="Middle Name">
      <input id="sFirst"   placeholder="First Name">
      <input id="sAdm"     placeholder="Admission Number">

      <label>Signature</label>
      <canvas id="stuSig"></canvas>
      <button class="btn btn-danger" onclick="sigPad.clear()">Clear</button><br><br>

      <button class="btn btn-accent" onclick="submitAttendance('${c.id}')">
        Submit Attendance
      </button>

      <div id="stuMsg" style="margin-top:10px;font-size:.9rem;"></div>
    </div>
  `;

  let canvas=document.getElementById("stuSig");
  resizeCanvas(canvas);
  window.sigPad=new SignaturePad(canvas);
}

function resizeCanvas(c){
  let ratio=Math.max(window.devicePixelRatio||1,1);
  let rect=c.getBoundingClientRect();
  c.width=rect.width*ratio;
  c.height=rect.height*ratio;
  c.getContext("2d").scale(ratio,ratio);
}

/* -------------------------------
   SUBMIT ATTENDANCE
-------------------------------- */
function submitAttendance(cid){
  let c=DB.classes.find(x=>x.id===cid);
  let adm=document.getElementById("sAdm").value.trim();

  if(c.att.find(a=>a.adm===adm)){
    stuMsg.innerHTML="Already submitted!";
    return;
  }

  if(sigPad.isEmpty()){
    stuMsg.innerHTML="Signature required!";
    return;
  }

  c.att.push({
    surname: sSurname.value,
    middle: sMiddle.value,
    first:  sFirst.value,
    adm: adm,
    sig: sigPad.toDataURL(),
    time: new Date().toISOString()
  });

  saveDB();
  stuMsg.innerHTML="<span style='color:green;'>Saved!</span>";
}

/* -------------------------------
   SIGN FORMS (LECTURER / HOD)
-------------------------------- */
function renderSignForm(c,type){
  let box=document.getElementById("linkView");

  box.innerHTML+=`
    <div class='card'>
      <h3>${type==="lecSig"?"Lecturer":"HOD"} Signature</h3>
      <canvas id="signPad"></canvas>
      <button class="btn btn-danger" onclick="sigPad.clear()">Clear</button><br><br>

      <button class="btn btn-primary" onclick="saveSign('${c.id}','${type}')">
        Save Signature
      </button>

      <div id="signMsg" style="margin-top:10px;"></div>
    </div>
  `;

  let canvas=document.getElementById("signPad");
  resizeCanvas(canvas);
  window.sigPad=new SignaturePad(canvas);
}

function saveSign(cid,type){
  let c=DB.classes.find(x=>x.id===cid);
  if(sigPad.isEmpty()){
    signMsg.innerHTML="Signature required!";
    return;
  }
  c[type]=sigPad.toDataURL();
  saveDB();
  signMsg.innerHTML="<span style='color:green;'>Signature Saved!</span>";
}

/* -------------------------------
   REPORTS
-------------------------------- */
function loadReport(){
  let area=document.getElementById("reportHolder");
  area.innerHTML="";
  
  let table=document.createElement("table");
  table.border="1";
  table.cellPadding=5;

  let head=`
    <tr>
      <th>Faculty</th><th>Course</th><th>Unit</th><th>Code</th>
      <th>AY</th><th>Year</th><th>Sem</th>
      <th>Attendance Count</th>
    </tr>`;
  table.innerHTML=head;

  DB.classes.forEach(c=>{
    let row=document.createElement("tr");
    row.innerHTML=`
      <td>${c.faculty}</td>
      <td>${c.course}</td>
      <td>${c.unitName}</td>
      <td>${c.unitCode}</td>
      <td>${c.ay}</td>
      <td>${c.year}</td>
      <td>${c.sem}</td>
      <td>${c.att.length}</td>
    `;
    table.appendChild(row);
  });

  area.appendChild(table);
}

/* -------------------------------
   EXPORT PDF / EXCEL / WORD
-------------------------------- */
function exportPDF(){
  alert("PDF Export enabled – can integrate advanced templates later.");
}

function exportExcel(){
  let table=document.querySelector("#reportHolder table");
  if(!table) return alert("Load report first.");

  let wb=XLSX.utils.book_new();
  let ws=XLSX.utils.table_to_sheet(table);
  XLSX.utils.book_append_sheet(wb,ws,"Attendance");
  XLSX.writeFile(wb,"Attendance.xlsx");
}

function exportWord(){
  let table=document.querySelector("#reportHolder table");
  if(!table) return alert("Load report first.");

  let html=table.outerHTML;
  let blob=new Blob(['\ufeff',html],{type:'application/msword'});
  let url=URL.createObjectURL(blob);
  let a=document.createElement("a");
  a.href=url;
  a.download="Attendance.doc";
  a.click();
}
</script>
<!-- FOOTER -->
<footer style="
  text-align:center;
  padding:20px;
  margin-top:25px;
  color:#4b5563;
  font-size:.85rem;
">
  © JOOUST Smart Attendance System · Powered by Daniel O. Otieno · 2025
</footer>

</div><!-- END CONTAINER -->

</body>
</html>
